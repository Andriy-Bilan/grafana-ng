import { Component } from '@angular/core';
import { TimeRangeParser } from 'common';
import { AggrFuncGroup, AggrFuncHelper, OrderByTime, GroupByOption, MetricVars } from './query.m';
import * as _ from 'lodash';
import { of } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "common";
export class InfluxMetricsBuilder {
    constructor(time) {
        this.time = time;
    }
    build(query, range) {
        //console.log( query );
        const array = [];
        query
            .targets
            .forEach(t => {
            // const modifiedRange = this
            // 	.timeManager
            // 	.getModifiedRange( this.widget.time )
            const gen = new Builder(this.time, t, range);
            if (!gen.invalid && !t.virgin) {
                array.push(gen.text);
            }
        });
        let request = array.join(';');
        return of(request);
    }
}
InfluxMetricsBuilder.ɵfac = function InfluxMetricsBuilder_Factory(t) { return new (t || InfluxMetricsBuilder)(i0.ɵɵdirectiveInject(i1.TimeRangeStore)); };
InfluxMetricsBuilder.ɵcmp = i0.ɵɵdefineComponent({ type: InfluxMetricsBuilder, selectors: [["metrics-builder"]], decls: 0, vars: 0, template: function InfluxMetricsBuilder_Template(rf, ctx) { }, encapsulation: 2 });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(InfluxMetricsBuilder, [{
        type: Component,
        args: [{
                selector: 'metrics-builder',
                template: ''
            }]
    }], function () { return [{ type: i1.TimeRangeStore }]; }, null); })();
class Builder {
    constructor(time, target, range) {
        this.time = time;
        this.target = target;
        this.range = range;
    }
    get invalid() {
        const invalidQuery = (!this.target) ||
            (!this.target.fields || 0 === this.target.fields.length);
        return invalidQuery;
    }
    get text() {
        return `SELECT ${this.getFieldsText()} FROM ${this.getMeasurementText()}`;
    }
    getFieldsText() {
        let result = '';
        if (!this.target.fields) {
            return result;
        }
        this.target.fields.forEach(x => {
            if (result.length > 0) {
                result += ', ';
            }
            result += this.getFieldText(x);
        });
        return result;
    }
    getFieldText(field) {
        let result = '';
        let key = (!field.key) ? 'field' : field.key;
        const aggr = field.functions.find(x => AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Aggregations ||
            AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Selectors);
        if (aggr) {
            result += aggr.name + ((aggr.param && aggr.param.value) ?
                `("${key}", ${aggr.param.value})` : `("${key}")`);
        }
        else {
            result = `"${key}"`;
        }
        const trans = field.functions.filter(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Transformations);
        trans.forEach(x => {
            const p = (x.param && x.param.value) ? `, ${x.param.value}` : ``;
            result = `${x.name}(${result}${p})`;
        });
        const math = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Math);
        if (math) {
            result = `${result} ${math.param.value}`;
        }
        const alias = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Alias);
        if (alias) {
            result = `${result} AS "${alias.param.value}"`;
        }
        return result;
    }
    getMeasurementText() {
        const meas = (!this.target.measurement) ? 'measurement' : this.target.measurement;
        let rp = (this.target.policy && this.target.policy.length > 0 && this.target.policy !== 'default') ?
            `"${this.target.policy}".` : '';
        let root = `${rp}"${meas}"`;
        let cond = '';
        let tagIndex = 0;
        if (this.target.tags) {
            this
                .target
                .tags
                .filter(x => x.key && x.value)
                .forEach(x => {
                if (tagIndex > 0) {
                    cond += ` ${x.condition} `;
                }
                cond += ` "${x.key}" ${x.operator} '${x.value}'`;
                ++tagIndex;
            });
        }
        const timeFilter = (this.range) ?
            this.getTimeFilter() : MetricVars.TIME_FILTER;
        if (cond.length > 0) {
            root = `${root} WHERE (${cond}) and ${timeFilter}`;
        }
        else {
            // TODO
            root = `${root} WHERE ${timeFilter}`;
        }
        const groupBy = this.target.groupBy;
        const groupByTime = groupBy.find(x => x.type == GroupByOption.Time);
        const groupByFill = groupBy.find(x => x.type == GroupByOption.Fill);
        const groupByTag = groupBy.filter(x => x.type == GroupByOption.Tag);
        if (groupByTime) {
            const gb = (this.range) ? this.getOptimalAutoGroupBy() : groupByTime.params[0];
            root = `${root} GROUP BY time(${gb})`;
        }
        if (groupByTag.length > 0) {
            root = (!groupByTime) ? `${root} GROUP BY` : `${root},`;
            groupByTag.forEach((e, index) => {
                root = `${root}${index > 0 ? ', ' : ' '} "${e.params[0]}"`;
            });
        }
        if (groupByFill) {
            root = `${root} FILL(${groupByFill.params[0]})`;
        }
        if (this.target.order != OrderByTime.Asc) {
            root = `${root} ORDER BY time DESC`;
        }
        if (this.target.limit > 0) {
            root = `${root} LIMIT ${this.target.limit}`;
        }
        if (this.target.slimit > 0) {
            root = `${root} SLIMIT ${this.target.slimit}`;
        }
        return root;
    }
    getOptimalAutoGroupBy() {
        const f = TimeRangeParser.toDateTime(this.range.from, false);
        const t = TimeRangeParser.toDateTime(this.range.to, true);
        if (5 > +t.diff(f, "minutes"))
            return "200ms";
        if (15 > +t.diff(f, "minutes"))
            return "1s";
        if (30 > t.diff(f, "minutes"))
            return "2s";
        if (1 > t.diff(f, "hours"))
            return "5s";
        if (3 > t.diff(f, "hours"))
            return "10s";
        if (6 > t.diff(f, "hours"))
            return "20s";
        if (12 > t.diff(f, "hours"))
            return "1m";
        if (24 > t.diff(f, "hours"))
            return "2m";
        if (7 > t.diff(f, "days"))
            return "10m";
        if (31 > t.diff(f, "days"))
            return "1h";
        if (365 > t.diff(f, "days"))
            return "12h";
        return "24h";
    }
    getTimeFilter() {
        const range = this.range;
        const tz = this.time.converter.timezone; //this.range.timezone;
        let from = this.getInfluxTime(range.from, false, tz);
        let to = this.getInfluxTime(range.to, true, tz);
        const fromIsAbsolute = from[from.length - 1] === 'ms';
        if (to === 'now()' && !fromIsAbsolute) {
            return 'time >= ' + from;
        }
        return 'time >= ' + from + ' and time <= ' + to;
    }
    getInfluxTime(date, roundUp, timezone) {
        if (_.isString(date)) {
            if (date === 'now') {
                return 'now()';
            }
            const parts = /^now-(\d+)([dhms])$/.exec(date);
            if (parts) {
                const amount = parseInt(parts[1], 10);
                const unit = parts[2];
                return 'now() - ' + amount + unit;
            }
            date = TimeRangeParser.toDateTime(date, roundUp, timezone);
        }
        return date.valueOf() + 'ms';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2FwcC9wbHVnaW5zL2RhdGFzb3VyY2VzL2luZmx1eC9zcmMvcXVlcnkvYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBYSxlQUFlLEVBQTRDLE1BQU0sUUFBUSxDQUFDO0FBQzlGLE9BQU8sRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUM5QixXQUFXLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNsRSxPQUFPLEtBQUssQ0FBQyxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7QUFNdEMsTUFBTSxPQUFPLG9CQUFvQjtJQUVoQyxZQUFxQixJQUFvQjtRQUFwQixTQUFJLEdBQUosSUFBSSxDQUFnQjtJQUV6QyxDQUFDO0lBRUQsS0FBSyxDQUFFLEtBQVUsRUFBRSxLQUFpQjtRQUNuQyx1QkFBdUI7UUFFdkIsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBRWpCLEtBQUs7YUFDSCxPQUFPO2FBQ1AsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ1osNkJBQTZCO1lBQzdCLGdCQUFnQjtZQUNoQix5Q0FBeUM7WUFFekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFFLENBQUM7WUFFL0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFO2dCQUM5QixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNyQjtRQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxH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UyxDQUFFO1lBQy9CLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsU0FBUyxDQUFFO1lBQzlCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDO1FBRWQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDO1FBRWQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzVCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzVCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsTUFBTSxDQUFFO1lBQzFCLE9BQU8sS0FBSyxDQUFDO1FBRWQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsTUFBTSxDQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsTUFBTSxDQUFFO1lBQzVCLE9BQU8sS0FBSyxDQUFDO1FBRWIsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUEsYUFBYTtRQUNYLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDekIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsc0JBQXNCO1FBRS9ELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUUsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDdEQsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBRSxLQUFLLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUM7UUFFdEQsSUFBSSxFQUFFLEtBQUssT0FBTyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3JDLE9BQU8sVUFBVSxHQUFHLElBQUksQ0FBQztTQUMxQjtRQUVELE9BQU8sVUFBVSxHQUFHLElBQUksR0FBRyxlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQ25ELENBQUM7SUFFQSxhQUFhLENBQUMsSUFBUyxFQUFFLE9BQVksRUFBRSxRQUFrQjtRQUN2RCxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDcEIsSUFBSSxJQUFJLEtBQUssS0FBSyxFQUFFO2dCQUNsQixPQUFPLE9BQU8sQ0FBQzthQUNoQjtZQUVELE1BQU0sS0FBSyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUvQyxJQUFJLEtBQUssRUFBRTtnQkFDVCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUN0QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLE9BQU8sVUFBVSxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUM7YUFDbkM7WUFFRCxJQUFJLEdBQUcsZUFBZSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQzVEO1FBRUQsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQy9CLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGltZVJhbmdlLCBUaW1lUmFuZ2VQYXJzZXIsIFRpbWVSYW5nZVN0b3JlLCBUaW1lem9uZSwgTWV0cmljc0J1aWxkZXIgfSBmcm9tICdjb21tb24nO1xuaW1wb3J0IHsgQWdnckZ1bmNHcm91cCwgQWdnckZ1bmNIZWxwZXIsXG5cdEZpZWxkLCBPcmRlckJ5VGltZSwgR3JvdXBCeU9wdGlvbiwgTWV0cmljVmFycyB9IGZyb20gJy4vcXVlcnkubSc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuXG5AQ29tcG9uZW50KHtcblx0c2VsZWN0b3I6ICdtZXRyaWNzLWJ1aWxkZXInLFxuXHR0ZW1wbGF0ZTogJydcbn0pXG5leHBvcnQgY2xhc3MgSW5mbHV4TWV0cmljc0J1aWxkZXIgaW1wbGVtZW50cyBNZXRyaWNzQnVpbGRlciB7XG5cblx0Y29uc3RydWN0b3IoIHByaXZhdGUgdGltZTogVGltZVJhbmdlU3RvcmUgKXtcblx0XHRcblx0fVxuXG5cdGJ1aWxkKCBxdWVyeTogYW55LCByYW5nZT86IFRpbWVSYW5nZSApIDogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcblx0XHQvL2NvbnNvbGUubG9nKCBxdWVyeSApO1xuXG5cdFx0Y29uc3QgYXJyYXkgPSBbXTtcblxuXHRcdHF1ZXJ5XG5cdFx0XHQudGFyZ2V0c1xuXHRcdFx0LmZvckVhY2godCA9PiB7XG5cdFx0XHRcdC8vIGNvbnN0IG1vZGlmaWVkUmFuZ2UgPSB0aGlzXG5cdFx0XHRcdC8vIFx0LnRpbWVNYW5hZ2VyXG5cdFx0XHRcdC8vIFx0LmdldE1vZGlmaWVkUmFuZ2UoIHRoaXMud2lkZ2V0LnRpbWUgKVxuXG5cdFx0XHRcdGNvbnN0IGdlbiA9IG5ldyBCdWlsZGVyKCB0aGlzLnRpbWUsIHQsIHJhbmdlICk7XG5cblx0XHRcdFx0aWYgKCFnZW4uaW52YWxpZCAmJiAhdC52aXJnaW4pIHtcblx0XHRcdFx0XHRhcnJheS5wdXNoKGdlbi50ZXh0KTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cblx0XHRsZXQgcmVxdWVzdCA9IGFycmF5LmpvaW4oJzsnKTtcblxuXHRcdHJldHVybiBvZiggcmVxdWVzdCApO1xuXHR9XG59XG5cbmNsYXNzIEJ1aWxkZXJ7XG5cdGdldCBpbnZhbGlkKCl7XG4gICAgY29uc3QgaW52YWxpZFF1ZXJ5ID0gXG4gICAgICAoIXRoaXMudGFyZ2V0KSB8fFxuICAgICAgKCF0aGlzLnRhcmdldC5maWVsZHMgfHwgMCA9PT0gdGhpcy50YXJnZXQuZmllbGRzLmxlbmd0aCApO1xuXG4gICAgcmV0dXJuIGludmFsaWRRdWVyeTtcblx0fVxuXHRcblx0Z2V0IHRleHQoKSB7XG4gICAgcmV0dXJuIGBTRUxFQ1QgJHt0aGlzLmdldEZpZWxkc1RleHQoKX0gRlJPTSAke3RoaXMuZ2V0TWVhc3VyZW1lbnRUZXh0KCl9YFxuICB9XG5cblx0Y29uc3RydWN0b3IoIFxuXHRcdHByaXZhdGUgdGltZTogVGltZVJhbmdlU3RvcmUsXG5cdFx0cHJpdmF0ZSB0YXJnZXQ6IGFueSxcblx0XHRwcml2YXRlIHJhbmdlPzogVGltZVJhbmdlICl7XG5cblx0fVxuXG5cdGdldEZpZWxkc1RleHQoKSB7XG5cdFx0bGV0IHJlc3VsdCA9ICcnO1xuXHRcdFxuICAgIGlmICghdGhpcy50YXJnZXQuZmllbGRzKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHRoaXMudGFyZ2V0LmZpZWxkcy5mb3JFYWNoKHggPT4ge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlc3VsdCArPSAnLCAnO1xuICAgICAgfVxuXG4gICAgICByZXN1bHQgKz0gdGhpcy5nZXRGaWVsZFRleHQoIHggKTtcbiAgICB9KVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcblx0fVxuXHRcblx0XG4gIGdldEZpZWxkVGV4dChmaWVsZDogRmllbGQpIHtcblx0XHQgbGV0IHJlc3VsdCA9ICcnO1xuICAgIGxldCBrZXkgPSAoIWZpZWxkLmtleSkgPyAnZmllbGQnIDogZmllbGQua2V5O1xuXG4gICAgY29uc3QgYWdnciA9IGZpZWxkLmZ1bmN0aW9ucy5maW5kKHggPT5cbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT0gQWdnckZ1bmNHcm91cC5BZ2dyZWdhdGlvbnMgfHxcbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT0gQWdnckZ1bmNHcm91cC5TZWxlY3RvcnMpO1xuXG4gICAgaWYgKGFnZ3IpIHtcbiAgICAgIHJlc3VsdCArPSBhZ2dyLm5hbWUgKyAoKGFnZ3IucGFyYW0gJiYgYWdnci5wYXJhbS52YWx1ZSkgP1xuICAgICAgICBgKFwiJHtrZXl9XCIsICR7YWdnci5wYXJhbS52YWx1ZX0pYCA6IGAoXCIke2tleX1cIilgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0ID0gYFwiJHtrZXl9XCJgO1xuICAgIH1cblxuICAgIGNvbnN0IHRyYW5zID0gZmllbGQuZnVuY3Rpb25zLmZpbHRlcih4ID0+XG4gICAgICBBZ2dyRnVuY0hlbHBlci5nZXRHcm91cCh4Lm5hbWUpID09PSBBZ2dyRnVuY0dyb3VwLlRyYW5zZm9ybWF0aW9ucyk7XG5cbiAgICB0cmFucy5mb3JFYWNoKHggPT4ge1xuICAgICAgY29uc3QgcCA9ICh4LnBhcmFtICYmIHgucGFyYW0udmFsdWUpID8gYCwgJHt4LnBhcmFtLnZhbHVlfWAgOiBgYDtcbiAgICAgIHJlc3VsdCA9IGAke3gubmFtZX0oJHtyZXN1bHR9JHtwfSlgO1xuICAgIH0pXG5cbiAgICBjb25zdCBtYXRoID0gZmllbGQuZnVuY3Rpb25zLmZpbmQoeCA9PlxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PT0gQWdnckZ1bmNHcm91cC5NYXRoKTtcblxuICAgIGlmIChtYXRoKSB7XG4gICAgICByZXN1bHQgPSBgJHtyZXN1bHR9ICR7bWF0aC5wYXJhbS52YWx1ZX1gO1xuICAgIH1cblxuICAgIGNvbnN0IGFsaWFzID0gZmllbGQuZnVuY3Rpb25zLmZpbmQoeCA9PlxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PT0gQWdnckZ1bmNHcm91cC5BbGlhcyk7XG5cbiAgICBpZiAoYWxpYXMpIHtcbiAgICAgIHJlc3VsdCA9IGAke3Jlc3VsdH0gQVMgXCIke2FsaWFzLnBhcmFtLnZhbHVlfVwiYDtcbiAgICB9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cdFxuICBnZXRNZWFzdXJlbWVudFRleHQoKSB7XG4gICAgY29uc3QgbWVhcyA9ICghdGhpcy50YXJnZXQubWVhc3VyZW1lbnQpID8gJ21lYXN1cmVtZW50JyA6IHRoaXMudGFyZ2V0Lm1lYXN1cmVtZW50O1xuXG4gICAgbGV0IHJwID0gKHRoaXMudGFyZ2V0LnBvbGljeSAmJiB0aGlzLnRhcmdldC5wb2xpY3kubGVuZ3RoID4gMCAmJiB0aGlzLnRhcmdldC5wb2xpY3kgIT09ICdkZWZhdWx0JykgP1xuICAgICAgYFwiJHt0aGlzLnRhcmdldC5wb2xpY3l9XCIuYCA6ICcnO1xuXG4gICAgbGV0IHJvb3QgPSBgJHtycH1cIiR7bWVhc31cImA7XG4gICAgbGV0IGNvbmQgPSAnJztcblxuICAgIGxldCB0YWdJbmRleCA9IDA7XG5cbiAgICBpZiAodGhpcy50YXJnZXQudGFncykge1xuICAgICAgdGhpc1xuICAgICAgICAudGFyZ2V0XG4gICAgICAgIC50YWdzXG4gICAgICAgIC5maWx0ZXIoeCA9PiB4LmtleSAmJiB4LnZhbHVlKVxuICAgICAgICAuZm9yRWFjaCh4ID0+IHtcbiAgICAgICAgICBpZiAodGFnSW5kZXggPiAwKSB7XG4gICAgICAgICAgICBjb25kICs9IGAgJHt4LmNvbmRpdGlvbn0gYDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25kICs9IGAgXCIke3gua2V5fVwiICR7eC5vcGVyYXRvcn0gJyR7eC52YWx1ZX0nYDtcbiAgICAgICAgICArK3RhZ0luZGV4O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB0aW1lRmlsdGVyID0gKCB0aGlzLnJhbmdlICkgP1xuICAgICAgdGhpcy5nZXRUaW1lRmlsdGVyKCkgOiBNZXRyaWNWYXJzLlRJTUVfRklMVEVSO1xuXG4gICAgaWYgKGNvbmQubGVuZ3RoID4gMCkge1xuICAgICAgcm9vdCA9IGAke3Jvb3R9IFdIRVJFICgke2NvbmR9KSBhbmQgJHt0aW1lRmlsdGVyfWBcbiAgICB9XG4gICAgZWxzZXtcbiAgICAgIC8vIFRPRE9cbiAgICAgIHJvb3QgPSBgJHtyb290fSBXSEVSRSAke3RpbWVGaWx0ZXJ9YFxuXHRcdH1cblxuXHRcdGNvbnN0IGdyb3VwQnkgPSB0aGlzLnRhcmdldC5ncm91cEJ5O1xuXHRcdGNvbnN0IGdyb3VwQnlUaW1lID0gZ3JvdXBCeS5maW5kKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLlRpbWUgKTtcblx0XHRjb25zdCBncm91cEJ5RmlsbCA9IGdyb3VwQnkuZmluZCggeCA9PiB4LnR5cGUgPT0gR3JvdXBCeU9wdGlvbi5GaWxsICk7XG5cdFx0Y29uc3QgZ3JvdXBCeVRhZyA9IGdyb3VwQnkuZmlsdGVyKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLlRhZyApO1xuXG5cdFx0aWYoIGdyb3VwQnlUaW1lICl7XG4gICAgICBjb25zdCBnYiA9ICggdGhpcy5yYW5nZSApID8gdGhpcy5nZXRPcHRpbWFsQXV0b0dyb3VwQnkoKSA6IGdyb3VwQnlUaW1lLnBhcmFtc1sgMCBdO1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IEdST1VQIEJZIHRpbWUoJHtnYn0pYFxuXHRcdH1cblxuXHRcdGlmKCBncm91cEJ5VGFnLmxlbmd0aCA+IDAgKXtcblx0XHRcdHJvb3QgPSAoICFncm91cEJ5VGltZSApID8gYCR7cm9vdH0gR1JPVVAgQllgIDogYCR7cm9vdH0sYDsgXG5cblx0XHRcdGdyb3VwQnlUYWcuZm9yRWFjaCggKGUsaW5kZXgpID0+IHtcblx0XHRcdFx0cm9vdCA9IGAke3Jvb3R9JHtpbmRleCA+MCA/ICcsICcgOiAnICd9IFwiJHtlLnBhcmFtc1sgMCBdfVwiYFxuXHRcdFx0fSApXG5cdFx0fVxuXHRcdFxuXHRcdGlmKCBncm91cEJ5RmlsbCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IEZJTEwoJHtncm91cEJ5RmlsbC5wYXJhbXNbIDAgXX0pYFxuXHRcdH1cblxuXHRcdGlmKCB0aGlzLnRhcmdldC5vcmRlciAhPSBPcmRlckJ5VGltZS5Bc2MgKXtcblx0XHRcdHJvb3QgPSBgJHtyb290fSBPUkRFUiBCWSB0aW1lIERFU0NgOyBcblx0XHR9XG5cdFx0XG5cdFx0aWYoIHRoaXMudGFyZ2V0LmxpbWl0ID4gMCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IExJTUlUICR7dGhpcy50YXJnZXQubGltaXR9YDtcblx0XHR9XG5cblx0XHRpZiggdGhpcy50YXJnZXQuc2xpbWl0ID4gMCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IFNMSU1JVCAke3RoaXMudGFyZ2V0LnNsaW1pdH1gO1xuXHRcdH1cblxuICAgIHJldHVybiByb290O1xuXHR9XG5cdFxuICBnZXRPcHRpbWFsQXV0b0dyb3VwQnkoKSA6IHN0cmluZyB7XG4gICAgY29uc3QgZiA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKCB0aGlzLnJhbmdlLmZyb20sIGZhbHNlICk7XG4gICAgY29uc3QgdCA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKCB0aGlzLnJhbmdlLnRvLCB0cnVlICk7XG5cblx0XHRpZiAoNSA+ICt0LmRpZmYoIGYsIFwibWludXRlc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyMDBtc1wiO1xuXG5cdFx0aWYgKDE1ID4gK3QuZGlmZiggZiwgXCJtaW51dGVzXCIgKSlcblx0XHRcdHJldHVybiBcIjFzXCI7XG5cblx0XHRpZiAoMzAgPiB0LmRpZmYoIGYsIFwibWludXRlc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyc1wiO1xuXG5cdFx0aWYgKDEgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiNXNcIjtcdFx0XG5cblx0XHRpZiAoMyA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIxMHNcIjtcdFx0XG5cblx0XHRpZiAoNiA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyMHNcIjtcdFx0XG5cblx0XHRpZiAoMTIgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMW1cIjtcdFx0XG5cblx0XHRpZiAoMjQgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMm1cIjtcdFx0XG5cblx0XHRpZiAoNyA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjEwbVwiO1x0XHRcblxuXHRcdGlmICgzMSA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjFoXCI7XHRcdFxuXG5cdFx0aWYgKDM2NSA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjEyaFwiO1x0XHRcblxuXHRcdCByZXR1cm4gXCIyNGhcIjtcblx0fVxuXG4gIGdldFRpbWVGaWx0ZXIoKSB7XG4gICAgY29uc3QgcmFuZ2UgPSB0aGlzLnJhbmdlO1xuICAgIGNvbnN0IHR6ID0gdGhpcy50aW1lLmNvbnZlcnRlci50aW1lem9uZTsgLy90aGlzLnJhbmdlLnRpbWV6b25lO1xuXG4gICAgbGV0IGZyb20gPSB0aGlzLmdldEluZmx1eFRpbWUoIHJhbmdlLmZyb20sIGZhbHNlLCB0eik7XG4gICAgbGV0IHRvID0gdGhpcy5nZXRJbmZsdXhUaW1lKCByYW5nZS50bywgdHJ1ZSwgdHopO1xuXG4gICAgY29uc3QgZnJvbUlzQWJzb2x1dGUgPSBmcm9tW2Zyb20ubGVuZ3RoIC0gMV0gPT09ICdtcyc7XG5cbiAgICBpZiAodG8gPT09ICdub3coKScgJiYgIWZyb21Jc0Fic29sdXRlKSB7XG4gICAgICByZXR1cm4gJ3RpbWUgPj0gJyArIGZyb207XG4gICAgfVxuXG4gICAgcmV0dXJuICd0aW1lID49ICcgKyBmcm9tICsgJyBhbmQgdGltZSA8PSAnICsgdG87XG5cdH1cblx0XG4gIGdldEluZmx1eFRpbWUoZGF0ZTogYW55LCByb3VuZFVwOiBhbnksIHRpbWV6b25lOiBUaW1lem9uZSkge1xuICAgIGlmIChfLmlzU3RyaW5nKGRhdGUpKSB7XG4gICAgICBpZiAoZGF0ZSA9PT0gJ25vdycpIHtcbiAgICAgICAgcmV0dXJuICdub3coKSc7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBhcnRzID0gL15ub3ctKFxcZCspKFtkaG1zXSkkLy5leGVjKGRhdGUpO1xuXG4gICAgICBpZiAocGFydHMpIHtcbiAgICAgICAgY29uc3QgYW1vdW50ID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTtcbiAgICAgICAgY29uc3QgdW5pdCA9IHBhcnRzWzJdO1xuICAgICAgICByZXR1cm4gJ25vdygpIC0gJyArIGFtb3VudCArIHVuaXQ7XG4gICAgICB9XG5cbiAgICAgIGRhdGUgPSBUaW1lUmFuZ2VQYXJzZXIudG9EYXRlVGltZShkYXRlLCByb3VuZFVwLCB0aW1lem9uZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGUudmFsdWVPZigpICsgJ21zJztcbiAgfVxufSJdfQ==