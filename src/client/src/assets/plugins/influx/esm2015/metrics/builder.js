import { Component } from '@angular/core';
import { TimeRangeParser } from 'common';
import { AggrFuncGroup, AggrFuncHelper, OrderByTime, GroupByOption, MetricVars } from './metrics.m';
import * as _ from 'lodash';
import { of } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "common";
export class InfluxMetricsBuilder {
    constructor(time = undefined /* for timezone */) {
        this.time = time;
    }
    build(metrics, range) {
        const array = [];
        metrics
            .targets
            .forEach(t => {
            const gen = new Builder(this.time, t, range);
            if (!gen.invalid && !t.virgin) {
                array.push(gen.text);
            }
        });
        let request = array.join(';');
        return of(request);
    }
}
InfluxMetricsBuilder.ɵfac = function InfluxMetricsBuilder_Factory(t) { return new (t || InfluxMetricsBuilder)(i0.ɵɵdirectiveInject(i1.TimeRangeStore)); };
InfluxMetricsBuilder.ɵcmp = i0.ɵɵdefineComponent({ type: InfluxMetricsBuilder, selectors: [["metrics-builder"]], decls: 0, vars: 0, template: function InfluxMetricsBuilder_Template(rf, ctx) { }, encapsulation: 2 });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(InfluxMetricsBuilder, [{
        type: Component,
        args: [{
                selector: 'metrics-builder',
                template: ''
            }]
    }], function () { return [{ type: i1.TimeRangeStore }]; }, null); })();
class Builder {
    constructor(time, target, range) {
        this.time = time;
        this.target = target;
        this.range = range;
    }
    get invalid() {
        const invalidQuery = (!this.target) ||
            (!this.target.fields || 0 === this.target.fields.length);
        return invalidQuery;
    }
    get text() {
        return `SELECT ${this.getFieldsText()} FROM ${this.getMeasurementText()}`;
    }
    getFieldsText() {
        let result = '';
        if (!this.target.fields) {
            return result;
        }
        this.target.fields.forEach(x => {
            if (result.length > 0) {
                result += ', ';
            }
            result += this.getFieldText(x);
        });
        return result;
    }
    getFieldText(field) {
        let result = '';
        let key = (!field.key) ? 'field' : field.key;
        const aggr = field.functions.find(x => AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Aggregations ||
            AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Selectors);
        if (aggr) {
            result += aggr.name + ((aggr.param && aggr.param.value) ?
                `("${key}", ${aggr.param.value})` : `("${key}")`);
        }
        else {
            result = `"${key}"`;
        }
        const trans = field.functions.filter(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Transformations);
        trans.forEach(x => {
            const p = (x.param && x.param.value) ? `, ${x.param.value}` : ``;
            result = `${x.name}(${result}${p})`;
        });
        const math = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Math);
        if (math) {
            result = `${result} ${math.param.value}`;
        }
        const alias = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Alias);
        if (alias) {
            result = `${result} AS "${alias.param.value}"`;
        }
        return result;
    }
    getMeasurementText() {
        const meas = (!this.target.measurement) ? 'measurement' : this.target.measurement;
        let rp = (this.target.policy && this.target.policy.length > 0 && this.target.policy !== 'default') ?
            `"${this.target.policy}".` : '';
        let root = `${rp}"${meas}"`;
        let cond = '';
        let tagIndex = 0;
        if (this.target.tags) {
            this
                .target
                .tags
                .filter(x => x.key && x.value)
                .forEach(x => {
                if (tagIndex > 0) {
                    cond += ` ${x.condition} `;
                }
                cond += ` "${x.key}" ${x.operator} '${x.value}'`;
                ++tagIndex;
            });
        }
        const timeFilter = (this.range) ?
            this.getTimeFilter() : MetricVars.TIME_FILTER;
        if (cond.length > 0) {
            root = `${root} WHERE (${cond}) and ${timeFilter}`;
        }
        else {
            // TODO
            root = `${root} WHERE ${timeFilter}`;
        }
        const groupBy = this.target.groupBy;
        const groupByTime = groupBy.find(x => x.type == GroupByOption.Time);
        const groupByFill = groupBy.find(x => x.type == GroupByOption.Fill);
        const groupByTag = groupBy.filter(x => x.type == GroupByOption.Tag);
        if (groupByTime) {
            const gb = (this.range) ? this.getOptimalAutoGroupBy() : groupByTime.params[0];
            root = `${root} GROUP BY time(${gb})`;
        }
        if (groupByTag.length > 0) {
            root = (!groupByTime) ? `${root} GROUP BY` : `${root},`;
            groupByTag.forEach((e, index) => {
                root = `${root}${index > 0 ? ', ' : ' '} "${e.params[0]}"`;
            });
        }
        if (groupByFill) {
            root = `${root} FILL(${groupByFill.params[0]})`;
        }
        if (this.target.order != OrderByTime.Asc) {
            root = `${root} ORDER BY time DESC`;
        }
        if (this.target.limit > 0) {
            root = `${root} LIMIT ${this.target.limit}`;
        }
        if (this.target.slimit > 0) {
            root = `${root} SLIMIT ${this.target.slimit}`;
        }
        return root;
    }
    getOptimalAutoGroupBy() {
        const f = TimeRangeParser.toDateTime(this.range.from, false);
        const t = TimeRangeParser.toDateTime(this.range.to, true);
        if (5 > +t.diff(f, "minutes"))
            return "200ms";
        if (15 > +t.diff(f, "minutes"))
            return "1s";
        if (30 > t.diff(f, "minutes"))
            return "2s";
        if (1 > t.diff(f, "hours"))
            return "5s";
        if (3 > t.diff(f, "hours"))
            return "10s";
        if (6 > t.diff(f, "hours"))
            return "20s";
        if (12 > t.diff(f, "hours"))
            return "1m";
        if (24 > t.diff(f, "hours"))
            return "2m";
        if (7 > t.diff(f, "days"))
            return "10m";
        if (31 > t.diff(f, "days"))
            return "1h";
        if (365 > t.diff(f, "days"))
            return "12h";
        return "24h";
    }
    getTimeFilter() {
        const range = this.range;
        const tz = this.time.converter.timezone; //this.range.timezone;
        let from = this.getInfluxTime(range.from, false, tz);
        let to = this.getInfluxTime(range.to, true, tz);
        const fromIsAbsolute = from[from.length - 1] === 'ms';
        if (to === 'now()' && !fromIsAbsolute) {
            return 'time >= ' + from;
        }
        return 'time >= ' + from + ' and time <= ' + to;
    }
    getInfluxTime(date, roundUp, timezone) {
        if (_.isString(date)) {
            if (date === 'now') {
                return 'now()';
            }
            const parts = /^now-(\d+)([dhms])$/.exec(date);
            if (parts) {
                const amount = parseInt(parts[1], 10);
                const unit = parts[2];
                return 'now() - ' + amount + unit;
            }
            date = TimeRangeParser.toDateTime(date, roundUp, timezone);
        }
        return date.valueOf() + 'ms';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2FwcC9wbHVnaW5zL2RhdGFzb3VyY2VzL2luZmx1eC9zcmMvbWV0cmljcy9idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFhLGVBQWUsRUFDZSxNQUFNLFFBQVEsQ0FBQztBQUNqRSxPQUFPLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFDOUIsV0FBVyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEUsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7O0FBTXRDLE1BQU0sT0FBTyxvQkFBb0I7SUFFaEMsWUFBcUIsT0FBdUIsU0FBUyxDQUFBLGtCQUFrQjtRQUFsRCxTQUFJLEdBQUosSUFBSSxDQUE0QjtJQUVwRCxDQUFDO0lBRUYsS0FBSyxDQUFFLE9BQWdCLEVBQUUsS0FBaUI7UUFDekMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBRWpCLE9BQU87YUFDTCxPQUFPO2FBQ1AsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ1osTUFBTSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFFLENBQUM7WUFFL0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBTyxDQUFFLENBQUMsTUFBTSxFQUFFO2dCQUNyQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNyQjtRQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU5QixPQUFPLEVBQUUsQ0FB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SUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsU0FBUyxDQUFFO1lBQzlCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDO1FBRWQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzNCLE9BQU8sS0FBSyxDQUFDO1FBRWQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzVCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsT0FBTyxDQUFFO1lBQzVCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsTUFBTSxDQUFFO1lBQzFCLE9BQU8sS0FBSyxDQUFDO1FBRWQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsTUFBTSxDQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDO1FBRWIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxDQUFDLEVBQUUsTUFBTSxDQUFFO1lBQzVCLE9BQU8sS0FBSyxDQUFDO1FBRWIsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUEsYUFBYTtRQUNYLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDekIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsc0JBQXNCO1FBRS9ELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUUsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDdEQsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBRSxLQUFLLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUM7UUFFdEQsSUFBSSxFQUFFLEtBQUssT0FBTyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3JDLE9BQU8sVUFBVSxHQUFHLElBQUksQ0FBQztTQUMxQjtRQUVELE9BQU8sVUFBVSxHQUFHLElBQUksR0FBRyxlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQ25ELENBQUM7SUFFQSxhQUFhLENBQUMsSUFBUyxFQUFFLE9BQVksRUFBRSxRQUFrQjtRQUN2RCxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDcEIsSUFBSSxJQUFJLEtBQUssS0FBSyxFQUFFO2dCQUNsQixPQUFPLE9BQU8sQ0FBQzthQUNoQjtZQUVELE1BQU0sS0FBSyxHQUFHLHFCQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUvQyxJQUFJLEtBQUssRUFBRTtnQkFDVCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUN0QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3RCLE9BQU8sVUFBVSxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUM7YUFDbkM7WUFFRCxJQUFJLEdBQUcsZUFBZSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQzVEO1FBRUQsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDO0lBQy9CLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGltZVJhbmdlLCBUaW1lUmFuZ2VQYXJzZXIsIFRpbWVSYW5nZVN0b3JlLFxuICBUaW1lem9uZSwgTWV0cmljc0J1aWxkZXIsIE1ldHJpY3MsIE1ldHJpY1F1ZXJ5IH0gZnJvbSAnY29tbW9uJztcbmltcG9ydCB7IEFnZ3JGdW5jR3JvdXAsIEFnZ3JGdW5jSGVscGVyLFxuXHRGaWVsZCwgT3JkZXJCeVRpbWUsIEdyb3VwQnlPcHRpb24sIE1ldHJpY1ZhcnMgfSBmcm9tICcuL21ldHJpY3MubSc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuXG5AQ29tcG9uZW50KHtcblx0c2VsZWN0b3I6ICdtZXRyaWNzLWJ1aWxkZXInLFxuXHR0ZW1wbGF0ZTogJydcbn0pXG5leHBvcnQgY2xhc3MgSW5mbHV4TWV0cmljc0J1aWxkZXIgaW1wbGVtZW50cyBNZXRyaWNzQnVpbGRlciB7XG5cblx0Y29uc3RydWN0b3IoIHByaXZhdGUgdGltZTogVGltZVJhbmdlU3RvcmUgPSB1bmRlZmluZWQvKiBmb3IgdGltZXpvbmUgKi8gKXtcblx0XHRcbiAgfVxuXG5cdGJ1aWxkKCBtZXRyaWNzOiBNZXRyaWNzLCByYW5nZT86IFRpbWVSYW5nZSApIDogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcblx0XHRjb25zdCBhcnJheSA9IFtdO1xuXG5cdFx0bWV0cmljc1xuXHRcdFx0LnRhcmdldHNcblx0XHRcdC5mb3JFYWNoKHQgPT4ge1xuXHRcdFx0XHRjb25zdCBnZW4gPSBuZXcgQnVpbGRlciggdGhpcy50aW1lLCB0LCByYW5nZSApO1xuXG5cdFx0XHRcdGlmICghZ2VuLmludmFsaWQgJiYgISg8YW55PnQpLnZpcmdpbikge1xuXHRcdFx0XHRcdGFycmF5LnB1c2goZ2VuLnRleHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdGxldCByZXF1ZXN0ID0gYXJyYXkuam9pbignOycpO1xuXG5cdFx0cmV0dXJuIG9mKCByZXF1ZXN0ICk7XG5cdH1cbn1cblxuY2xhc3MgQnVpbGRlcntcblx0Z2V0IGludmFsaWQoKXtcbiAgICBjb25zdCBpbnZhbGlkUXVlcnkgPSBcbiAgICAgICghdGhpcy50YXJnZXQpIHx8XG4gICAgICAoIXRoaXMudGFyZ2V0LmZpZWxkcyB8fCAwID09PSB0aGlzLnRhcmdldC5maWVsZHMubGVuZ3RoICk7XG5cbiAgICByZXR1cm4gaW52YWxpZFF1ZXJ5O1xuXHR9XG5cdFxuXHRnZXQgdGV4dCgpIHtcbiAgICByZXR1cm4gYFNFTEVDVCAke3RoaXMuZ2V0RmllbGRzVGV4dCgpfSBGUk9NICR7dGhpcy5nZXRNZWFzdXJlbWVudFRleHQoKX1gXG4gIH1cblxuXHRjb25zdHJ1Y3RvciggXG5cdFx0cHJpdmF0ZSB0aW1lOiBUaW1lUmFuZ2VTdG9yZSxcblx0XHRwcml2YXRlIHRhcmdldDogYW55LFxuXHRcdHByaXZhdGUgcmFuZ2U/OiBUaW1lUmFuZ2UgKXtcblxuXHR9XG5cblx0Z2V0RmllbGRzVGV4dCgpIHtcblx0XHRsZXQgcmVzdWx0ID0gJyc7XG5cdFx0XG4gICAgaWYgKCF0aGlzLnRhcmdldC5maWVsZHMpIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgdGhpcy50YXJnZXQuZmllbGRzLmZvckVhY2goeCA9PiB7XG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmVzdWx0ICs9ICcsICc7XG4gICAgICB9XG5cbiAgICAgIHJlc3VsdCArPSB0aGlzLmdldEZpZWxkVGV4dCggeCApO1xuICAgIH0pXG5cbiAgICByZXR1cm4gcmVzdWx0O1xuXHR9XG5cdFxuXHRcbiAgZ2V0RmllbGRUZXh0KGZpZWxkOiBGaWVsZCkge1xuXHRcdCBsZXQgcmVzdWx0ID0gJyc7XG4gICAgbGV0IGtleSA9ICghZmllbGQua2V5KSA/ICdmaWVsZCcgOiBmaWVsZC5rZXk7XG5cbiAgICBjb25zdCBhZ2dyID0gZmllbGQuZnVuY3Rpb25zLmZpbmQoeCA9PlxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PSBBZ2dyRnVuY0dyb3VwLkFnZ3JlZ2F0aW9ucyB8fFxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PSBBZ2dyRnVuY0dyb3VwLlNlbGVjdG9ycyk7XG5cbiAgICBpZiAoYWdncikge1xuICAgICAgcmVzdWx0ICs9IGFnZ3IubmFtZSArICgoYWdnci5wYXJhbSAmJiBhZ2dyLnBhcmFtLnZhbHVlKSA/XG4gICAgICAgIGAoXCIke2tleX1cIiwgJHthZ2dyLnBhcmFtLnZhbHVlfSlgIDogYChcIiR7a2V5fVwiKWApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBgXCIke2tleX1cImA7XG4gICAgfVxuXG4gICAgY29uc3QgdHJhbnMgPSBmaWVsZC5mdW5jdGlvbnMuZmlsdGVyKHggPT5cbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT09IEFnZ3JGdW5jR3JvdXAuVHJhbnNmb3JtYXRpb25zKTtcblxuICAgIHRyYW5zLmZvckVhY2goeCA9PiB7XG4gICAgICBjb25zdCBwID0gKHgucGFyYW0gJiYgeC5wYXJhbS52YWx1ZSkgPyBgLCAke3gucGFyYW0udmFsdWV9YCA6IGBgO1xuICAgICAgcmVzdWx0ID0gYCR7eC5uYW1lfSgke3Jlc3VsdH0ke3B9KWA7XG4gICAgfSlcblxuICAgIGNvbnN0IG1hdGggPSBmaWVsZC5mdW5jdGlvbnMuZmluZCh4ID0+XG4gICAgICBBZ2dyRnVuY0hlbHBlci5nZXRHcm91cCh4Lm5hbWUpID09PSBBZ2dyRnVuY0dyb3VwLk1hdGgpO1xuXG4gICAgaWYgKG1hdGgpIHtcbiAgICAgIHJlc3VsdCA9IGAke3Jlc3VsdH0gJHttYXRoLnBhcmFtLnZhbHVlfWA7XG4gICAgfVxuXG4gICAgY29uc3QgYWxpYXMgPSBmaWVsZC5mdW5jdGlvbnMuZmluZCh4ID0+XG4gICAgICBBZ2dyRnVuY0hlbHBlci5nZXRHcm91cCh4Lm5hbWUpID09PSBBZ2dyRnVuY0dyb3VwLkFsaWFzKTtcblxuICAgIGlmIChhbGlhcykge1xuICAgICAgcmVzdWx0ID0gYCR7cmVzdWx0fSBBUyBcIiR7YWxpYXMucGFyYW0udmFsdWV9XCJgO1xuICAgIH1cblxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblx0XG4gIGdldE1lYXN1cmVtZW50VGV4dCgpIHtcbiAgICBjb25zdCBtZWFzID0gKCF0aGlzLnRhcmdldC5tZWFzdXJlbWVudCkgPyAnbWVhc3VyZW1lbnQnIDogdGhpcy50YXJnZXQubWVhc3VyZW1lbnQ7XG5cbiAgICBsZXQgcnAgPSAodGhpcy50YXJnZXQucG9saWN5ICYmIHRoaXMudGFyZ2V0LnBvbGljeS5sZW5ndGggPiAwICYmIHRoaXMudGFyZ2V0LnBvbGljeSAhPT0gJ2RlZmF1bHQnKSA/XG4gICAgICBgXCIke3RoaXMudGFyZ2V0LnBvbGljeX1cIi5gIDogJyc7XG5cbiAgICBsZXQgcm9vdCA9IGAke3JwfVwiJHttZWFzfVwiYDtcbiAgICBsZXQgY29uZCA9ICcnO1xuXG4gICAgbGV0IHRhZ0luZGV4ID0gMDtcblxuICAgIGlmICh0aGlzLnRhcmdldC50YWdzKSB7XG4gICAgICB0aGlzXG4gICAgICAgIC50YXJnZXRcbiAgICAgICAgLnRhZ3NcbiAgICAgICAgLmZpbHRlcih4ID0+IHgua2V5ICYmIHgudmFsdWUpXG4gICAgICAgIC5mb3JFYWNoKHggPT4ge1xuICAgICAgICAgIGlmICh0YWdJbmRleCA+IDApIHtcbiAgICAgICAgICAgIGNvbmQgKz0gYCAke3guY29uZGl0aW9ufSBgO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbmQgKz0gYCBcIiR7eC5rZXl9XCIgJHt4Lm9wZXJhdG9yfSAnJHt4LnZhbHVlfSdgO1xuICAgICAgICAgICsrdGFnSW5kZXg7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHRpbWVGaWx0ZXIgPSAoIHRoaXMucmFuZ2UgKSA/XG4gICAgICB0aGlzLmdldFRpbWVGaWx0ZXIoKSA6IE1ldHJpY1ZhcnMuVElNRV9GSUxURVI7XG5cbiAgICBpZiAoY29uZC5sZW5ndGggPiAwKSB7XG4gICAgICByb290ID0gYCR7cm9vdH0gV0hFUkUgKCR7Y29uZH0pIGFuZCAke3RpbWVGaWx0ZXJ9YFxuICAgIH1cbiAgICBlbHNle1xuICAgICAgLy8gVE9ET1xuICAgICAgcm9vdCA9IGAke3Jvb3R9IFdIRVJFICR7dGltZUZpbHRlcn1gXG5cdFx0fVxuXG5cdFx0Y29uc3QgZ3JvdXBCeSA9IHRoaXMudGFyZ2V0Lmdyb3VwQnk7XG5cdFx0Y29uc3QgZ3JvdXBCeVRpbWUgPSBncm91cEJ5LmZpbmQoIHggPT4geC50eXBlID09IEdyb3VwQnlPcHRpb24uVGltZSApO1xuXHRcdGNvbnN0IGdyb3VwQnlGaWxsID0gZ3JvdXBCeS5maW5kKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLkZpbGwgKTtcblx0XHRjb25zdCBncm91cEJ5VGFnID0gZ3JvdXBCeS5maWx0ZXIoIHggPT4geC50eXBlID09IEdyb3VwQnlPcHRpb24uVGFnICk7XG5cblx0XHRpZiggZ3JvdXBCeVRpbWUgKXtcbiAgICAgIGNvbnN0IGdiID0gKCB0aGlzLnJhbmdlICkgPyB0aGlzLmdldE9wdGltYWxBdXRvR3JvdXBCeSgpIDogZ3JvdXBCeVRpbWUucGFyYW1zWyAwIF07XG5cdFx0XHRyb290ID0gYCR7cm9vdH0gR1JPVVAgQlkgdGltZSgke2difSlgXG5cdFx0fVxuXG5cdFx0aWYoIGdyb3VwQnlUYWcubGVuZ3RoID4gMCApe1xuXHRcdFx0cm9vdCA9ICggIWdyb3VwQnlUaW1lICkgPyBgJHtyb290fSBHUk9VUCBCWWAgOiBgJHtyb290fSxgOyBcblxuXHRcdFx0Z3JvdXBCeVRhZy5mb3JFYWNoKCAoZSxpbmRleCkgPT4ge1xuXHRcdFx0XHRyb290ID0gYCR7cm9vdH0ke2luZGV4ID4wID8gJywgJyA6ICcgJ30gXCIke2UucGFyYW1zWyAwIF19XCJgXG5cdFx0XHR9IClcblx0XHR9XG5cdFx0XG5cdFx0aWYoIGdyb3VwQnlGaWxsICl7XG5cdFx0XHRyb290ID0gYCR7cm9vdH0gRklMTCgke2dyb3VwQnlGaWxsLnBhcmFtc1sgMCBdfSlgXG5cdFx0fVxuXG5cdFx0aWYoIHRoaXMudGFyZ2V0Lm9yZGVyICE9IE9yZGVyQnlUaW1lLkFzYyApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IE9SREVSIEJZIHRpbWUgREVTQ2A7IFxuXHRcdH1cblx0XHRcblx0XHRpZiggdGhpcy50YXJnZXQubGltaXQgPiAwICl7XG5cdFx0XHRyb290ID0gYCR7cm9vdH0gTElNSVQgJHt0aGlzLnRhcmdldC5saW1pdH1gO1xuXHRcdH1cblxuXHRcdGlmKCB0aGlzLnRhcmdldC5zbGltaXQgPiAwICl7XG5cdFx0XHRyb290ID0gYCR7cm9vdH0gU0xJTUlUICR7dGhpcy50YXJnZXQuc2xpbWl0fWA7XG5cdFx0fVxuXG4gICAgcmV0dXJuIHJvb3Q7XG5cdH1cblx0XG4gIGdldE9wdGltYWxBdXRvR3JvdXBCeSgpIDogc3RyaW5nIHtcbiAgICBjb25zdCBmID0gVGltZVJhbmdlUGFyc2VyLnRvRGF0ZVRpbWUoIHRoaXMucmFuZ2UuZnJvbSwgZmFsc2UgKTtcbiAgICBjb25zdCB0ID0gVGltZVJhbmdlUGFyc2VyLnRvRGF0ZVRpbWUoIHRoaXMucmFuZ2UudG8sIHRydWUgKTtcblxuXHRcdGlmICg1ID4gK3QuZGlmZiggZiwgXCJtaW51dGVzXCIgKSlcblx0XHRcdHJldHVybiBcIjIwMG1zXCI7XG5cblx0XHRpZiAoMTUgPiArdC5kaWZmKCBmLCBcIm1pbnV0ZXNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMXNcIjtcblxuXHRcdGlmICgzMCA+IHQuZGlmZiggZiwgXCJtaW51dGVzXCIgKSlcblx0XHRcdHJldHVybiBcIjJzXCI7XG5cblx0XHRpZiAoMSA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCI1c1wiO1x0XHRcblxuXHRcdGlmICgzID4gdC5kaWZmKCBmLCBcImhvdXJzXCIgKSlcblx0XHRcdHJldHVybiBcIjEwc1wiO1x0XHRcblxuXHRcdGlmICg2ID4gdC5kaWZmKCBmLCBcImhvdXJzXCIgKSlcblx0XHRcdHJldHVybiBcIjIwc1wiO1x0XHRcblxuXHRcdGlmICgxMiA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIxbVwiO1x0XHRcblxuXHRcdGlmICgyNCA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIybVwiO1x0XHRcblxuXHRcdGlmICg3ID4gdC5kaWZmKCBmLCBcImRheXNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMTBtXCI7XHRcdFxuXG5cdFx0aWYgKDMxID4gdC5kaWZmKCBmLCBcImRheXNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMWhcIjtcdFx0XG5cblx0XHRpZiAoMzY1ID4gdC5kaWZmKCBmLCBcImRheXNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMTJoXCI7XHRcdFxuXG5cdFx0IHJldHVybiBcIjI0aFwiO1xuXHR9XG5cbiAgZ2V0VGltZUZpbHRlcigpIHtcbiAgICBjb25zdCByYW5nZSA9IHRoaXMucmFuZ2U7XG4gICAgY29uc3QgdHogPSB0aGlzLnRpbWUuY29udmVydGVyLnRpbWV6b25lOyAvL3RoaXMucmFuZ2UudGltZXpvbmU7XG5cbiAgICBsZXQgZnJvbSA9IHRoaXMuZ2V0SW5mbHV4VGltZSggcmFuZ2UuZnJvbSwgZmFsc2UsIHR6KTtcbiAgICBsZXQgdG8gPSB0aGlzLmdldEluZmx1eFRpbWUoIHJhbmdlLnRvLCB0cnVlLCB0eik7XG5cbiAgICBjb25zdCBmcm9tSXNBYnNvbHV0ZSA9IGZyb21bZnJvbS5sZW5ndGggLSAxXSA9PT0gJ21zJztcblxuICAgIGlmICh0byA9PT0gJ25vdygpJyAmJiAhZnJvbUlzQWJzb2x1dGUpIHtcbiAgICAgIHJldHVybiAndGltZSA+PSAnICsgZnJvbTtcbiAgICB9XG5cbiAgICByZXR1cm4gJ3RpbWUgPj0gJyArIGZyb20gKyAnIGFuZCB0aW1lIDw9ICcgKyB0bztcblx0fVxuXHRcbiAgZ2V0SW5mbHV4VGltZShkYXRlOiBhbnksIHJvdW5kVXA6IGFueSwgdGltZXpvbmU6IFRpbWV6b25lKSB7XG4gICAgaWYgKF8uaXNTdHJpbmcoZGF0ZSkpIHtcbiAgICAgIGlmIChkYXRlID09PSAnbm93Jykge1xuICAgICAgICByZXR1cm4gJ25vdygpJztcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGFydHMgPSAvXm5vdy0oXFxkKykoW2RobXNdKSQvLmV4ZWMoZGF0ZSk7XG5cbiAgICAgIGlmIChwYXJ0cykge1xuICAgICAgICBjb25zdCBhbW91bnQgPSBwYXJzZUludChwYXJ0c1sxXSwgMTApO1xuICAgICAgICBjb25zdCB1bml0ID0gcGFydHNbMl07XG4gICAgICAgIHJldHVybiAnbm93KCkgLSAnICsgYW1vdW50ICsgdW5pdDtcbiAgICAgIH1cblxuICAgICAgZGF0ZSA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKGRhdGUsIHJvdW5kVXAsIHRpbWV6b25lKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGF0ZS52YWx1ZU9mKCkgKyAnbXMnO1xuICB9XG59Il19