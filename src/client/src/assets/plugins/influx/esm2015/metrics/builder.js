import { Component } from '@angular/core';
import { TimeRangeParser } from 'common';
import { AggrFuncGroup, AggrFuncHelper, OrderByTime, GroupByOption, MetricVars } from './metrics.m';
import * as _ from 'lodash';
import { of } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "common";
export class InfluxMetricsBuilder {
    constructor(time = undefined /* for timezone */) {
        this.time = time;
    }
    build(metrics, range) {
        const array = [];
        metrics
            .targets
            .filter(x => !x.hidden)
            .forEach(t => {
            const gen = new Builder(this.time, t, range);
            if (!gen.invalid && !t.virgin) {
                array.push(gen.text);
            }
        });
        let request = array.join(';');
        return of(request);
    }
}
InfluxMetricsBuilder.ɵfac = function InfluxMetricsBuilder_Factory(t) { return new (t || InfluxMetricsBuilder)(i0.ɵɵdirectiveInject(i1.TimeRangeStore)); };
InfluxMetricsBuilder.ɵcmp = i0.ɵɵdefineComponent({ type: InfluxMetricsBuilder, selectors: [["metrics-builder"]], decls: 0, vars: 0, template: function InfluxMetricsBuilder_Template(rf, ctx) { }, encapsulation: 2 });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(InfluxMetricsBuilder, [{
        type: Component,
        args: [{
                selector: 'metrics-builder',
                template: ''
            }]
    }], function () { return [{ type: i1.TimeRangeStore }]; }, null); })();
class Builder {
    constructor(time, target, range) {
        this.time = time;
        this.target = target;
        this.range = range;
    }
    get invalid() {
        const invalidQuery = (!this.target) ||
            (!this.target.fields || 0 === this.target.fields.length);
        return invalidQuery;
    }
    get text() {
        return `SELECT ${this.getFieldsText()} FROM ${this.getMeasurementText()}`;
    }
    getFieldsText() {
        let result = '';
        if (!this.target.fields) {
            return result;
        }
        this.target.fields.forEach(x => {
            if (result.length > 0) {
                result += ', ';
            }
            result += this.getFieldText(x);
        });
        return result;
    }
    getFieldText(field) {
        let result = '';
        let key = (!field.key) ? 'field' : field.key;
        const aggr = field.functions.find(x => AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Aggregations ||
            AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Selectors);
        if (aggr) {
            result += aggr.name + ((aggr.param && aggr.param.value) ?
                `("${key}", ${aggr.param.value})` : `("${key}")`);
        }
        else {
            result = `"${key}"`;
        }
        const trans = field.functions.filter(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Transformations);
        trans.forEach(x => {
            const p = (x.param && x.param.value) ? `, ${x.param.value}` : ``;
            result = `${x.name}(${result}${p})`;
        });
        const math = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Math);
        if (math) {
            result = `${result} ${math.param.value}`;
        }
        const alias = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Alias);
        if (alias) {
            result = `${result} AS "${alias.param.value}"`;
        }
        return result;
    }
    getMeasurementText() {
        const meas = (!this.target.measurement) ? 'measurement' : this.target.measurement;
        let rp = (this.target.policy && this.target.policy.length > 0 && this.target.policy !== 'default') ?
            `"${this.target.policy}".` : '';
        let root = `${rp}"${meas}"`;
        let cond = '';
        let tagIndex = 0;
        if (this.target.tags) {
            this
                .target
                .tags
                .filter(x => x.key && x.value)
                .forEach(x => {
                if (tagIndex > 0) {
                    cond += ` ${x.condition} `;
                }
                const value = isRegex(x.value) ? x.value : `'${x.value}'`;
                cond += ` "${x.key}" ${x.operator} ${value}`;
                ++tagIndex;
            });
        }
        const timeFilter = (this.range) ?
            this.getTimeFilter() : MetricVars.TIME_FILTER;
        if (cond.length > 0) {
            root = `${root} WHERE (${cond}) and ${timeFilter}`;
        }
        else {
            // TODO
            root = `${root} WHERE ${timeFilter}`;
        }
        const groupBy = this.target.groupBy;
        const groupByTime = groupBy.find(x => x.type == GroupByOption.Time);
        const groupByFill = groupBy.find(x => x.type == GroupByOption.Fill);
        const groupByTag = groupBy.filter(x => x.type == GroupByOption.Tag);
        //console.log( groupBy );
        if (groupByTime) {
            const gb = (this.range && groupByTime.params[0] == MetricVars.TIME_INTERVAL) ?
                this.getOptimalAutoGroupBy() : groupByTime.params[0];
            root = `${root} GROUP BY time(${gb})`;
        }
        if (groupByTag.length > 0) {
            root = (!groupByTime) ? `${root} GROUP BY` : `${root},`;
            groupByTag.forEach((e, index) => {
                root = `${root}${index > 0 ? ', ' : ' '} "${e.params[0]}"`;
            });
        }
        if (groupByFill) {
            root = `${root} FILL(${groupByFill.params[0]})`;
        }
        if (this.target.order != OrderByTime.Asc) {
            root = `${root} ORDER BY time DESC`;
        }
        if (this.target.limit > 0) {
            root = `${root} LIMIT ${this.target.limit}`;
        }
        if (this.target.slimit > 0) {
            root = `${root} SLIMIT ${this.target.slimit}`;
        }
        return root;
    }
    getOptimalAutoGroupBy() {
        const f = TimeRangeParser.toDateTime(this.range.from, false);
        const t = TimeRangeParser.toDateTime(this.range.to, true);
        if (5 > +t.diff(f, "minutes"))
            return "200ms";
        if (15 > +t.diff(f, "minutes"))
            return "1s";
        if (30 > t.diff(f, "minutes"))
            return "2s";
        if (1 > t.diff(f, "hours"))
            return "5s";
        if (3 > t.diff(f, "hours"))
            return "10s";
        if (6 > t.diff(f, "hours"))
            return "20s";
        if (12 > t.diff(f, "hours"))
            return "1m";
        if (24 > t.diff(f, "hours"))
            return "2m";
        if (7 > t.diff(f, "days"))
            return "10m";
        if (31 > t.diff(f, "days"))
            return "1h";
        if (365 > t.diff(f, "days"))
            return "12h";
        return "24h";
    }
    getTimeFilter() {
        const range = this.range;
        const tz = this.time.converter.timezone; //this.range.timezone;
        let from = this.getInfluxTime(range.from, false, tz);
        let to = this.getInfluxTime(range.to, true, tz);
        const fromIsAbsolute = from[from.length - 1] === 'ms';
        if (to === 'now()' && !fromIsAbsolute) {
            return 'time >= ' + from;
        }
        return 'time >= ' + from + ' and time <= ' + to;
    }
    getInfluxTime(date, roundUp, timezone) {
        if (_.isString(date)) {
            if (date === 'now') {
                return 'now()';
            }
            const parts = /^now-(\d+)([dhms])$/.exec(date);
            if (parts) {
                const amount = parseInt(parts[1], 10);
                const unit = parts[2];
                return 'now() - ' + amount + unit;
            }
            date = TimeRangeParser.toDateTime(date, roundUp, timezone);
        }
        return date.valueOf() + 'ms';
    }
}
export function isRegex(expr) {
    let isValid = true;
    try {
        new RegExp(expr);
        isValid = (expr.startsWith('/') && expr.endsWith('/'));
    }
    catch (e) {
        isValid = false;
    }
    return isValid;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2FwcC9wbHVnaW5zL2RhdGFzb3VyY2VzL2luZmx1eC9zcmMvbWV0cmljcy9idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFhLGVBQWUsRUFDRSxNQUFNLFFBQVEsQ0FBQztBQUNwRCxPQUFPLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFDOUIsV0FBVyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQWUsTUFBTSxhQUFhLENBQUM7QUFDakYsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7O0FBTXRDLE1BQU0sT0FBTyxvQkFBb0I7SUFFaEMsWUFBcUIsT0FBdUIsU0FBUyxDQUFBLGtCQUFrQjtRQUFsRCxTQUFJLEdBQUosSUFBSSxDQUE0QjtJQUVwRCxDQUFDO0lBRUYsS0FBSyxDQUFFLE9BQWdCLEVBQUUsS0FBaUI7UUFDekMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBRWpCLE9BQU87YUFDRixPQUFPO2FBQ1AsTUFBTSxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBZSxDQUFFLENBQUMsTUFBTSxDQUFFO2FBQzFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNaLE1BQU0sR0FBRyxHQUFHLElBQUksT0FBTyxDQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEtBQUssQ0FBRSxDQUFDO1lBRS9DLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLENBQU8sQ0FBRSxDQUFDLE1BQU0sRUFBRTtnQkFDckMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDckI7UUFDRixDQUFDLENBQUMsQ0FBQztRQUVKLElBQUksT0FB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QUFHLGVBQWUsQ0FBQyxVQUFVLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFFLENBQUM7UUFFOUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxTQUFTLENBQUU7WUFDOUIsT0FBTyxPQUFPLENBQUM7UUFFaEIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxTQUFTLENBQUU7WUFDL0IsT0FBTyxJQUFJLENBQUM7UUFFYixJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxTQUFTLENBQUU7WUFDOUIsT0FBTyxJQUFJLENBQUM7UUFFYixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxPQUFPLENBQUU7WUFDM0IsT0FBTyxJQUFJLENBQUM7UUFFYixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxPQUFPLENBQUU7WUFDM0IsT0FBTyxLQUFLLENBQUM7UUFFZCxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxPQUFPLENBQUU7WUFDM0IsT0FBTyxLQUFLLENBQUM7UUFFZCxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxPQUFPLENBQUU7WUFDNUIsT0FBTyxJQUFJLENBQUM7UUFFYixJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxPQUFPLENBQUU7WUFDNUIsT0FBTyxJQUFJLENBQUM7UUFFYixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxNQUFNLENBQUU7WUFDMUIsT0FBTyxLQUFLLENBQUM7UUFFZCxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxNQUFNLENBQUU7WUFDM0IsT0FBTyxJQUFJLENBQUM7UUFFYixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsRUFBRSxNQUFNLENBQUU7WUFDNUIsT0FBTyxLQUFLLENBQUM7UUFFYixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFQSxhQUFhO1FBQ1gsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN6QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxzQkFBc0I7UUFFL0QsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBRSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN0RCxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFFLEtBQUssQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQztRQUV0RCxJQUFJLEVBQUUsS0FBSyxPQUFPLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDckMsT0FBTyxVQUFVLEdBQUcsSUFBSSxDQUFDO1NBQzFCO1FBRUQsT0FBTyxVQUFVLEdBQUcsSUFBSSxHQUFHLGVBQWUsR0FBRyxFQUFFLENBQUM7SUFDbkQsQ0FBQztJQUVBLGFBQWEsQ0FBQyxJQUFTLEVBQUUsT0FBWSxFQUFFLFFBQWtCO1FBQ3ZELElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNwQixJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7Z0JBQ2xCLE9BQU8sT0FBTyxDQUFDO2FBQ2hCO1lBRUQsTUFBTSxLQUFLLEdBQUcscUJBQXFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRS9DLElBQUksS0FBSyxFQUFFO2dCQUNULE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQ3RDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEIsT0FBTyxVQUFVLEdBQUcsTUFBTSxHQUFHLElBQUksQ0FBQzthQUNuQztZQUVELElBQUksR0FBRyxlQUFlLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDNUQ7UUFFRCxPQUFPLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDL0IsQ0FBQztDQUVGO0FBRUQsTUFBTSxVQUFVLE9BQU8sQ0FBQyxJQUFJO0lBQzFCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztJQUNuQixJQUFJO1FBQ0YsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakIsT0FBTyxHQUFHLENBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBRSxHQUFHLENBQUUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFFLEdBQUcsQ0FBRSxDQUFHLENBQUE7S0FDOUQ7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sR0FBRyxLQUFLLENBQUM7S0FDakI7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaW1lUmFuZ2UsIFRpbWVSYW5nZVBhcnNlciwgVGltZVJhbmdlU3RvcmUsXG4gIFRpbWV6b25lLCBNZXRyaWNzQnVpbGRlciwgTWV0cmljcyB9IGZyb20gJ2NvbW1vbic7XG5pbXBvcnQgeyBBZ2dyRnVuY0dyb3VwLCBBZ2dyRnVuY0hlbHBlcixcblx0RmllbGQsIE9yZGVyQnlUaW1lLCBHcm91cEJ5T3B0aW9uLCBNZXRyaWNWYXJzLCBJbmZsdXhRdWVyeSB9IGZyb20gJy4vbWV0cmljcy5tJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5cbkBDb21wb25lbnQoe1xuXHRzZWxlY3RvcjogJ21ldHJpY3MtYnVpbGRlcicsXG5cdHRlbXBsYXRlOiAnJ1xufSlcbmV4cG9ydCBjbGFzcyBJbmZsdXhNZXRyaWNzQnVpbGRlciBpbXBsZW1lbnRzIE1ldHJpY3NCdWlsZGVyIHtcblxuXHRjb25zdHJ1Y3RvciggcHJpdmF0ZSB0aW1lOiBUaW1lUmFuZ2VTdG9yZSA9IHVuZGVmaW5lZC8qIGZvciB0aW1lem9uZSAqLyApe1xuXHRcdFxuICB9XG5cblx0YnVpbGQoIG1ldHJpY3M6IE1ldHJpY3MsIHJhbmdlPzogVGltZVJhbmdlICkgOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuXHRcdGNvbnN0IGFycmF5ID0gW107XG5cblx0XHRtZXRyaWNzXG4gICAgICAudGFyZ2V0c1xuICAgICAgLmZpbHRlciggeCA9PiAhKDxJbmZsdXhRdWVyeT54KS5oaWRkZW4gKVxuXHRcdFx0LmZvckVhY2godCA9PiB7XG5cdFx0XHRcdGNvbnN0IGdlbiA9IG5ldyBCdWlsZGVyKCB0aGlzLnRpbWUsIHQsIHJhbmdlICk7XG5cblx0XHRcdFx0aWYgKCFnZW4uaW52YWxpZCAmJiAhKDxhbnk+dCkudmlyZ2luKSB7XG5cdFx0XHRcdFx0YXJyYXkucHVzaChnZW4udGV4dCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXG5cdFx0bGV0IHJlcXVlc3QgPSBhcnJheS5qb2luKCc7Jyk7XG5cblx0XHRyZXR1cm4gb2YoIHJlcXVlc3QgKTtcblx0fVxufVxuXG5jbGFzcyBCdWlsZGVye1xuXHRnZXQgaW52YWxpZCgpe1xuICAgIGNvbnN0IGludmFsaWRRdWVyeSA9IFxuICAgICAgKCF0aGlzLnRhcmdldCkgfHxcbiAgICAgICghdGhpcy50YXJnZXQuZmllbGRzIHx8IDAgPT09IHRoaXMudGFyZ2V0LmZpZWxkcy5sZW5ndGggKTtcblxuICAgIHJldHVybiBpbnZhbGlkUXVlcnk7XG5cdH1cblx0XG5cdGdldCB0ZXh0KCkge1xuICAgIHJldHVybiBgU0VMRUNUICR7dGhpcy5nZXRGaWVsZHNUZXh0KCl9IEZST00gJHt0aGlzLmdldE1lYXN1cmVtZW50VGV4dCgpfWBcbiAgfVxuXG5cdGNvbnN0cnVjdG9yKCBcblx0XHRwcml2YXRlIHRpbWU6IFRpbWVSYW5nZVN0b3JlLFxuXHRcdHByaXZhdGUgdGFyZ2V0OiBhbnksXG5cdFx0cHJpdmF0ZSByYW5nZT86IFRpbWVSYW5nZSApe1xuXG5cdH1cblxuXHRnZXRGaWVsZHNUZXh0KCkge1xuXHRcdGxldCByZXN1bHQgPSAnJztcblx0XHRcbiAgICBpZiAoIXRoaXMudGFyZ2V0LmZpZWxkcykge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICB0aGlzLnRhcmdldC5maWVsZHMuZm9yRWFjaCh4ID0+IHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICByZXN1bHQgKz0gJywgJztcbiAgICAgIH1cblxuICAgICAgcmVzdWx0ICs9IHRoaXMuZ2V0RmllbGRUZXh0KCB4ICk7XG4gICAgfSlcblxuICAgIHJldHVybiByZXN1bHQ7XG5cdH1cblx0XG5cdFxuICBnZXRGaWVsZFRleHQoZmllbGQ6IEZpZWxkKSB7XG5cdFx0IGxldCByZXN1bHQgPSAnJztcbiAgICBsZXQga2V5ID0gKCFmaWVsZC5rZXkpID8gJ2ZpZWxkJyA6IGZpZWxkLmtleTtcblxuICAgIGNvbnN0IGFnZ3IgPSBmaWVsZC5mdW5jdGlvbnMuZmluZCh4ID0+XG4gICAgICBBZ2dyRnVuY0hlbHBlci5nZXRHcm91cCh4Lm5hbWUpID09IEFnZ3JGdW5jR3JvdXAuQWdncmVnYXRpb25zIHx8XG4gICAgICBBZ2dyRnVuY0hlbHBlci5nZXRHcm91cCh4Lm5hbWUpID09IEFnZ3JGdW5jR3JvdXAuU2VsZWN0b3JzKTtcblxuICAgIGlmIChhZ2dyKSB7XG4gICAgICByZXN1bHQgKz0gYWdnci5uYW1lICsgKChhZ2dyLnBhcmFtICYmIGFnZ3IucGFyYW0udmFsdWUpID9cbiAgICAgICAgYChcIiR7a2V5fVwiLCAke2FnZ3IucGFyYW0udmFsdWV9KWAgOiBgKFwiJHtrZXl9XCIpYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdCA9IGBcIiR7a2V5fVwiYDtcbiAgICB9XG5cbiAgICBjb25zdCB0cmFucyA9IGZpZWxkLmZ1bmN0aW9ucy5maWx0ZXIoeCA9PlxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PT0gQWdnckZ1bmNHcm91cC5UcmFuc2Zvcm1hdGlvbnMpO1xuXG4gICAgdHJhbnMuZm9yRWFjaCh4ID0+IHtcbiAgICAgIGNvbnN0IHAgPSAoeC5wYXJhbSAmJiB4LnBhcmFtLnZhbHVlKSA/IGAsICR7eC5wYXJhbS52YWx1ZX1gIDogYGA7XG4gICAgICByZXN1bHQgPSBgJHt4Lm5hbWV9KCR7cmVzdWx0fSR7cH0pYDtcbiAgICB9KVxuXG4gICAgY29uc3QgbWF0aCA9IGZpZWxkLmZ1bmN0aW9ucy5maW5kKHggPT5cbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT09IEFnZ3JGdW5jR3JvdXAuTWF0aCk7XG5cbiAgICBpZiAobWF0aCkge1xuICAgICAgcmVzdWx0ID0gYCR7cmVzdWx0fSAke21hdGgucGFyYW0udmFsdWV9YDtcbiAgICB9XG5cbiAgICBjb25zdCBhbGlhcyA9IGZpZWxkLmZ1bmN0aW9ucy5maW5kKHggPT5cbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT09IEFnZ3JGdW5jR3JvdXAuQWxpYXMpO1xuXG4gICAgaWYgKGFsaWFzKSB7XG4gICAgICByZXN1bHQgPSBgJHtyZXN1bHR9IEFTIFwiJHthbGlhcy5wYXJhbS52YWx1ZX1cImA7XG4gICAgfVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXHRcbiAgZ2V0TWVhc3VyZW1lbnRUZXh0KCkge1xuICAgIGNvbnN0IG1lYXMgPSAoIXRoaXMudGFyZ2V0Lm1lYXN1cmVtZW50KSA/ICdtZWFzdXJlbWVudCcgOiB0aGlzLnRhcmdldC5tZWFzdXJlbWVudDtcblxuICAgIGxldCBycCA9ICh0aGlzLnRhcmdldC5wb2xpY3kgJiYgdGhpcy50YXJnZXQucG9saWN5Lmxlbmd0aCA+IDAgJiYgdGhpcy50YXJnZXQucG9saWN5ICE9PSAnZGVmYXVsdCcpID9cbiAgICAgIGBcIiR7dGhpcy50YXJnZXQucG9saWN5fVwiLmAgOiAnJztcblxuICAgIGxldCByb290ID0gYCR7cnB9XCIke21lYXN9XCJgO1xuICAgIGxldCBjb25kID0gJyc7XG5cbiAgICBsZXQgdGFnSW5kZXggPSAwO1xuXG4gICAgaWYgKHRoaXMudGFyZ2V0LnRhZ3MpIHtcbiAgICAgIHRoaXNcbiAgICAgICAgLnRhcmdldFxuICAgICAgICAudGFnc1xuICAgICAgICAuZmlsdGVyKHggPT4geC5rZXkgJiYgeC52YWx1ZSlcbiAgICAgICAgLmZvckVhY2goeCA9PiB7XG4gICAgICAgICAgaWYgKHRhZ0luZGV4ID4gMCkge1xuICAgICAgICAgICAgY29uZCArPSBgICR7eC5jb25kaXRpb259IGA7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBpc1JlZ2V4KCB4LnZhbHVlICkgPyB4LnZhbHVlIDogYCcke3gudmFsdWV9J2A7XG4gICAgICAgICAgY29uZCArPSBgIFwiJHt4LmtleX1cIiAke3gub3BlcmF0b3J9ICR7dmFsdWV9YDtcbiAgICAgICAgICArK3RhZ0luZGV4O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB0aW1lRmlsdGVyID0gKCB0aGlzLnJhbmdlICkgP1xuICAgICAgdGhpcy5nZXRUaW1lRmlsdGVyKCkgOiBNZXRyaWNWYXJzLlRJTUVfRklMVEVSO1xuXG4gICAgaWYgKGNvbmQubGVuZ3RoID4gMCkge1xuICAgICAgcm9vdCA9IGAke3Jvb3R9IFdIRVJFICgke2NvbmR9KSBhbmQgJHt0aW1lRmlsdGVyfWBcbiAgICB9XG4gICAgZWxzZXtcbiAgICAgIC8vIFRPRE9cbiAgICAgIHJvb3QgPSBgJHtyb290fSBXSEVSRSAke3RpbWVGaWx0ZXJ9YFxuXHRcdH1cblxuXHRcdGNvbnN0IGdyb3VwQnkgPSB0aGlzLnRhcmdldC5ncm91cEJ5O1xuXHRcdGNvbnN0IGdyb3VwQnlUaW1lID0gZ3JvdXBCeS5maW5kKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLlRpbWUgKTtcblx0XHRjb25zdCBncm91cEJ5RmlsbCA9IGdyb3VwQnkuZmluZCggeCA9PiB4LnR5cGUgPT0gR3JvdXBCeU9wdGlvbi5GaWxsICk7XG4gICAgY29uc3QgZ3JvdXBCeVRhZyA9IGdyb3VwQnkuZmlsdGVyKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLlRhZyApO1xuICAgIFxuICAgIC8vY29uc29sZS5sb2coIGdyb3VwQnkgKTtcblxuXHRcdGlmKCBncm91cEJ5VGltZSApe1xuICAgICAgY29uc3QgZ2IgPSAoIHRoaXMucmFuZ2UgJiYgZ3JvdXBCeVRpbWUucGFyYW1zWyAwIF0gPT0gTWV0cmljVmFycy5USU1FX0lOVEVSVkFMICkgP1xuICAgICAgICB0aGlzLmdldE9wdGltYWxBdXRvR3JvdXBCeSgpIDogZ3JvdXBCeVRpbWUucGFyYW1zWyAwIF07XG4gICAgICAgIFxuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IEdST1VQIEJZIHRpbWUoJHtnYn0pYFxuXHRcdH1cblxuXHRcdGlmKCBncm91cEJ5VGFnLmxlbmd0aCA+IDAgKXtcblx0XHRcdHJvb3QgPSAoICFncm91cEJ5VGltZSApID8gYCR7cm9vdH0gR1JPVVAgQllgIDogYCR7cm9vdH0sYDsgXG5cblx0XHRcdGdyb3VwQnlUYWcuZm9yRWFjaCggKGUsaW5kZXgpID0+IHtcblx0XHRcdFx0cm9vdCA9IGAke3Jvb3R9JHtpbmRleCA+MCA/ICcsICcgOiAnICd9IFwiJHtlLnBhcmFtc1sgMCBdfVwiYFxuXHRcdFx0fSApXG5cdFx0fVxuXHRcdFxuXHRcdGlmKCBncm91cEJ5RmlsbCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IEZJTEwoJHtncm91cEJ5RmlsbC5wYXJhbXNbIDAgXX0pYFxuXHRcdH1cblxuXHRcdGlmKCB0aGlzLnRhcmdldC5vcmRlciAhPSBPcmRlckJ5VGltZS5Bc2MgKXtcblx0XHRcdHJvb3QgPSBgJHtyb290fSBPUkRFUiBCWSB0aW1lIERFU0NgOyBcblx0XHR9XG5cdFx0XG5cdFx0aWYoIHRoaXMudGFyZ2V0LmxpbWl0ID4gMCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IExJTUlUICR7dGhpcy50YXJnZXQubGltaXR9YDtcblx0XHR9XG5cblx0XHRpZiggdGhpcy50YXJnZXQuc2xpbWl0ID4gMCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IFNMSU1JVCAke3RoaXMudGFyZ2V0LnNsaW1pdH1gO1xuXHRcdH1cblxuICAgIHJldHVybiByb290O1xuXHR9XG5cdFxuICBnZXRPcHRpbWFsQXV0b0dyb3VwQnkoKSA6IHN0cmluZyB7XG4gICAgY29uc3QgZiA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKCB0aGlzLnJhbmdlLmZyb20sIGZhbHNlICk7XG4gICAgY29uc3QgdCA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKCB0aGlzLnJhbmdlLnRvLCB0cnVlICk7XG5cblx0XHRpZiAoNSA+ICt0LmRpZmYoIGYsIFwibWludXRlc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyMDBtc1wiO1xuXG5cdFx0aWYgKDE1ID4gK3QuZGlmZiggZiwgXCJtaW51dGVzXCIgKSlcblx0XHRcdHJldHVybiBcIjFzXCI7XG5cblx0XHRpZiAoMzAgPiB0LmRpZmYoIGYsIFwibWludXRlc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyc1wiO1xuXG5cdFx0aWYgKDEgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiNXNcIjtcdFx0XG5cblx0XHRpZiAoMyA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIxMHNcIjtcdFx0XG5cblx0XHRpZiAoNiA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyMHNcIjtcdFx0XG5cblx0XHRpZiAoMTIgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMW1cIjtcdFx0XG5cblx0XHRpZiAoMjQgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMm1cIjtcdFx0XG5cblx0XHRpZiAoNyA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjEwbVwiO1x0XHRcblxuXHRcdGlmICgzMSA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjFoXCI7XHRcdFxuXG5cdFx0aWYgKDM2NSA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjEyaFwiO1x0XHRcblxuXHRcdCByZXR1cm4gXCIyNGhcIjtcblx0fVxuXG4gIGdldFRpbWVGaWx0ZXIoKSB7XG4gICAgY29uc3QgcmFuZ2UgPSB0aGlzLnJhbmdlO1xuICAgIGNvbnN0IHR6ID0gdGhpcy50aW1lLmNvbnZlcnRlci50aW1lem9uZTsgLy90aGlzLnJhbmdlLnRpbWV6b25lO1xuXG4gICAgbGV0IGZyb20gPSB0aGlzLmdldEluZmx1eFRpbWUoIHJhbmdlLmZyb20sIGZhbHNlLCB0eik7XG4gICAgbGV0IHRvID0gdGhpcy5nZXRJbmZsdXhUaW1lKCByYW5nZS50bywgdHJ1ZSwgdHopO1xuXG4gICAgY29uc3QgZnJvbUlzQWJzb2x1dGUgPSBmcm9tW2Zyb20ubGVuZ3RoIC0gMV0gPT09ICdtcyc7XG5cbiAgICBpZiAodG8gPT09ICdub3coKScgJiYgIWZyb21Jc0Fic29sdXRlKSB7XG4gICAgICByZXR1cm4gJ3RpbWUgPj0gJyArIGZyb207XG4gICAgfVxuXG4gICAgcmV0dXJuICd0aW1lID49ICcgKyBmcm9tICsgJyBhbmQgdGltZSA8PSAnICsgdG87XG5cdH1cblx0XG4gIGdldEluZmx1eFRpbWUoZGF0ZTogYW55LCByb3VuZFVwOiBhbnksIHRpbWV6b25lOiBUaW1lem9uZSkge1xuICAgIGlmIChfLmlzU3RyaW5nKGRhdGUpKSB7XG4gICAgICBpZiAoZGF0ZSA9PT0gJ25vdycpIHtcbiAgICAgICAgcmV0dXJuICdub3coKSc7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBhcnRzID0gL15ub3ctKFxcZCspKFtkaG1zXSkkLy5leGVjKGRhdGUpO1xuXG4gICAgICBpZiAocGFydHMpIHtcbiAgICAgICAgY29uc3QgYW1vdW50ID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTtcbiAgICAgICAgY29uc3QgdW5pdCA9IHBhcnRzWzJdO1xuICAgICAgICByZXR1cm4gJ25vdygpIC0gJyArIGFtb3VudCArIHVuaXQ7XG4gICAgICB9XG5cbiAgICAgIGRhdGUgPSBUaW1lUmFuZ2VQYXJzZXIudG9EYXRlVGltZShkYXRlLCByb3VuZFVwLCB0aW1lem9uZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGUudmFsdWVPZigpICsgJ21zJztcbiAgfVxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1JlZ2V4KGV4cHIpIHtcbiAgbGV0IGlzVmFsaWQgPSB0cnVlO1xuICB0cnkge1xuICAgIG5ldyBSZWdFeHAoZXhwcik7XG5cbiAgICBpc1ZhbGlkID0gKCBleHByLnN0YXJ0c1dpdGgoICcvJyApICYmIGV4cHIuZW5kc1dpdGgoICcvJyApICApXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpc1ZhbGlkID0gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gaXNWYWxpZDtcbn0iXX0=