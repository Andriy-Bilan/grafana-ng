import { Component } from '@angular/core';
import { TimeRangeParser } from 'common';
import { AggrFuncGroup, AggrFuncHelper, OrderByTime, GroupByOption, MetricVars } from './metrics.m';
import * as _ from 'lodash';
import { of } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "common";
export class InfluxMetricsBuilder {
    constructor(time = undefined /* for timezone */) {
        this.time = time;
    }
    build(metrics, range) {
        const array = [];
        metrics
            .targets
            .forEach(t => {
            const gen = new Builder(this.time, t, range);
            if (!gen.invalid && !t.virgin) {
                array.push(gen.text);
            }
        });
        let request = array.join(';');
        return of(request);
    }
}
InfluxMetricsBuilder.ɵfac = function InfluxMetricsBuilder_Factory(t) { return new (t || InfluxMetricsBuilder)(i0.ɵɵdirectiveInject(i1.TimeRangeStore)); };
InfluxMetricsBuilder.ɵcmp = i0.ɵɵdefineComponent({ type: InfluxMetricsBuilder, selectors: [["metrics-builder"]], decls: 0, vars: 0, template: function InfluxMetricsBuilder_Template(rf, ctx) { }, encapsulation: 2 });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(InfluxMetricsBuilder, [{
        type: Component,
        args: [{
                selector: 'metrics-builder',
                template: ''
            }]
    }], function () { return [{ type: i1.TimeRangeStore }]; }, null); })();
class Builder {
    constructor(time, target, range) {
        this.time = time;
        this.target = target;
        this.range = range;
    }
    get invalid() {
        const invalidQuery = (!this.target) ||
            (!this.target.fields || 0 === this.target.fields.length);
        return invalidQuery;
    }
    get text() {
        return `SELECT ${this.getFieldsText()} FROM ${this.getMeasurementText()}`;
    }
    getFieldsText() {
        let result = '';
        if (!this.target.fields) {
            return result;
        }
        this.target.fields.forEach(x => {
            if (result.length > 0) {
                result += ', ';
            }
            result += this.getFieldText(x);
        });
        return result;
    }
    getFieldText(field) {
        let result = '';
        let key = (!field.key) ? 'field' : field.key;
        const aggr = field.functions.find(x => AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Aggregations ||
            AggrFuncHelper.getGroup(x.name) == AggrFuncGroup.Selectors);
        if (aggr) {
            result += aggr.name + ((aggr.param && aggr.param.value) ?
                `("${key}", ${aggr.param.value})` : `("${key}")`);
        }
        else {
            result = `"${key}"`;
        }
        const trans = field.functions.filter(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Transformations);
        trans.forEach(x => {
            const p = (x.param && x.param.value) ? `, ${x.param.value}` : ``;
            result = `${x.name}(${result}${p})`;
        });
        const math = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Math);
        if (math) {
            result = `${result} ${math.param.value}`;
        }
        const alias = field.functions.find(x => AggrFuncHelper.getGroup(x.name) === AggrFuncGroup.Alias);
        if (alias) {
            result = `${result} AS "${alias.param.value}"`;
        }
        return result;
    }
    getMeasurementText() {
        const meas = (!this.target.measurement) ? 'measurement' : this.target.measurement;
        let rp = (this.target.policy && this.target.policy.length > 0 && this.target.policy !== 'default') ?
            `"${this.target.policy}".` : '';
        let root = `${rp}"${meas}"`;
        let cond = '';
        let tagIndex = 0;
        if (this.target.tags) {
            this
                .target
                .tags
                .filter(x => x.key && x.value)
                .forEach(x => {
                if (tagIndex > 0) {
                    cond += ` ${x.condition} `;
                }
                cond += ` "${x.key}" ${x.operator} '${x.value}'`;
                ++tagIndex;
            });
        }
        const timeFilter = (this.range) ?
            this.getTimeFilter() : MetricVars.TIME_FILTER;
        if (cond.length > 0) {
            root = `${root} WHERE (${cond}) and ${timeFilter}`;
        }
        else {
            // TODO
            root = `${root} WHERE ${timeFilter}`;
        }
        const groupBy = this.target.groupBy;
        const groupByTime = groupBy.find(x => x.type == GroupByOption.Time);
        const groupByFill = groupBy.find(x => x.type == GroupByOption.Fill);
        const groupByTag = groupBy.filter(x => x.type == GroupByOption.Tag);
        //console.log( groupBy );
        if (groupByTime) {
            const gb = (this.range && groupByTime.params[0] == MetricVars.TIME_INTERVAL) ?
                this.getOptimalAutoGroupBy() : groupByTime.params[0];
            root = `${root} GROUP BY time(${gb})`;
        }
        if (groupByTag.length > 0) {
            root = (!groupByTime) ? `${root} GROUP BY` : `${root},`;
            groupByTag.forEach((e, index) => {
                root = `${root}${index > 0 ? ', ' : ' '} "${e.params[0]}"`;
            });
        }
        if (groupByFill) {
            root = `${root} FILL(${groupByFill.params[0]})`;
        }
        if (this.target.order != OrderByTime.Asc) {
            root = `${root} ORDER BY time DESC`;
        }
        if (this.target.limit > 0) {
            root = `${root} LIMIT ${this.target.limit}`;
        }
        if (this.target.slimit > 0) {
            root = `${root} SLIMIT ${this.target.slimit}`;
        }
        return root;
    }
    getOptimalAutoGroupBy() {
        const f = TimeRangeParser.toDateTime(this.range.from, false);
        const t = TimeRangeParser.toDateTime(this.range.to, true);
        if (5 > +t.diff(f, "minutes"))
            return "200ms";
        if (15 > +t.diff(f, "minutes"))
            return "1s";
        if (30 > t.diff(f, "minutes"))
            return "2s";
        if (1 > t.diff(f, "hours"))
            return "5s";
        if (3 > t.diff(f, "hours"))
            return "10s";
        if (6 > t.diff(f, "hours"))
            return "20s";
        if (12 > t.diff(f, "hours"))
            return "1m";
        if (24 > t.diff(f, "hours"))
            return "2m";
        if (7 > t.diff(f, "days"))
            return "10m";
        if (31 > t.diff(f, "days"))
            return "1h";
        if (365 > t.diff(f, "days"))
            return "12h";
        return "24h";
    }
    getTimeFilter() {
        const range = this.range;
        const tz = this.time.converter.timezone; //this.range.timezone;
        let from = this.getInfluxTime(range.from, false, tz);
        let to = this.getInfluxTime(range.to, true, tz);
        const fromIsAbsolute = from[from.length - 1] === 'ms';
        if (to === 'now()' && !fromIsAbsolute) {
            return 'time >= ' + from;
        }
        return 'time >= ' + from + ' and time <= ' + to;
    }
    getInfluxTime(date, roundUp, timezone) {
        if (_.isString(date)) {
            if (date === 'now') {
                return 'now()';
            }
            const parts = /^now-(\d+)([dhms])$/.exec(date);
            if (parts) {
                const amount = parseInt(parts[1], 10);
                const unit = parts[2];
                return 'now() - ' + amount + unit;
            }
            date = TimeRangeParser.toDateTime(date, roundUp, timezone);
        }
        return date.valueOf() + 'ms';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2FwcC9wbHVnaW5zL2RhdGFzb3VyY2VzL2luZmx1eC9zcmMvbWV0cmljcy9idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFhLGVBQWUsRUFDZSxNQUFNLFFBQVEsQ0FBQztBQUNqRSxPQUFPLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFDOUIsV0FBVyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEUsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7O0FBTXRDLE1BQU0sT0FBTyxvQkFBb0I7SUFFaEMsWUFBcUIsT0FBdUIsU0FBUyxDQUFBLGtCQUFrQjtRQUFsRCxTQUFJLEdBQUosSUFBSSxDQUE0QjtJQUVwRCxDQUFDO0lBRUYsS0FBSyxDQUFFLE9BQWdCLEVBQUUsS0FBaUI7UUFDekMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBRWpCLE9BQU87YUFDTCxPQUFPO2FBQ1AsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ1osTUFBTSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFFLENBQUM7WUFFL0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBTyxDQUFFLENBQUMsTUFBTSxFQUFFO2dCQUNyQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNyQjtRQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUU5QixPQUFPLEVBQUUsQ0FB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QUM1RDtRQUVELE9BQU8sSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQztJQUMvQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRpbWVSYW5nZSwgVGltZVJhbmdlUGFyc2VyLCBUaW1lUmFuZ2VTdG9yZSxcbiAgVGltZXpvbmUsIE1ldHJpY3NCdWlsZGVyLCBNZXRyaWNzLCBNZXRyaWNRdWVyeSB9IGZyb20gJ2NvbW1vbic7XG5pbXBvcnQgeyBBZ2dyRnVuY0dyb3VwLCBBZ2dyRnVuY0hlbHBlcixcblx0RmllbGQsIE9yZGVyQnlUaW1lLCBHcm91cEJ5T3B0aW9uLCBNZXRyaWNWYXJzIH0gZnJvbSAnLi9tZXRyaWNzLm0nO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcblxuQENvbXBvbmVudCh7XG5cdHNlbGVjdG9yOiAnbWV0cmljcy1idWlsZGVyJyxcblx0dGVtcGxhdGU6ICcnXG59KVxuZXhwb3J0IGNsYXNzIEluZmx1eE1ldHJpY3NCdWlsZGVyIGltcGxlbWVudHMgTWV0cmljc0J1aWxkZXIge1xuXG5cdGNvbnN0cnVjdG9yKCBwcml2YXRlIHRpbWU6IFRpbWVSYW5nZVN0b3JlID0gdW5kZWZpbmVkLyogZm9yIHRpbWV6b25lICovICl7XG5cdFx0XG4gIH1cblxuXHRidWlsZCggbWV0cmljczogTWV0cmljcywgcmFuZ2U/OiBUaW1lUmFuZ2UgKSA6IE9ic2VydmFibGU8c3RyaW5nPiB7XG5cdFx0Y29uc3QgYXJyYXkgPSBbXTtcblxuXHRcdG1ldHJpY3Ncblx0XHRcdC50YXJnZXRzXG5cdFx0XHQuZm9yRWFjaCh0ID0+IHtcblx0XHRcdFx0Y29uc3QgZ2VuID0gbmV3IEJ1aWxkZXIoIHRoaXMudGltZSwgdCwgcmFuZ2UgKTtcblxuXHRcdFx0XHRpZiAoIWdlbi5pbnZhbGlkICYmICEoPGFueT50KS52aXJnaW4pIHtcblx0XHRcdFx0XHRhcnJheS5wdXNoKGdlbi50ZXh0KTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cblx0XHRsZXQgcmVxdWVzdCA9IGFycmF5LmpvaW4oJzsnKTtcblxuXHRcdHJldHVybiBvZiggcmVxdWVzdCApO1xuXHR9XG59XG5cbmNsYXNzIEJ1aWxkZXJ7XG5cdGdldCBpbnZhbGlkKCl7XG4gICAgY29uc3QgaW52YWxpZFF1ZXJ5ID0gXG4gICAgICAoIXRoaXMudGFyZ2V0KSB8fFxuICAgICAgKCF0aGlzLnRhcmdldC5maWVsZHMgfHwgMCA9PT0gdGhpcy50YXJnZXQuZmllbGRzLmxlbmd0aCApO1xuXG4gICAgcmV0dXJuIGludmFsaWRRdWVyeTtcblx0fVxuXHRcblx0Z2V0IHRleHQoKSB7XG4gICAgcmV0dXJuIGBTRUxFQ1QgJHt0aGlzLmdldEZpZWxkc1RleHQoKX0gRlJPTSAke3RoaXMuZ2V0TWVhc3VyZW1lbnRUZXh0KCl9YFxuICB9XG5cblx0Y29uc3RydWN0b3IoIFxuXHRcdHByaXZhdGUgdGltZTogVGltZVJhbmdlU3RvcmUsXG5cdFx0cHJpdmF0ZSB0YXJnZXQ6IGFueSxcblx0XHRwcml2YXRlIHJhbmdlPzogVGltZVJhbmdlICl7XG5cblx0fVxuXG5cdGdldEZpZWxkc1RleHQoKSB7XG5cdFx0bGV0IHJlc3VsdCA9ICcnO1xuXHRcdFxuICAgIGlmICghdGhpcy50YXJnZXQuZmllbGRzKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHRoaXMudGFyZ2V0LmZpZWxkcy5mb3JFYWNoKHggPT4ge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlc3VsdCArPSAnLCAnO1xuICAgICAgfVxuXG4gICAgICByZXN1bHQgKz0gdGhpcy5nZXRGaWVsZFRleHQoIHggKTtcbiAgICB9KVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcblx0fVxuXHRcblx0XG4gIGdldEZpZWxkVGV4dChmaWVsZDogRmllbGQpIHtcblx0XHQgbGV0IHJlc3VsdCA9ICcnO1xuICAgIGxldCBrZXkgPSAoIWZpZWxkLmtleSkgPyAnZmllbGQnIDogZmllbGQua2V5O1xuXG4gICAgY29uc3QgYWdnciA9IGZpZWxkLmZ1bmN0aW9ucy5maW5kKHggPT5cbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT0gQWdnckZ1bmNHcm91cC5BZ2dyZWdhdGlvbnMgfHxcbiAgICAgIEFnZ3JGdW5jSGVscGVyLmdldEdyb3VwKHgubmFtZSkgPT0gQWdnckZ1bmNHcm91cC5TZWxlY3RvcnMpO1xuXG4gICAgaWYgKGFnZ3IpIHtcbiAgICAgIHJlc3VsdCArPSBhZ2dyLm5hbWUgKyAoKGFnZ3IucGFyYW0gJiYgYWdnci5wYXJhbS52YWx1ZSkgP1xuICAgICAgICBgKFwiJHtrZXl9XCIsICR7YWdnci5wYXJhbS52YWx1ZX0pYCA6IGAoXCIke2tleX1cIilgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzdWx0ID0gYFwiJHtrZXl9XCJgO1xuICAgIH1cblxuICAgIGNvbnN0IHRyYW5zID0gZmllbGQuZnVuY3Rpb25zLmZpbHRlcih4ID0+XG4gICAgICBBZ2dyRnVuY0hlbHBlci5nZXRHcm91cCh4Lm5hbWUpID09PSBBZ2dyRnVuY0dyb3VwLlRyYW5zZm9ybWF0aW9ucyk7XG5cbiAgICB0cmFucy5mb3JFYWNoKHggPT4ge1xuICAgICAgY29uc3QgcCA9ICh4LnBhcmFtICYmIHgucGFyYW0udmFsdWUpID8gYCwgJHt4LnBhcmFtLnZhbHVlfWAgOiBgYDtcbiAgICAgIHJlc3VsdCA9IGAke3gubmFtZX0oJHtyZXN1bHR9JHtwfSlgO1xuICAgIH0pXG5cbiAgICBjb25zdCBtYXRoID0gZmllbGQuZnVuY3Rpb25zLmZpbmQoeCA9PlxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PT0gQWdnckZ1bmNHcm91cC5NYXRoKTtcblxuICAgIGlmIChtYXRoKSB7XG4gICAgICByZXN1bHQgPSBgJHtyZXN1bHR9ICR7bWF0aC5wYXJhbS52YWx1ZX1gO1xuICAgIH1cblxuICAgIGNvbnN0IGFsaWFzID0gZmllbGQuZnVuY3Rpb25zLmZpbmQoeCA9PlxuICAgICAgQWdnckZ1bmNIZWxwZXIuZ2V0R3JvdXAoeC5uYW1lKSA9PT0gQWdnckZ1bmNHcm91cC5BbGlhcyk7XG5cbiAgICBpZiAoYWxpYXMpIHtcbiAgICAgIHJlc3VsdCA9IGAke3Jlc3VsdH0gQVMgXCIke2FsaWFzLnBhcmFtLnZhbHVlfVwiYDtcbiAgICB9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cdFxuICBnZXRNZWFzdXJlbWVudFRleHQoKSB7XG4gICAgY29uc3QgbWVhcyA9ICghdGhpcy50YXJnZXQubWVhc3VyZW1lbnQpID8gJ21lYXN1cmVtZW50JyA6IHRoaXMudGFyZ2V0Lm1lYXN1cmVtZW50O1xuXG4gICAgbGV0IHJwID0gKHRoaXMudGFyZ2V0LnBvbGljeSAmJiB0aGlzLnRhcmdldC5wb2xpY3kubGVuZ3RoID4gMCAmJiB0aGlzLnRhcmdldC5wb2xpY3kgIT09ICdkZWZhdWx0JykgP1xuICAgICAgYFwiJHt0aGlzLnRhcmdldC5wb2xpY3l9XCIuYCA6ICcnO1xuXG4gICAgbGV0IHJvb3QgPSBgJHtycH1cIiR7bWVhc31cImA7XG4gICAgbGV0IGNvbmQgPSAnJztcblxuICAgIGxldCB0YWdJbmRleCA9IDA7XG5cbiAgICBpZiAodGhpcy50YXJnZXQudGFncykge1xuICAgICAgdGhpc1xuICAgICAgICAudGFyZ2V0XG4gICAgICAgIC50YWdzXG4gICAgICAgIC5maWx0ZXIoeCA9PiB4LmtleSAmJiB4LnZhbHVlKVxuICAgICAgICAuZm9yRWFjaCh4ID0+IHtcbiAgICAgICAgICBpZiAodGFnSW5kZXggPiAwKSB7XG4gICAgICAgICAgICBjb25kICs9IGAgJHt4LmNvbmRpdGlvbn0gYDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25kICs9IGAgXCIke3gua2V5fVwiICR7eC5vcGVyYXRvcn0gJyR7eC52YWx1ZX0nYDtcbiAgICAgICAgICArK3RhZ0luZGV4O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB0aW1lRmlsdGVyID0gKCB0aGlzLnJhbmdlICkgP1xuICAgICAgdGhpcy5nZXRUaW1lRmlsdGVyKCkgOiBNZXRyaWNWYXJzLlRJTUVfRklMVEVSO1xuXG4gICAgaWYgKGNvbmQubGVuZ3RoID4gMCkge1xuICAgICAgcm9vdCA9IGAke3Jvb3R9IFdIRVJFICgke2NvbmR9KSBhbmQgJHt0aW1lRmlsdGVyfWBcbiAgICB9XG4gICAgZWxzZXtcbiAgICAgIC8vIFRPRE9cbiAgICAgIHJvb3QgPSBgJHtyb290fSBXSEVSRSAke3RpbWVGaWx0ZXJ9YFxuXHRcdH1cblxuXHRcdGNvbnN0IGdyb3VwQnkgPSB0aGlzLnRhcmdldC5ncm91cEJ5O1xuXHRcdGNvbnN0IGdyb3VwQnlUaW1lID0gZ3JvdXBCeS5maW5kKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLlRpbWUgKTtcblx0XHRjb25zdCBncm91cEJ5RmlsbCA9IGdyb3VwQnkuZmluZCggeCA9PiB4LnR5cGUgPT0gR3JvdXBCeU9wdGlvbi5GaWxsICk7XG4gICAgY29uc3QgZ3JvdXBCeVRhZyA9IGdyb3VwQnkuZmlsdGVyKCB4ID0+IHgudHlwZSA9PSBHcm91cEJ5T3B0aW9uLlRhZyApO1xuICAgIFxuICAgIC8vY29uc29sZS5sb2coIGdyb3VwQnkgKTtcblxuXHRcdGlmKCBncm91cEJ5VGltZSApe1xuICAgICAgY29uc3QgZ2IgPSAoIHRoaXMucmFuZ2UgJiYgZ3JvdXBCeVRpbWUucGFyYW1zWyAwIF0gPT0gTWV0cmljVmFycy5USU1FX0lOVEVSVkFMICkgP1xuICAgICAgICB0aGlzLmdldE9wdGltYWxBdXRvR3JvdXBCeSgpIDogZ3JvdXBCeVRpbWUucGFyYW1zWyAwIF07XG4gICAgICAgIFxuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IEdST1VQIEJZIHRpbWUoJHtnYn0pYFxuXHRcdH1cblxuXHRcdGlmKCBncm91cEJ5VGFnLmxlbmd0aCA+IDAgKXtcblx0XHRcdHJvb3QgPSAoICFncm91cEJ5VGltZSApID8gYCR7cm9vdH0gR1JPVVAgQllgIDogYCR7cm9vdH0sYDsgXG5cblx0XHRcdGdyb3VwQnlUYWcuZm9yRWFjaCggKGUsaW5kZXgpID0+IHtcblx0XHRcdFx0cm9vdCA9IGAke3Jvb3R9JHtpbmRleCA+MCA/ICcsICcgOiAnICd9IFwiJHtlLnBhcmFtc1sgMCBdfVwiYFxuXHRcdFx0fSApXG5cdFx0fVxuXHRcdFxuXHRcdGlmKCBncm91cEJ5RmlsbCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IEZJTEwoJHtncm91cEJ5RmlsbC5wYXJhbXNbIDAgXX0pYFxuXHRcdH1cblxuXHRcdGlmKCB0aGlzLnRhcmdldC5vcmRlciAhPSBPcmRlckJ5VGltZS5Bc2MgKXtcblx0XHRcdHJvb3QgPSBgJHtyb290fSBPUkRFUiBCWSB0aW1lIERFU0NgOyBcblx0XHR9XG5cdFx0XG5cdFx0aWYoIHRoaXMudGFyZ2V0LmxpbWl0ID4gMCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IExJTUlUICR7dGhpcy50YXJnZXQubGltaXR9YDtcblx0XHR9XG5cblx0XHRpZiggdGhpcy50YXJnZXQuc2xpbWl0ID4gMCApe1xuXHRcdFx0cm9vdCA9IGAke3Jvb3R9IFNMSU1JVCAke3RoaXMudGFyZ2V0LnNsaW1pdH1gO1xuXHRcdH1cblxuICAgIHJldHVybiByb290O1xuXHR9XG5cdFxuICBnZXRPcHRpbWFsQXV0b0dyb3VwQnkoKSA6IHN0cmluZyB7XG4gICAgY29uc3QgZiA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKCB0aGlzLnJhbmdlLmZyb20sIGZhbHNlICk7XG4gICAgY29uc3QgdCA9IFRpbWVSYW5nZVBhcnNlci50b0RhdGVUaW1lKCB0aGlzLnJhbmdlLnRvLCB0cnVlICk7XG5cblx0XHRpZiAoNSA+ICt0LmRpZmYoIGYsIFwibWludXRlc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyMDBtc1wiO1xuXG5cdFx0aWYgKDE1ID4gK3QuZGlmZiggZiwgXCJtaW51dGVzXCIgKSlcblx0XHRcdHJldHVybiBcIjFzXCI7XG5cblx0XHRpZiAoMzAgPiB0LmRpZmYoIGYsIFwibWludXRlc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyc1wiO1xuXG5cdFx0aWYgKDEgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiNXNcIjtcdFx0XG5cblx0XHRpZiAoMyA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIxMHNcIjtcdFx0XG5cblx0XHRpZiAoNiA+IHQuZGlmZiggZiwgXCJob3Vyc1wiICkpXG5cdFx0XHRyZXR1cm4gXCIyMHNcIjtcdFx0XG5cblx0XHRpZiAoMTIgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMW1cIjtcdFx0XG5cblx0XHRpZiAoMjQgPiB0LmRpZmYoIGYsIFwiaG91cnNcIiApKVxuXHRcdFx0cmV0dXJuIFwiMm1cIjtcdFx0XG5cblx0XHRpZiAoNyA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjEwbVwiO1x0XHRcblxuXHRcdGlmICgzMSA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjFoXCI7XHRcdFxuXG5cdFx0aWYgKDM2NSA+IHQuZGlmZiggZiwgXCJkYXlzXCIgKSlcblx0XHRcdHJldHVybiBcIjEyaFwiO1x0XHRcblxuXHRcdCByZXR1cm4gXCIyNGhcIjtcblx0fVxuXG4gIGdldFRpbWVGaWx0ZXIoKSB7XG4gICAgY29uc3QgcmFuZ2UgPSB0aGlzLnJhbmdlO1xuICAgIGNvbnN0IHR6ID0gdGhpcy50aW1lLmNvbnZlcnRlci50aW1lem9uZTsgLy90aGlzLnJhbmdlLnRpbWV6b25lO1xuXG4gICAgbGV0IGZyb20gPSB0aGlzLmdldEluZmx1eFRpbWUoIHJhbmdlLmZyb20sIGZhbHNlLCB0eik7XG4gICAgbGV0IHRvID0gdGhpcy5nZXRJbmZsdXhUaW1lKCByYW5nZS50bywgdHJ1ZSwgdHopO1xuXG4gICAgY29uc3QgZnJvbUlzQWJzb2x1dGUgPSBmcm9tW2Zyb20ubGVuZ3RoIC0gMV0gPT09ICdtcyc7XG5cbiAgICBpZiAodG8gPT09ICdub3coKScgJiYgIWZyb21Jc0Fic29sdXRlKSB7XG4gICAgICByZXR1cm4gJ3RpbWUgPj0gJyArIGZyb207XG4gICAgfVxuXG4gICAgcmV0dXJuICd0aW1lID49ICcgKyBmcm9tICsgJyBhbmQgdGltZSA8PSAnICsgdG87XG5cdH1cblx0XG4gIGdldEluZmx1eFRpbWUoZGF0ZTogYW55LCByb3VuZFVwOiBhbnksIHRpbWV6b25lOiBUaW1lem9uZSkge1xuICAgIGlmIChfLmlzU3RyaW5nKGRhdGUpKSB7XG4gICAgICBpZiAoZGF0ZSA9PT0gJ25vdycpIHtcbiAgICAgICAgcmV0dXJuICdub3coKSc7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBhcnRzID0gL15ub3ctKFxcZCspKFtkaG1zXSkkLy5leGVjKGRhdGUpO1xuXG4gICAgICBpZiAocGFydHMpIHtcbiAgICAgICAgY29uc3QgYW1vdW50ID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTtcbiAgICAgICAgY29uc3QgdW5pdCA9IHBhcnRzWzJdO1xuICAgICAgICByZXR1cm4gJ25vdygpIC0gJyArIGFtb3VudCArIHVuaXQ7XG4gICAgICB9XG5cbiAgICAgIGRhdGUgPSBUaW1lUmFuZ2VQYXJzZXIudG9EYXRlVGltZShkYXRlLCByb3VuZFVwLCB0aW1lem9uZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGUudmFsdWVPZigpICsgJ21zJztcbiAgfVxufSJdfQ==