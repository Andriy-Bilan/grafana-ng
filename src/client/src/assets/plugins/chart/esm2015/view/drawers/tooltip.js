import { Moment } from 'common';
import { TooltipSortOrder } from '../../chart.m';
import { ColorHelper } from 'uilib';
import { AxisUnitHelper } from '../helpers/unit-helper';
export class TooltipBuilder {
    constructor(model, component) {
        this.model = model;
        this.component = component;
        this.ID = "chartjs-tooltip";
        this.TOOLTIP_SELECTOR = "ed-tooltip";
    }
    static build(comp) {
        Chart.Tooltip.positioners.custom = (_, event) => {
            return {
                x: event.x,
                y: event.y
            };
        };
        return {
            mode: 'index',
            position: "custom",
            axis: 'x',
            intersect: false,
            caretSize: 0,
            xPadding: 10,
            bodySpacing: 5,
            titleAlign: 'right',
            enabled: false,
            custom: (model) => new TooltipBuilder(model, comp).create()
        };
    }
    get root() {
        var tooltipEl = document.getElementById(this.ID);
        // Create element on first render
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = this.ID;
            tooltipEl.innerHTML = `<div class='graph-tooltip grafana-tooltip ${this.TOOLTIP_SELECTOR}'></div>`;
            document.body.appendChild(tooltipEl);
        }
        return tooltipEl;
    }
    create() {
        var tooltipElement = this.root;
        // Hide if no tooltip
        if (this.model.opacity === 0 /*|| chart.showAnnotView*/) {
            tooltipElement.style.opacity = '0';
            return;
        }
        tooltipElement.classList.remove('above', 'below', 'no-transform');
        if (this.model.yAlign) {
            tooltipElement.classList.add(this.model.yAlign);
        }
        else {
            tooltipElement.classList.add('no-transform');
        }
        if (this.model.body) {
            this.createBody();
        }
        this.setPosition();
    }
    setPosition() {
        var tooltipElement = this.root;
        const chart = this.component.control.chart;
        var position = chart
            .canvas
            .getBoundingClientRect();
        const elWidth = document
            .getElementsByClassName(this.TOOLTIP_SELECTOR)[0]
            .getBoundingClientRect()
            .width;
        const negMargin = (this.model.caretX + elWidth > position.width) ?
            elWidth + 2 * this.model.xPadding : 0;
        tooltipElement.style.opacity = '1';
        tooltipElement.style.position = 'absolute';
        tooltipElement.style.left = position.left + window.pageXOffset + this.model.caretX - negMargin + 'px';
        tooltipElement.style.top = position.top + window.pageYOffset + this.model.caretY + 'px';
        tooltipElement.style.fontFamily = this.model._bodyFontFamily;
        tooltipElement.style.padding = this.model.yPadding + 'px ' + this.model.xPadding + 'px';
        tooltipElement.style.pointerEvents = 'none';
    }
    createBody() {
        var tooltipElement = this.root;
        var chart = this.component;
        var w = this.component.store.panel.widget;
        var titleLines = this.model.title || [];
        var innerHtml = '';
        titleLines.forEach(function (title) {
            const date = Date.parse(title);
            const time = Moment.format(date);
            innerHtml += `<div class="graph-tooltip-time">${time}</div>`;
        });
        const parsedBodyLines = this.sort();
        parsedBodyLines.forEach((body, i) => {
            const { seriesName, value, color } = body;
            let seriesNameEl = `
				<div class="graph-tooltip-series-name">
					<i class="fa fa-minus" style="color:${color};"></i> ${seriesName}:
				</div>`;
            const ds = chart
                .data
                .datasets
                .find(x => x.label == seriesName);
            const axis = w.axes.leftY; //( ds.yAxisID == 'A' ) ?	w.axes.leftY : w.axes.rightY;
            const decimals = w.legend.decimals ? w.legend.decimals : 1;
            const resValue = AxisUnitHelper.getFormattedValue(value, axis.unit, decimals);
            let valueEl = `<div class="graph-tooltip-value ">${resValue}</div>`;
            let item = `
				<div class="graph-tooltip-list-item">
					${seriesNameEl}
					${valueEl}
				</div>`;
            innerHtml += item;
        });
        var tableRoot = tooltipElement.querySelector(`.${this.TOOLTIP_SELECTOR}`);
        tableRoot.innerHTML = innerHtml;
    }
    sort() {
        function getBody(bodyItem) {
            return bodyItem.lines;
        }
        var bodyLines = this.model.body.map(getBody);
        const sortOrder = this
            .component
            .widget
            .display
            .tooltipSortOrder;
        const parsedBodyLines = [];
        bodyLines.forEach((body, i) => {
            var colors = this.model.labelColors[i];
            var color = ColorHelper.hexToRgbString(colors.backgroundColor);
            let index = body[0].lastIndexOf(':');
            const seriesName = body[0].substring(0, index);
            const value = parseFloat(this.model.dataPoints[i].value);
            parsedBodyLines.push({ seriesName, value, color });
        });
        switch (sortOrder) {
            case TooltipSortOrder.Increasing:
                parsedBodyLines.sort((a, b) => a.value - b.value);
                break;
            case TooltipSortOrder.Decreasing:
                parsedBodyLines.sort((a, b) => b.value - a.value);
                break;
        }
        return parsedBodyLines;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2FwcC9wbHVnaW5zL3dpZGdldHMvY2hhcnQvc3JjL3ZpZXcvZHJhd2Vycy90b29sdGlwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFaEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDcEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBSXhELE1BQU0sT0FBTyxjQUFjO0lBMkMxQixZQUFxQixLQUFLLEVBQVUsU0FBeUI7UUFBeEMsVUFBSyxHQUFMLEtBQUssQ0FBQTtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQWdCO1FBekNwRCxPQUFFLEdBQUcsaUJBQWlCLENBQUM7UUFDdkIscUJBQWdCLEdBQUcsWUFBWSxDQUFDO0lBMEN6QyxDQUFDO0lBeENELE1BQU0sQ0FBQyxLQUFLLENBQUUsSUFBb0I7UUFDakMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQy9DLE9BQU87Z0JBQ04sQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUNWLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQzthQUNWLENBQUM7UUFDSCxDQUFDLENBQUM7UUFFRixPQUFPO1lBQ04sSUFBSSxFQUFFLE9BQU87WUFDYixRQUFRLEVBQUUsUUFBUTtZQUNsQixJQUFJLEVBQUUsR0FBRztZQUNULFNBQVMsRUFBRSxLQUFLO1lBQ2hCLFNBQVMsRUFBRSxDQUFDO1lBQ1osUUFBUSxFQUFFLEVBQUU7WUFDWixXQUFXLEVBQUUsQ0FBQztZQUNkLFVBQVUsRUFBRSxPQUFPO1lBQ25CLE9BQU8sRUFBRSxLQUFLO1lBQ2QsTUFBTSxFQUFFLENBQUUsS0FBSyxFQUFHLEVBQUUsQ0FBQyxJQUFJLGNBQWMsQ0FBRSxLQUFLLEVBQUUsSUFBSSxDQUFFLENBQUMsTUFBTSxFQUFFO1NBQy9ELENBQUE7SUFDRixDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ1AsSUFBSSxTQUFTLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFakQsaUNBQWlDO1FBQ2pDLElBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDZCxTQUFTLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMxQyxTQUFTLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7WUFFdkIsU0FBUyxDQUFDLFNBQVMsR0FBRyw2Q0FBNkMsSUFBSSxDQUFDLGdCQUFnQixVQUFVLENBQUM7WUFFbkcsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDckM7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUNsQixDQUFDO0lBTUQsTUFBTTtRQUNMLElBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFFL0IscUJBQXFCO1FBQ3JCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLDBCQUEwQixFQUFHO1lBQ3pELGNBQWMsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztZQUNuQyxPQUFPO1NBQ1A7UUFFRCxjQUFjLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBRWxFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDdEIsY0FBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoRDthQUFNO1lBQ04sY0FBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7U0FDN0M7UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNsQjtRQUVELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBRU8sV0FBVztRQUNsQixJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRS9CLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUUzQyxJQUFJLFFBQVEsR0FBRyxLQUFLO2FBQ2xCLE1BQU07YUFDTixxQkFBcUIsRUFBRSxDQUFDO1FBRTFCLE1BQU0sT0FBTyxHQUFHLFFBQVE7YUFDdEIsc0JBQXNCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUUsQ0FBQyxDQUFFO2FBQ2xELHFCQUFxQixFQUFFO2FBQ3ZCLEtBQUssQ0FBQztRQUVSLE1BQU0sU0FBUyxHQUFHLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUUsQ0FBQyxDQUFDO1lBQ25FLE9BQU8sR0FBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV4QyxjQUFjLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFDbkMsY0FBYyxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDO1FBQzNDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3RHLGNBQWMsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDeEYsY0FBYyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUM7UUFDN0QsY0FBYyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUN4RixjQUFjLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUM7SUFDN0MsQ0FBQztJQUVPLFVBQVU7UUFDakIsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUMvQixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFFMUMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ3hDLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUVuQixVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVMsS0FBSztZQUNoQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFFLEtBQUssQ0FBRSxDQUFDO1lBQ2pDLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUcsSUFBSSxDQUFFLENBQUM7WUFDcEMsU0FBUyxJQUFJLG1DQUFtQyxJQUFJLFFBQVEsQ0FBQTtRQUM3RCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVwQyxlQUFlLENBQUMsT0FBTyxDQUFFLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3BDLE1BQU0sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQztZQUUxQyxJQUFJLFlBQVksR0FBRzs7MkNBRXFCLEtBQUssV0FBVyxVQUFVO1dBQzFELENBQUE7WUFFUixNQUFNLEVBQUUsR0FBRyxLQUFLO2lCQUNkLElBQUk7aUJBQ0osUUFBUTtpQkFDUixJQUFJLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBRSxDQUFDO1lBRXJDLE1BQU0sSUFBSSxHQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUEsdURBQXVEO1lBRWxGLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTNELE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUUsQ0FBQTtZQUUvRSxJQUFJLE9BQU8sR0FBRyxxQ0FBcUMsUUFBUSxRQUFRLENBQUM7WUFFcEUsSUFBSSxJQUFJLEdBQUc7O09BRVAsWUFBWTtPQUNaLE9BQU87V0FDSCxDQUFBO1lBRVIsU0FBUyxJQUFJLElBQUksQ0FBQztRQUNuQixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksU0FBUyxHQUFHLGNBQWMsQ0FBQyxhQUFhLENBQUMsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBQzFFLFNBQVMsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQ2pDLENBQUM7SUFFTyxJQUFJO1FBQ1gsU0FBUyxPQUFPLENBQUMsUUFBUTtZQUN4QixPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFDdkIsQ0FBQztRQUVELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU3QyxNQUFNLFNBQVMsR0FBRyxJQUFJO2FBQ3BCLFNBQVM7YUFDVCxNQUFNO2FBQ04sT0FBTzthQUNQLGdCQUFnQixDQUFDO1FBRW5CLE1BQU0sZUFBZSxHQUFHLEVBQUUsQ0FBQztRQUUzQixTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzdCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFFLENBQUMsQ0FBRSxDQUFDO1lBQ3pDLElBQUksS0FBSyxHQUFHLFdBQVcsQ0FBQyxjQUFjLENBQUUsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBRWhFLElBQUksS0FBSyxHQUFHLElBQUksQ0FBRSxDQUFDLENBQUUsQ0FBQyxXQUFXLENBQUUsR0FBRyxDQUFFLENBQUM7WUFDekMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFFLENBQUMsQ0FBRSxDQUFDLFNBQVMsQ0FBRSxDQUFDLEVBQUUsS0FBSyxDQUFFLENBQUM7WUFDbkQsTUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFFLENBQUMsQ0FBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNELGVBQWUsQ0FBQyxJQUFJLENBQUUsRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBQyxDQUFFLENBQUM7UUFDcEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxRQUFRLFNBQVMsRUFBRTtZQUNsQixLQUFLLGdCQUFnQixDQUFDLFVBQVU7Z0JBQy9CLGVBQWUsQ0FBQyxJQUFJLENBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkQsTUFBTTtZQUVQLEtBQUssZ0JBQWdCLENBQUMsVUFBVTtnQkFDL0IsZUFBZSxDQUFDLElBQUksQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuRCxNQUFNO1NBQ1A7UUFFRCxPQUFPLGVBQWUsQ0FBQztJQUN4QixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb21lbnQgfSBmcm9tICdjb21tb24nO1xyXG5pbXBvcnQgeyBDaGFydENvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NoYXJ0LmMnO1xyXG5pbXBvcnQgeyBUb29sdGlwU29ydE9yZGVyIH0gZnJvbSAnLi4vLi4vY2hhcnQubSc7XHJcbmltcG9ydCB7IENvbG9ySGVscGVyIH0gZnJvbSAndWlsaWInO1xyXG5pbXBvcnQgeyBBeGlzVW5pdEhlbHBlciB9IGZyb20gJy4uL2hlbHBlcnMvdW5pdC1oZWxwZXInO1xyXG5cclxuZGVjbGFyZSB2YXIgQ2hhcnQ6IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBUb29sdGlwQnVpbGRlciB7XHJcblxyXG5cdHJlYWRvbmx5IElEID0gXCJjaGFydGpzLXRvb2x0aXBcIjtcclxuXHRyZWFkb25seSBUT09MVElQX1NFTEVDVE9SID0gXCJlZC10b29sdGlwXCI7XHJcblxyXG5cdHN0YXRpYyBidWlsZCggY29tcDogQ2hhcnRDb21wb25lbnQgKXtcclxuXHRcdENoYXJ0LlRvb2x0aXAucG9zaXRpb25lcnMuY3VzdG9tID0gKF8sIGV2ZW50KSA9PiB7XHJcblx0XHRcdHJldHVybiB7XHJcblx0XHRcdFx0eDogZXZlbnQueCxcclxuXHRcdFx0XHR5OiBldmVudC55XHJcblx0XHRcdH07XHJcblx0XHR9O1xyXG5cclxuXHRcdHJldHVybiB7XHJcblx0XHRcdG1vZGU6ICdpbmRleCcsXHJcblx0XHRcdHBvc2l0aW9uOiBcImN1c3RvbVwiLFxyXG5cdFx0XHRheGlzOiAneCcsXHJcblx0XHRcdGludGVyc2VjdDogZmFsc2UsXHJcblx0XHRcdGNhcmV0U2l6ZTogMCxcclxuXHRcdFx0eFBhZGRpbmc6IDEwLFxyXG5cdFx0XHRib2R5U3BhY2luZzogNSxcclxuXHRcdFx0dGl0bGVBbGlnbjogJ3JpZ2h0JyxcclxuXHRcdFx0ZW5hYmxlZDogZmFsc2UsXHJcblx0XHRcdGN1c3RvbTogKCBtb2RlbCApID0+IG5ldyBUb29sdGlwQnVpbGRlciggbW9kZWwsIGNvbXAgKS5jcmVhdGUoKVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Z2V0IHJvb3QoKXtcclxuXHRcdHZhciB0b29sdGlwRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLklEKTtcclxuXHJcblx0XHQvLyBDcmVhdGUgZWxlbWVudCBvbiBmaXJzdCByZW5kZXJcclxuXHRcdGlmKCF0b29sdGlwRWwpIHtcclxuXHRcdFx0dG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcblx0XHRcdHRvb2x0aXBFbC5pZCA9IHRoaXMuSUQ7XHJcblxyXG5cdFx0XHR0b29sdGlwRWwuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9J2dyYXBoLXRvb2x0aXAgZ3JhZmFuYS10b29sdGlwICR7dGhpcy5UT09MVElQX1NFTEVDVE9SfSc+PC9kaXY+YDtcclxuXHJcblx0XHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodG9vbHRpcEVsKTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gdG9vbHRpcEVsO1xyXG5cdH1cclxuXHJcblx0Y29uc3RydWN0b3IoIHByaXZhdGUgbW9kZWwsIHByaXZhdGUgY29tcG9uZW50OiBDaGFydENvbXBvbmVudCApe1xyXG5cclxuXHR9XHJcblxyXG5cdGNyZWF0ZSgpe1xyXG5cdFx0dmFyIHRvb2x0aXBFbGVtZW50ID0gdGhpcy5yb290O1xyXG5cclxuXHRcdC8vIEhpZGUgaWYgbm8gdG9vbHRpcFxyXG5cdFx0aWYoIHRoaXMubW9kZWwub3BhY2l0eSA9PT0gMCAvKnx8IGNoYXJ0LnNob3dBbm5vdFZpZXcqLyApIHtcclxuXHRcdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUub3BhY2l0eSA9ICcwJztcclxuXHRcdFx0cmV0dXJuO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRvb2x0aXBFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2Fib3ZlJywgJ2JlbG93JywgJ25vLXRyYW5zZm9ybScpO1xyXG5cdFx0XHJcblx0XHRpZiAodGhpcy5tb2RlbC55QWxpZ24pIHtcclxuXHRcdFx0dG9vbHRpcEVsZW1lbnQuY2xhc3NMaXN0LmFkZCh0aGlzLm1vZGVsLnlBbGlnbik7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHR0b29sdGlwRWxlbWVudC5jbGFzc0xpc3QuYWRkKCduby10cmFuc2Zvcm0nKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAodGhpcy5tb2RlbC5ib2R5KSB7XHJcblx0XHRcdHRoaXMuY3JlYXRlQm9keSgpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMuc2V0UG9zaXRpb24oKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0UG9zaXRpb24oKXtcclxuXHRcdHZhciB0b29sdGlwRWxlbWVudCA9IHRoaXMucm9vdDtcclxuXHRcdFxyXG5cdFx0Y29uc3QgY2hhcnQgPSB0aGlzLmNvbXBvbmVudC5jb250cm9sLmNoYXJ0O1xyXG5cclxuXHRcdHZhciBwb3NpdGlvbiA9IGNoYXJ0XHJcblx0XHRcdC5jYW52YXNcclxuXHRcdFx0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG5cclxuXHRcdGNvbnN0IGVsV2lkdGggPSBkb2N1bWVudFxyXG5cdFx0XHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSh0aGlzLlRPT0xUSVBfU0VMRUNUT1IpWyAwIF1cclxuXHRcdFx0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXHJcblx0XHRcdC53aWR0aDtcclxuXHJcblx0XHRjb25zdCBuZWdNYXJnaW4gPSAoIHRoaXMubW9kZWwuY2FyZXRYICsgZWxXaWR0aCA+IHBvc2l0aW9uLndpZHRoICkgP1xyXG5cdFx0XHRlbFdpZHRoICsgIDIgKiB0aGlzLm1vZGVsLnhQYWRkaW5nIDogMDtcclxuXHRcdFxyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUub3BhY2l0eSA9ICcxJztcclxuXHRcdHRvb2x0aXBFbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcclxuXHRcdHRvb2x0aXBFbGVtZW50LnN0eWxlLmxlZnQgPSBwb3NpdGlvbi5sZWZ0ICsgd2luZG93LnBhZ2VYT2Zmc2V0ICsgdGhpcy5tb2RlbC5jYXJldFggLSBuZWdNYXJnaW4gKyAncHgnO1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUudG9wID0gcG9zaXRpb24udG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0ICsgdGhpcy5tb2RlbC5jYXJldFkgKyAncHgnO1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IHRoaXMubW9kZWwuX2JvZHlGb250RmFtaWx5O1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUucGFkZGluZyA9IHRoaXMubW9kZWwueVBhZGRpbmcgKyAncHggJyArIHRoaXMubW9kZWwueFBhZGRpbmcgKyAncHgnO1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgY3JlYXRlQm9keSgpe1xyXG5cdFx0dmFyIHRvb2x0aXBFbGVtZW50ID0gdGhpcy5yb290O1xyXG5cdFx0dmFyIGNoYXJ0ID0gdGhpcy5jb21wb25lbnQ7XHJcblx0XHR2YXIgdyA9IHRoaXMuY29tcG9uZW50LnN0b3JlLnBhbmVsLndpZGdldDtcclxuXHJcblx0XHR2YXIgdGl0bGVMaW5lcyA9IHRoaXMubW9kZWwudGl0bGUgfHwgW107XHJcblx0XHR2YXIgaW5uZXJIdG1sID0gJyc7XHJcblxyXG5cdFx0dGl0bGVMaW5lcy5mb3JFYWNoKGZ1bmN0aW9uKHRpdGxlKSB7XHJcblx0XHRcdGNvbnN0IGRhdGUgPSBEYXRlLnBhcnNlKCB0aXRsZSApO1xyXG5cdFx0XHRjb25zdCB0aW1lID0gTW9tZW50LmZvcm1hdCAoIGRhdGUgKTtcclxuXHRcdFx0aW5uZXJIdG1sICs9IGA8ZGl2IGNsYXNzPVwiZ3JhcGgtdG9vbHRpcC10aW1lXCI+JHt0aW1lfTwvZGl2PmBcclxuXHRcdH0pO1xyXG5cclxuXHRcdGNvbnN0IHBhcnNlZEJvZHlMaW5lcyA9IHRoaXMuc29ydCgpO1xyXG5cclxuXHRcdHBhcnNlZEJvZHlMaW5lcy5mb3JFYWNoKCAoYm9keSwgaSkgPT4ge1xyXG5cdFx0XHRjb25zdCB7IHNlcmllc05hbWUsIHZhbHVlLCBjb2xvciB9ID0gYm9keTtcclxuXHJcblx0XHRcdGxldCBzZXJpZXNOYW1lRWwgPSBgXHJcblx0XHRcdFx0PGRpdiBjbGFzcz1cImdyYXBoLXRvb2x0aXAtc2VyaWVzLW5hbWVcIj5cclxuXHRcdFx0XHRcdDxpIGNsYXNzPVwiZmEgZmEtbWludXNcIiBzdHlsZT1cImNvbG9yOiR7Y29sb3J9O1wiPjwvaT4gJHtzZXJpZXNOYW1lfTpcclxuXHRcdFx0XHQ8L2Rpdj5gXHJcblxyXG5cdFx0XHRjb25zdCBkcyA9IGNoYXJ0XHJcblx0XHRcdFx0LmRhdGFcclxuXHRcdFx0XHQuZGF0YXNldHNcclxuXHRcdFx0XHQuZmluZCggeCA9PiB4LmxhYmVsID09IHNlcmllc05hbWUgKTtcclxuXHJcblx0XHRcdGNvbnN0IGF4aXMgPSAgdy5heGVzLmxlZnRZOy8vKCBkcy55QXhpc0lEID09ICdBJyApID9cdHcuYXhlcy5sZWZ0WSA6IHcuYXhlcy5yaWdodFk7XHJcblxyXG5cdFx0XHRjb25zdCBkZWNpbWFscyA9IHcubGVnZW5kLmRlY2ltYWxzID8gdy5sZWdlbmQuZGVjaW1hbHMgOiAxO1xyXG5cclxuXHRcdFx0Y29uc3QgcmVzVmFsdWUgPSBBeGlzVW5pdEhlbHBlci5nZXRGb3JtYXR0ZWRWYWx1ZSggdmFsdWUsIGF4aXMudW5pdCwgZGVjaW1hbHMgKVxyXG5cclxuXHRcdFx0bGV0IHZhbHVlRWwgPSBgPGRpdiBjbGFzcz1cImdyYXBoLXRvb2x0aXAtdmFsdWUgXCI+JHtyZXNWYWx1ZX08L2Rpdj5gO1xyXG5cclxuXHRcdFx0bGV0IGl0ZW0gPSBgXHJcblx0XHRcdFx0PGRpdiBjbGFzcz1cImdyYXBoLXRvb2x0aXAtbGlzdC1pdGVtXCI+XHJcblx0XHRcdFx0XHQke3Nlcmllc05hbWVFbH1cclxuXHRcdFx0XHRcdCR7dmFsdWVFbH1cclxuXHRcdFx0XHQ8L2Rpdj5gXHJcblxyXG5cdFx0XHRpbm5lckh0bWwgKz0gaXRlbTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdHZhciB0YWJsZVJvb3QgPSB0b29sdGlwRWxlbWVudC5xdWVyeVNlbGVjdG9yKGAuJHt0aGlzLlRPT0xUSVBfU0VMRUNUT1J9YCk7XHJcblx0XHR0YWJsZVJvb3QuaW5uZXJIVE1MID0gaW5uZXJIdG1sO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBzb3J0KCkgOiBBcnJheTxhbnk+e1xyXG5cdFx0ZnVuY3Rpb24gZ2V0Qm9keShib2R5SXRlbSkge1xyXG5cdFx0XHRyZXR1cm4gYm9keUl0ZW0ubGluZXM7XHJcblx0XHR9XHJcblxyXG5cdFx0dmFyIGJvZHlMaW5lcyA9IHRoaXMubW9kZWwuYm9keS5tYXAoZ2V0Qm9keSk7XHJcblxyXG5cdFx0Y29uc3Qgc29ydE9yZGVyID0gdGhpc1xyXG5cdFx0XHQuY29tcG9uZW50XHJcblx0XHRcdC53aWRnZXRcclxuXHRcdFx0LmRpc3BsYXlcclxuXHRcdFx0LnRvb2x0aXBTb3J0T3JkZXI7XHJcblxyXG5cdFx0Y29uc3QgcGFyc2VkQm9keUxpbmVzID0gW107XHJcblx0XHRcclxuXHRcdGJvZHlMaW5lcy5mb3JFYWNoKChib2R5LCBpKSA9PiB7XHJcblx0XHRcdHZhciBjb2xvcnMgPSB0aGlzLm1vZGVsLmxhYmVsQ29sb3JzWyBpIF07XHJcblx0XHRcdHZhciBjb2xvciA9IENvbG9ySGVscGVyLmhleFRvUmdiU3RyaW5nKCBjb2xvcnMuYmFja2dyb3VuZENvbG9yKTtcclxuXHJcblx0XHRcdGxldCBpbmRleCA9IGJvZHlbIDAgXS5sYXN0SW5kZXhPZiggJzonICk7XHJcblx0XHRcdGNvbnN0IHNlcmllc05hbWUgPSBib2R5WyAwIF0uc3Vic3RyaW5nKCAwLCBpbmRleCApO1xyXG5cdFx0XHRjb25zdCB2YWx1ZSA9IHBhcnNlRmxvYXQodGhpcy5tb2RlbC5kYXRhUG9pbnRzWyBpIF0udmFsdWUpO1xyXG5cdFx0XHRwYXJzZWRCb2R5TGluZXMucHVzaCgge3Nlcmllc05hbWUsIHZhbHVlLCBjb2xvcn0gKTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdHN3aXRjaCggc29ydE9yZGVyICl7XHJcblx0XHRcdGNhc2UgVG9vbHRpcFNvcnRPcmRlci5JbmNyZWFzaW5nOlxyXG5cdFx0XHRcdHBhcnNlZEJvZHlMaW5lcy5zb3J0KCAoYSwgYikgPT4gYS52YWx1ZSAtIGIudmFsdWUpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSBUb29sdGlwU29ydE9yZGVyLkRlY3JlYXNpbmc6XHJcblx0XHRcdFx0cGFyc2VkQm9keUxpbmVzLnNvcnQoIChhLCBiKSA9PiBiLnZhbHVlIC0gYS52YWx1ZSk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHBhcnNlZEJvZHlMaW5lcztcclxuXHR9XHJcbn1cclxuXHJcblxyXG4iXX0=