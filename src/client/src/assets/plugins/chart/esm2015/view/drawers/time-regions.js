import { Injectable } from '@angular/core';
import { Moment } from 'common';
import { BaseChartExtension } from '../../base/chart-base-extension';
import { TimeRegionColor, TimeRegionDay } from '../../chart.m';
import { OptionsProvider } from '../options-provider';
import * as i0 from "@angular/core";
import * as i1 from "../../base/chart.store";
export class TimeRegionsDrawerPlugin extends BaseChartExtension {
    constructor(store) {
        super(store);
    }
    afterDatasetsDraw(chart, _) {
        var _a, _b;
        (_b = (_a = this
            .widget) === null || _a === void 0 ? void 0 : _a.display) === null || _b === void 0 ? void 0 : _b.timeRegions.forEach(t => new TimeRegionDrawer(chart, t).draw());
    }
}
TimeRegionsDrawerPlugin.ɵfac = function TimeRegionsDrawerPlugin_Factory(t) { return new (t || TimeRegionsDrawerPlugin)(i0.ɵɵinject(i1.ChartStore)); };
TimeRegionsDrawerPlugin.ɵprov = i0.ɵɵdefineInjectable({ token: TimeRegionsDrawerPlugin, factory: TimeRegionsDrawerPlugin.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(TimeRegionsDrawerPlugin, [{
        type: Injectable
    }], function () { return [{ type: i1.ChartStore }]; }, null); })();
class TimeRegionDrawer {
    constructor(chart, timeRegion) {
        this.chart = chart;
        this.timeRegion = timeRegion;
    }
    get context() {
        return this.chart.chart.ctx;
    }
    draw() {
        const scaleX = this.chart.scales[OptionsProvider.AXIS_X];
        const minX = Moment.create(scaleX.min);
        const maxX = Moment.create(scaleX.max);
        this
            .getSpans(minX, maxX)
            .forEach(x => {
            let os = scaleX.getPixelForValue(x.start.toDate());
            let oe = scaleX.getPixelForValue(x.end.toDate());
            if (!(oe < scaleX.left || os > scaleX.right)) {
                os = Math.max(os, scaleX.left);
                oe = Math.min(oe, scaleX.right);
                this.renderRegion(os, oe);
            }
        });
    }
    getSpans(min, max) {
        const borders = this.getSpanBorders(min, max);
        const time = this.getTime();
        return this.isSpecificDayOfWeek() ?
            this.getSpansDayOfWeek(borders, time) :
            this.getSpansAny(borders, time);
    }
    getTime() {
        const isSpecificDayOfWeek = this.isSpecificDayOfWeek();
        let inputFromTime = this.timeRegion.fromTime;
        let inputToTime = this.timeRegion.toTime;
        const timeFormat = "HH:mm";
        let tf = Moment.create(inputFromTime, timeFormat);
        let tt = Moment.create(inputToTime, timeFormat);
        if (!tf.isValid() && !tt.isValid()) {
            if (isSpecificDayOfWeek) {
                const midnight = Moment.create("00:00", timeFormat);
                tf = midnight.clone();
                tt = midnight.clone();
            }
        }
        else if (tf.isValid() && !tt.isValid()) {
            tt = tf.clone();
        }
        else if (!tf.isValid() && tt.isValid()) {
            tf = tt.clone();
        }
        return {
            from: (tf.isValid()) ? tf.toDate() : undefined,
            to: (tt.isValid()) ? tt.toDate() : undefined
        };
    }
    getSpansDayOfWeek(borders, time) {
        const max = borders.to;
        const min = borders.from;
        var current = min.clone();
        var res = [];
        var fromDayName = this.timeRegion.fromDay; //TimeRegionDay[  ]
        var toDayName = this.timeRegion.toDay; //TimeRegionDay[  ];
        while (current < max) {
            var start = current.clone().day(fromDayName);
            var end = start.clone().day(toDayName);
            if (end.isBefore(start)) {
                end.add(1, 'weeks');
            }
            start.set({
                'hour': time.from.getHours(),
                'minute': time.from.getMinutes()
            });
            end.set({
                'hour': time.to.getHours(),
                'minute': time.to.getMinutes()
            });
            res.push({ start, end });
            current.add(1, 'weeks');
        }
        return res;
    }
    getSpansAny(borders, time) {
        const max = borders.to;
        const min = borders.from;
        var current = min.clone();
        var res = [];
        if (!time.from && !time.to) {
            return res;
        }
        while (current < max) {
            var start = current.clone().set({
                'hour': time.from.getHours(),
                'minute': time.from.getMinutes()
            });
            var end = current.clone().set({
                'hour': time.to.getHours(),
                'minute': time.to.getMinutes()
            });
            if (end.isBefore(start)) {
                end.add(1, 'days');
            }
            res.push({ start, end });
            current.add(1, 'days');
        }
        return res;
    }
    getSpanBorders(min, max) {
        const margin = this.isSpecificDayOfWeek() ? 8 : 1;
        const from = min
            .clone()
            .subtract(margin, 'days')
            .startOf('day');
        const to = max
            .clone()
            .add(margin, 'days')
            .endOf('day');
        return { from, to };
    }
    isSpecificDayOfWeek() {
        return (this.timeRegion.fromDay != TimeRegionDay.Any) ||
            (this.timeRegion.toDay != TimeRegionDay.Any);
    }
    renderRegion(offsetStart, offsetEnd) {
        const scaleYA = this.chart.scales[OptionsProvider.AXIS_Y_LEFT];
        const scaleX = this.chart.scales[OptionsProvider.AXIS_X];
        const minY = scaleYA.top;
        const maxY = scaleYA.bottom;
        if (this.timeRegion.line) {
            if (scaleX.left != offsetStart) {
                this.renderLine(minY, maxY, offsetStart);
            }
            if (scaleX.right != offsetEnd && offsetEnd != offsetStart) {
                this.renderLine(minY, maxY, offsetEnd);
            }
        }
        if (this.timeRegion.fill && offsetEnd != offsetStart) {
            this.renderRectangle(minY, maxY, offsetStart, offsetEnd);
        }
    }
    renderLine(minY, maxY, offset) {
        const color = this.getColor(false);
        this.context.beginPath();
        this.context.strokeStyle = color + "99";
        this.context.lineWidth = 2;
        this.context.moveTo(offset, minY);
        this.context.lineTo(offset, maxY);
        this.context.stroke();
    }
    renderRectangle(minY, maxY, offsetStart, offsetEnd) {
        const color = this.getColor(true);
        this.context.fillStyle = color + "22";
        const x = offsetStart;
        const w = offsetEnd - offsetStart;
        const y = minY;
        const h = maxY - minY;
        this.context.fillRect(x, y, w, h);
    }
    getColor(fill) {
        switch (this.timeRegion.colorType) {
            case TimeRegionColor.Red:
                return '#ED2E18';
            case TimeRegionColor.Green:
                return '#10a345';
            case TimeRegionColor.Blue:
                return '#1f78c1';
            case TimeRegionColor.Yellow:
                return '#f79520';
            case TimeRegionColor.Gray:
                return '#fce2de';
        }
        const defaultColor = '#ffffff';
        if (fill) {
            return this.timeRegion.fillColor ? this.timeRegion.fillColor : defaultColor;
        }
        return this.timeRegion.lineColor ? this.timeRegion.lineColor : defaultColor;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1yZWdpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYXBwL3BsdWdpbnMvd2lkZ2V0cy9jaGFydC9zcmMvdmlldy9kcmF3ZXJzL3RpbWUtcmVnaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDaEMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFFckUsT0FBTyxFQUFjLGVBQWUsRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7QUFHdEQsTUFBTSxPQUFPLHVCQUF3QixTQUFRLGtCQUFrQjtJQVU5RCxZQUFhLEtBQWlCO1FBQzdCLEtBQUssQ0FBRSxLQUFLLENBQUUsQ0FBQztJQUNoQixDQUFDO0lBVkQsaUJBQWlCLENBQUMsS0FBSyxFQUFFLENBQUM7O1FBQ3pCLFlBQUEsSUFBSTthQUNGLE1BQU0sMENBQ0wsT0FBTywwQ0FDUCxXQUFXLENBQ1osT0FBTyxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxnQkFBZ0IsQ0FBRSxLQUFLLEVBQUUsQ0FBQyxDQUFFLENBQUMsSUFBSSxFQUFFLEVBQUc7SUFDM0QsQ0FBQzs7OEZBUlcsdUJBQXVCOytEQUF2Qix1QkFBdUIsV0FBdkIsdUJBQXVCO2tEQUF2Qix1QkFBdUI7Y0FEbkMsVUFBVTs7QUFnQlgsTUFBTSxnQkFBZ0I7SUFNckIsWUFBcUIsS0FBVSxFQUFVLFVBQXNCO1FBQTFDLFVBQUssR0FBTCxLQUFLLENBQUs7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO0lBRS9ELENBQUM7SUFORCxJQUFJLE9BQU87UUFDVixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdB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TUFBTTtnQkFDMUIsT0FBTyxTQUFTLENBQUM7WUFFbEIsS0FBSyxlQUFlLENBQUMsSUFBSTtnQkFDeEIsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFFRCxNQUFNLFlBQVksR0FBRyxTQUFTLENBQUM7UUFFL0IsSUFBSSxJQUFJLEVBQUU7WUFDVCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDO1NBQzVFO1FBRUQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztJQUM3RSxDQUFDO0NBR0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1vbWVudCB9IGZyb20gJ2NvbW1vbic7XHJcbmltcG9ydCB7IEJhc2VDaGFydEV4dGVuc2lvbiB9IGZyb20gJy4uLy4uL2Jhc2UvY2hhcnQtYmFzZS1leHRlbnNpb24nO1xyXG5pbXBvcnQgeyBDaGFydFN0b3JlIH0gZnJvbSAnLi4vLi4vYmFzZS9jaGFydC5zdG9yZSc7XHJcbmltcG9ydCB7IFRpbWVSZWdpb24sIFRpbWVSZWdpb25Db2xvciwgVGltZVJlZ2lvbkRheSB9IGZyb20gJy4uLy4uL2NoYXJ0Lm0nO1xyXG5pbXBvcnQgeyBPcHRpb25zUHJvdmlkZXIgfSBmcm9tICcuLi9vcHRpb25zLXByb3ZpZGVyJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFRpbWVSZWdpb25zRHJhd2VyUGx1Z2luIGV4dGVuZHMgQmFzZUNoYXJ0RXh0ZW5zaW9uIHtcclxuXHJcblx0YWZ0ZXJEYXRhc2V0c0RyYXcoY2hhcnQsIF8pIHtcclxuXHRcdHRoaXNcclxuXHRcdFx0LndpZGdldFxyXG5cdFx0XHQ/LmRpc3BsYXlcclxuXHRcdFx0Py50aW1lUmVnaW9uc1xyXG5cdFx0XHQuZm9yRWFjaCggdCA9PiBuZXcgVGltZVJlZ2lvbkRyYXdlciggY2hhcnQsIHQgKS5kcmF3KCkgKTtcclxuXHR9XHJcblxyXG5cdGNvbnN0cnVjdG9yKCBzdG9yZTogQ2hhcnRTdG9yZSApe1xyXG5cdFx0c3VwZXIoIHN0b3JlICk7XHJcblx0fVxyXG59XHJcblxyXG5jbGFzcyBUaW1lUmVnaW9uRHJhd2Vye1xyXG5cclxuXHRnZXQgY29udGV4dCgpe1xyXG5cdFx0cmV0dXJuIHRoaXMuY2hhcnQuY2hhcnQuY3R4O1xyXG5cdH1cclxuXHJcblx0Y29uc3RydWN0b3IoIHByaXZhdGUgY2hhcnQ6IGFueSwgcHJpdmF0ZSB0aW1lUmVnaW9uOiBUaW1lUmVnaW9uICl7XHJcblx0XHRcclxuXHR9XHJcblx0XHJcblx0ZHJhdygpe1xyXG5cdFx0Y29uc3Qgc2NhbGVYID0gdGhpcy5jaGFydC5zY2FsZXNbIE9wdGlvbnNQcm92aWRlci5BWElTX1ggXTtcclxuXHJcblx0XHRjb25zdCBtaW5YID0gTW9tZW50LmNyZWF0ZSggc2NhbGVYLm1pbiApO1xyXG5cdFx0Y29uc3QgbWF4WCA9IE1vbWVudC5jcmVhdGUgKCBzY2FsZVgubWF4ICk7XHJcblxyXG5cdFx0dGhpc1xyXG5cdFx0XHQuZ2V0U3BhbnMoIG1pblgsIG1heFggKVxyXG5cdFx0XHQuZm9yRWFjaCggeCA9PiB7XHJcblx0XHRcdFx0bGV0IG9zID0gc2NhbGVYLmdldFBpeGVsRm9yVmFsdWUoeC5zdGFydC50b0RhdGUoKSk7XHJcblx0XHRcdFx0bGV0IG9lID0gc2NhbGVYLmdldFBpeGVsRm9yVmFsdWUoeC5lbmQudG9EYXRlKCkpO1xyXG5cclxuXHRcdFx0XHRpZighICggb2UgPCAgc2NhbGVYLmxlZnQgfHwgb3MgPiBzY2FsZVgucmlnaHQgKSApe1xyXG5cdFx0XHRcdFx0b3MgPSBNYXRoLm1heCggb3MsIHNjYWxlWC5sZWZ0ICk7XHJcblx0XHRcdFx0XHRvZSA9IE1hdGgubWluKCBvZSwgc2NhbGVYLnJpZ2h0ICk7XHJcblxyXG5cdFx0XHRcdFx0dGhpcy5yZW5kZXJSZWdpb24oIG9zLCBvZSApO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSApXHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGdldFNwYW5zKCBtaW4sIG1heCApe1xyXG5cdFx0Y29uc3QgYm9yZGVycyA9IHRoaXMuZ2V0U3BhbkJvcmRlcnMoIG1pbiwgbWF4ICk7XHJcblx0XHRjb25zdCB0aW1lID0gdGhpcy5nZXRUaW1lKCk7XHJcblxyXG5cdFx0cmV0dXJuIHRoaXMuaXNTcGVjaWZpY0RheU9mV2VlaygpID8gXHJcblx0XHRcdHRoaXMuZ2V0U3BhbnNEYXlPZldlZWsoIGJvcmRlcnMsIHRpbWUgKSA6IFxyXG5cdFx0XHR0aGlzLmdldFNwYW5zQW55KCBib3JkZXJzLCB0aW1lIClcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0VGltZSgpe1xyXG5cdFx0Y29uc3QgaXNTcGVjaWZpY0RheU9mV2VlayA9IHRoaXMuaXNTcGVjaWZpY0RheU9mV2VlaygpO1xyXG5cclxuXHRcdGxldCBpbnB1dEZyb21UaW1lID0gdGhpcy50aW1lUmVnaW9uLmZyb21UaW1lO1xyXG5cdFx0bGV0IGlucHV0VG9UaW1lID0gdGhpcy50aW1lUmVnaW9uLnRvVGltZTtcclxuXHJcblx0XHRjb25zdCB0aW1lRm9ybWF0ID0gXCJISDptbVwiO1xyXG5cclxuXHRcdGxldCB0ZiA9IE1vbWVudC5jcmVhdGUoaW5wdXRGcm9tVGltZSwgdGltZUZvcm1hdCk7XHJcblx0XHRsZXQgdHQgPSBNb21lbnQuY3JlYXRlKGlucHV0VG9UaW1lLCB0aW1lRm9ybWF0KTtcclxuXHJcblx0XHRpZiggIXRmLmlzVmFsaWQoKSAmJiAhdHQuaXNWYWxpZCgpICl7XHJcblx0XHRcdGlmKCBpc1NwZWNpZmljRGF5T2ZXZWVrICl7XHJcblx0XHRcdFx0Y29uc3QgbWlkbmlnaHQgPSBNb21lbnQuY3JlYXRlKCBcIjAwOjAwXCIsIHRpbWVGb3JtYXQgKTtcclxuXHRcdFx0XHR0ZiA9IG1pZG5pZ2h0LmNsb25lKCk7XHJcblx0XHRcdFx0dHQgPSBtaWRuaWdodC5jbG9uZSgpO1xyXG5cdFx0XHR9XHJcblx0XHR9IGVsc2UgaWYoIHRmLmlzVmFsaWQoKSAmJiAhdHQuaXNWYWxpZCgpICl7XHJcblx0XHRcdHR0ID0gdGYuY2xvbmUoKTtcclxuXHRcdH0gZWxzZSBpZiggIXRmLmlzVmFsaWQoKSAmJiB0dC5pc1ZhbGlkKCkgKXtcclxuXHRcdFx0dGYgPSB0dC5jbG9uZSgpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB7XHJcblx0XHRcdGZyb206ICggdGYuaXNWYWxpZCgpICkgPyB0Zi50b0RhdGUoKSA6IHVuZGVmaW5lZCxcclxuXHRcdFx0dG86ICggdHQuaXNWYWxpZCgpICkgPyB0dC50b0RhdGUoKSA6IHVuZGVmaW5lZFxyXG5cdFx0fVxyXG5cdH1cclxuXHRwcml2YXRlIGdldFNwYW5zRGF5T2ZXZWVrKCBib3JkZXJzLCB0aW1lICl7XHJcblx0XHRjb25zdCBtYXggPSBib3JkZXJzLnRvO1xyXG5cdFx0Y29uc3QgbWluID0gYm9yZGVycy5mcm9tO1xyXG5cclxuXHRcdHZhciBjdXJyZW50ID0gbWluLmNsb25lKCk7XHJcblx0XHR2YXIgcmVzID0gW107XHJcblxyXG5cdFx0dmFyIGZyb21EYXlOYW1lID0gdGhpcy50aW1lUmVnaW9uLmZyb21EYXk7Ly9UaW1lUmVnaW9uRGF5WyAgXVxyXG5cdFx0dmFyIHRvRGF5TmFtZSA9IHRoaXMudGltZVJlZ2lvbi50b0RheTsvL1RpbWVSZWdpb25EYXlbICBdO1xyXG5cdFx0XHJcblx0XHR3aGlsZSggY3VycmVudCA8IG1heCApe1xyXG5cdFx0XHR2YXIgc3RhcnQgPSBjdXJyZW50LmNsb25lKCkuZGF5KCBmcm9tRGF5TmFtZSApO1xyXG5cdFx0XHR2YXIgZW5kID0gc3RhcnQuY2xvbmUoKS5kYXkoIHRvRGF5TmFtZSApO1xyXG5cdFxyXG5cdFx0XHRpZiggZW5kLmlzQmVmb3JlKCBzdGFydCApICl7XHJcblx0XHRcdFx0ZW5kLmFkZCggMSwgJ3dlZWtzJyApXHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHN0YXJ0LnNldCh7XHJcblx0XHRcdFx0J2hvdXInIDogdGltZS5mcm9tLmdldEhvdXJzKCksXHJcblx0XHRcdFx0J21pbnV0ZScgIDogdGltZS5mcm9tLmdldE1pbnV0ZXMoKVxyXG5cdFx0XHQgfSk7XHJcblxyXG5cdFx0XHRlbmQuc2V0KHtcclxuXHRcdFx0XHQnaG91cicgOiB0aW1lLnRvLmdldEhvdXJzKCksXHJcblx0XHRcdFx0J21pbnV0ZScgIDogdGltZS50by5nZXRNaW51dGVzKClcclxuXHRcdFx0IH0pO1xyXG5cclxuXHRcdFx0cmVzLnB1c2goIHsgc3RhcnQsIGVuZCB9IClcclxuXHRcclxuXHRcdFx0Y3VycmVudC5hZGQoIDEsICd3ZWVrcycgKTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gcmVzO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRTcGFuc0FueSggYm9yZGVycywgdGltZSApe1xyXG5cdFx0Y29uc3QgbWF4ID0gYm9yZGVycy50bztcclxuXHRcdGNvbnN0IG1pbiA9IGJvcmRlcnMuZnJvbTtcclxuXHJcblx0XHR2YXIgY3VycmVudCA9IG1pbi5jbG9uZSgpO1xyXG5cdFx0dmFyIHJlcyA9IFtdO1xyXG5cclxuXHRcdGlmKCAhdGltZS5mcm9tICYmICF0aW1lLnRvICl7XHJcblx0XHRcdHJldHVybiByZXM7XHJcblx0XHR9XHJcblxyXG5cdFx0d2hpbGUoIGN1cnJlbnQgPCBtYXggKXtcclxuXHRcdFx0dmFyIHN0YXJ0ID0gY3VycmVudC5jbG9uZSgpLnNldCh7XHJcblx0XHRcdFx0J2hvdXInIDogdGltZS5mcm9tLmdldEhvdXJzKCksXHJcblx0XHRcdFx0J21pbnV0ZScgIDogdGltZS5mcm9tLmdldE1pbnV0ZXMoKVxyXG5cdFx0XHQgfSk7XHJcblx0XHJcblx0XHRcdHZhciBlbmQgPSBjdXJyZW50LmNsb25lKCkuc2V0KHtcclxuXHRcdFx0XHQnaG91cicgOiB0aW1lLnRvLmdldEhvdXJzKCksXHJcblx0XHRcdFx0J21pbnV0ZScgIDogdGltZS50by5nZXRNaW51dGVzKClcclxuXHRcdFx0IH0pO1xyXG5cclxuXHRcdFx0aWYoIGVuZC5pc0JlZm9yZSggc3RhcnQgKSApe1xyXG5cdFx0XHRcdGVuZC5hZGQoIDEsICdkYXlzJyApO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRyZXMucHVzaCggeyBzdGFydCwgZW5kIH0gKVxyXG5cdFxyXG5cdFx0XHRjdXJyZW50LmFkZCggMSwgJ2RheXMnICk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHJlcztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0U3BhbkJvcmRlcnMoIG1pbiwgbWF4ICl7XHJcblx0XHRjb25zdCBtYXJnaW4gPSB0aGlzLmlzU3BlY2lmaWNEYXlPZldlZWsoKSA/IDggOiAxO1xyXG5cclxuXHRcdGNvbnN0IGZyb20gPSBtaW5cclxuXHRcdFx0LmNsb25lKClcclxuXHRcdFx0LnN1YnRyYWN0KCBtYXJnaW4sICdkYXlzJyApXHJcblx0XHRcdC5zdGFydE9mKCAnZGF5JyApO1xyXG5cclxuXHRcdGNvbnN0IHRvID0gbWF4XHJcblx0XHRcdC5jbG9uZSgpXHJcblx0XHRcdC5hZGQoIG1hcmdpbiwgJ2RheXMnIClcclxuXHRcdFx0LmVuZE9mKCAnZGF5JyApO1xyXG5cclxuXHRcdHJldHVybiB7IGZyb20sIHRvIH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgaXNTcGVjaWZpY0RheU9mV2Vlaygpe1xyXG5cdFx0cmV0dXJuICggdGhpcy50aW1lUmVnaW9uLmZyb21EYXkgIT0gVGltZVJlZ2lvbkRheS5BbnkgKSB8fFxyXG5cdFx0XHQoIHRoaXMudGltZVJlZ2lvbi50b0RheSAhPSBUaW1lUmVnaW9uRGF5LkFueSApO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSByZW5kZXJSZWdpb24oIG9mZnNldFN0YXJ0LCBvZmZzZXRFbmQpe1xyXG5cclxuXHRcdGNvbnN0IHNjYWxlWUEgPSB0aGlzLmNoYXJ0LnNjYWxlc1sgT3B0aW9uc1Byb3ZpZGVyLkFYSVNfWV9MRUZUIF07XHJcblx0XHRjb25zdCBzY2FsZVggPSB0aGlzLmNoYXJ0LnNjYWxlc1sgT3B0aW9uc1Byb3ZpZGVyLkFYSVNfWCBdO1xyXG5cclxuXHRcdGNvbnN0IG1pblkgPSBzY2FsZVlBLnRvcDtcclxuXHRcdGNvbnN0IG1heFkgPSBzY2FsZVlBLmJvdHRvbTtcclxuXHJcblx0XHRpZiggdGhpcy50aW1lUmVnaW9uLmxpbmUgKXtcclxuXHRcdFx0aWYoIHNjYWxlWC5sZWZ0ICE9IG9mZnNldFN0YXJ0ICl7XHJcblx0XHRcdFx0dGhpcy5yZW5kZXJMaW5lKCBtaW5ZLCBtYXhZLCBvZmZzZXRTdGFydCApO1xyXG5cdFx0XHR9XHJcblx0XHRcdFxyXG5cdFx0XHRpZiggc2NhbGVYLnJpZ2h0ICE9IG9mZnNldEVuZCAmJiBvZmZzZXRFbmQgIT0gb2Zmc2V0U3RhcnQpe1xyXG5cdFx0XHRcdHRoaXMucmVuZGVyTGluZSggbWluWSwgbWF4WSwgb2Zmc2V0RW5kICk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRpZiggdGhpcy50aW1lUmVnaW9uLmZpbGwgJiYgb2Zmc2V0RW5kICE9IG9mZnNldFN0YXJ0ICApe1xyXG5cdFx0XHR0aGlzLnJlbmRlclJlY3RhbmdsZSggbWluWSwgbWF4WSwgb2Zmc2V0U3RhcnQsIG9mZnNldEVuZCApO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSByZW5kZXJMaW5lKCBtaW5ZLCBtYXhZLCBvZmZzZXQgKXtcclxuXHRcdGNvbnN0IGNvbG9yID0gdGhpcy5nZXRDb2xvciggZmFsc2UgKTtcclxuXHJcblx0XHR0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7XHJcblx0XHR0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvciArIFwiOTlcIjtcclxuXHRcdHRoaXMuY29udGV4dC5saW5lV2lkdGggPSAyO1xyXG5cdFx0dGhpcy5jb250ZXh0Lm1vdmVUbyggb2Zmc2V0LCBtaW5ZICk7XHJcblx0XHR0aGlzLmNvbnRleHQubGluZVRvKCBvZmZzZXQsIG1heFkgKTtcclxuXHRcdHRoaXMuY29udGV4dC5zdHJva2UoKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgcmVuZGVyUmVjdGFuZ2xlKCBtaW5ZLCBtYXhZLCBvZmZzZXRTdGFydCwgb2Zmc2V0RW5kICApe1xyXG5cdFx0Y29uc3QgY29sb3IgPSB0aGlzLmdldENvbG9yKCB0cnVlICk7XHJcblx0XHRcclxuXHRcdHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvciArIFwiMjJcIlxyXG5cclxuXHRcdGNvbnN0IHggPSBvZmZzZXRTdGFydDtcclxuXHRcdGNvbnN0IHcgPSBvZmZzZXRFbmQgLSBvZmZzZXRTdGFydDtcclxuXHJcblx0XHRjb25zdCB5ID0gbWluWTtcclxuXHRcdGNvbnN0IGggPSBtYXhZIC0gbWluWTtcclxuXHJcblx0XHR0aGlzLmNvbnRleHQuZmlsbFJlY3QoIHgsIHksXHR3LCBoICk7XHRcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0Q29sb3IoIGZpbGwpe1xyXG5cdFx0c3dpdGNoKCB0aGlzLnRpbWVSZWdpb24uY29sb3JUeXBlICl7XHJcblx0XHRcdGNhc2UgVGltZVJlZ2lvbkNvbG9yLlJlZDpcclxuXHRcdFx0XHRyZXR1cm4gJyNFRDJFMTgnO1xyXG5cclxuXHRcdFx0Y2FzZSBUaW1lUmVnaW9uQ29sb3IuR3JlZW46XHJcblx0XHRcdFx0cmV0dXJuICcjMTBhMzQ1JztcclxuXHJcblx0XHRcdGNhc2UgVGltZVJlZ2lvbkNvbG9yLkJsdWU6XHJcblx0XHRcdFx0cmV0dXJuICcjMWY3OGMxJztcclxuXHJcblx0XHRcdGNhc2UgVGltZVJlZ2lvbkNvbG9yLlllbGxvdzpcclxuXHRcdFx0XHRyZXR1cm4gJyNmNzk1MjAnO1xyXG5cclxuXHRcdFx0Y2FzZSBUaW1lUmVnaW9uQ29sb3IuR3JheTpcclxuXHRcdFx0XHRyZXR1cm4gJyNmY2UyZGUnO1xyXG5cdFx0fVxyXG5cclxuXHRcdGNvbnN0IGRlZmF1bHRDb2xvciA9ICcjZmZmZmZmJztcclxuXHJcblx0XHRpZiggZmlsbCApe1xyXG5cdFx0XHRyZXR1cm4gdGhpcy50aW1lUmVnaW9uLmZpbGxDb2xvciA/IHRoaXMudGltZVJlZ2lvbi5maWxsQ29sb3IgOiBkZWZhdWx0Q29sb3I7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHRoaXMudGltZVJlZ2lvbi5saW5lQ29sb3IgPyB0aGlzLnRpbWVSZWdpb24ubGluZUNvbG9yIDogZGVmYXVsdENvbG9yO1xyXG5cdH1cclxuXHJcblxyXG59XHJcbiJdfQ==