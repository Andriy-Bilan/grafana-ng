import { Moment } from 'common';
import { TooltipSortOrder } from '../../chart.m';
import { AxisUnitHelper } from '../axes/unit-helper';
import { ColorHelper } from '../render/color-helper';
export class TooltipBuilder {
    constructor(model, component) {
        this.model = model;
        this.component = component;
        this.ID = "chartjs-tooltip";
        this.TOOLTIP_SELECTOR = "ed-tooltip";
    }
    static build(comp) {
        Chart.Tooltip.positioners.custom = (_, event) => {
            return {
                x: event.x,
                y: event.y
            };
        };
        return {
            mode: 'index',
            position: "custom",
            axis: 'x',
            intersect: false,
            caretSize: 0,
            xPadding: 10,
            bodySpacing: 5,
            titleAlign: 'right',
            enabled: false,
            custom: (model) => new TooltipBuilder(model, comp).create()
        };
    }
    get root() {
        var tooltipEl = document.getElementById(this.ID);
        // Create element on first render
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.id = this.ID;
            tooltipEl.innerHTML = `<div class='graph-tooltip grafana-tooltip ${this.TOOLTIP_SELECTOR}'></div>`;
            document.body.appendChild(tooltipEl);
        }
        return tooltipEl;
    }
    create() {
        var tooltipElement = this.root;
        // Hide if no tooltip
        if (this.model.opacity === 0 /*|| chart.showAnnotView*/) {
            tooltipElement.style.opacity = '0';
            return;
        }
        tooltipElement.classList.remove('above', 'below', 'no-transform');
        if (this.model.yAlign) {
            tooltipElement.classList.add(this.model.yAlign);
        }
        else {
            tooltipElement.classList.add('no-transform');
        }
        if (this.model.body) {
            this.createBody();
        }
        this.setPosition();
    }
    setPosition() {
        var tooltipElement = this.root;
        const chart = this.component.control.chart;
        var position = chart
            .canvas
            .getBoundingClientRect();
        const elWidth = document
            .getElementsByClassName(this.TOOLTIP_SELECTOR)[0]
            .getBoundingClientRect()
            .width;
        const negMargin = (this.model.caretX + elWidth > position.width) ?
            elWidth + 2 * this.model.xPadding : 0;
        tooltipElement.style.opacity = '1';
        tooltipElement.style.position = 'absolute';
        tooltipElement.style.left = position.left + window.pageXOffset + this.model.caretX - negMargin + 'px';
        tooltipElement.style.top = position.top + window.pageYOffset + this.model.caretY + 'px';
        tooltipElement.style.fontFamily = this.model._bodyFontFamily;
        tooltipElement.style.padding = this.model.yPadding + 'px ' + this.model.xPadding + 'px';
        tooltipElement.style.pointerEvents = 'none';
    }
    createBody() {
        var tooltipElement = this.root;
        var chart = this.component;
        var w = this.component.store.panel.widget;
        var titleLines = this.model.title || [];
        var innerHtml = '';
        titleLines.forEach(function (title) {
            const date = Date.parse(title);
            const time = Moment.format(date);
            innerHtml += `<div class="graph-tooltip-time">${time}</div>`;
        });
        const parsedBodyLines = this.sort();
        parsedBodyLines.forEach((body, i) => {
            const { seriesName, value, colorFunc } = body;
            let seriesNameEl = `
				<div class="graph-tooltip-series-name">
					<i class="fa fa-minus" style="color:${colorFunc};"></i> ${seriesName}:
				</div>`;
            const ds = chart
                .data
                .datasets
                .find(x => x.label == seriesName);
            const axis = w.axes.leftY; //( ds.yAxisID == 'A' ) ?	w.axes.leftY : w.axes.rightY;
            const decimals = w.legend.decimals ? w.legend.decimals : 1;
            const resValue = AxisUnitHelper.getFormattedValue(value, axis.unit, decimals);
            let valueEl = `<div class="graph-tooltip-value ">${resValue}</div>`;
            let item = `
				<div class="graph-tooltip-list-item">
					${seriesNameEl}
					${valueEl}
				</div>`;
            innerHtml += item;
        });
        var tableRoot = tooltipElement.querySelector(`.${this.TOOLTIP_SELECTOR}`);
        tableRoot.innerHTML = innerHtml;
    }
    sort() {
        function getBody(bodyItem) {
            return bodyItem.lines;
        }
        var bodyLines = this.model.body.map(getBody);
        const sortOrder = this
            .component
            .widget
            .display
            .tooltipSortOrder;
        const parsedBodyLines = [];
        bodyLines.forEach((body, i) => {
            var colors = this.model.labelColors[i];
            var color = ColorHelper.parse(colors.backgroundColor);
            var colorFunc = `rgba(${color.r},${color.g},${color.b},1)`;
            let index = body[0].lastIndexOf(':');
            const seriesName = body[0].substring(0, index);
            const value = parseFloat(this.model.dataPoints[i].value);
            parsedBodyLines.push({ seriesName, value, colorFunc });
        });
        switch (sortOrder) {
            case TooltipSortOrder.Increasing:
                parsedBodyLines.sort((a, b) => a.value - b.value);
                break;
            case TooltipSortOrder.Decreasing:
                parsedBodyLines.sort((a, b) => b.value - a.value);
                break;
        }
        return parsedBodyLines;
    }
}
class TooltipRenderer {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYXBwL3BsdWdpbnMvd2lkZ2V0cy9jaGFydC9zcmMvdmlldy9leHRlbnNpb25zL3Rvb2x0aXAtYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRWhDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBSXJELE1BQU0sT0FBTyxjQUFjO0lBMkMxQixZQUFxQixLQUFLLEVBQVUsU0FBeUI7UUFBeEMsVUFBSyxHQUFMLEtBQUssQ0FBQTtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQWdCO1FBekNwRCxPQUFFLEdBQUcsaUJBQWlCLENBQUM7UUFDdkIscUJBQWdCLEdBQUcsWUFBWSxDQUFDO0lBMEN6QyxDQUFDO0lBeENELE1BQU0sQ0FBQyxLQUFLLENBQUUsSUFBb0I7UUFDakMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQy9DLE9BQU87Z0JBQ04sQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUNWLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQzthQUNWLENBQUM7UUFDSCxDQUFDLENBQUM7UUFFRixPQUFPO1lBQ04sSUFBSSxFQUFFLE9BQU87WUFDYixRQUFRLEVBQUUsUUFBUTtZQUNsQixJQUFJLEVBQUUsR0FBRztZQUNULFNBQVMsRUFBRSxLQUFLO1lBQ2hCLFNBQVMsRUFBRSxDQUFDO1lBQ1osUUFBUSxFQUFFLEVBQUU7WUFDWixXQUFXLEVBQUUsQ0FBQztZQUNkLFVBQVUsRUFBRSxPQUFPO1lBQ25C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LEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkQsTUFBTTtTQUNQO1FBRUQsT0FBTyxlQUFlLENBQUM7SUFDeEIsQ0FBQztDQUNEO0FBRUQsTUFBTSxlQUFlO0NBS3BCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9tZW50IH0gZnJvbSAnY29tbW9uJztcclxuaW1wb3J0IHsgQ2hhcnRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9jaGFydC5jJztcclxuaW1wb3J0IHsgVG9vbHRpcFNvcnRPcmRlciB9IGZyb20gJy4uLy4uL2NoYXJ0Lm0nO1xyXG5pbXBvcnQgeyBBeGlzVW5pdEhlbHBlciB9IGZyb20gJy4uL2F4ZXMvdW5pdC1oZWxwZXInO1xyXG5pbXBvcnQgeyBDb2xvckhlbHBlciB9IGZyb20gJy4uL3JlbmRlci9jb2xvci1oZWxwZXInO1xyXG5cclxuZGVjbGFyZSB2YXIgQ2hhcnQ6IGFueTtcclxuXHJcbmV4cG9ydCBjbGFzcyBUb29sdGlwQnVpbGRlciB7XHJcblxyXG5cdHJlYWRvbmx5IElEID0gXCJjaGFydGpzLXRvb2x0aXBcIjtcclxuXHRyZWFkb25seSBUT09MVElQX1NFTEVDVE9SID0gXCJlZC10b29sdGlwXCI7XHJcblxyXG5cdHN0YXRpYyBidWlsZCggY29tcDogQ2hhcnRDb21wb25lbnQgKXtcclxuXHRcdENoYXJ0LlRvb2x0aXAucG9zaXRpb25lcnMuY3VzdG9tID0gKF8sIGV2ZW50KSA9PiB7XHJcblx0XHRcdHJldHVybiB7XHJcblx0XHRcdFx0eDogZXZlbnQueCxcclxuXHRcdFx0XHR5OiBldmVudC55XHJcblx0XHRcdH07XHJcblx0XHR9O1xyXG5cclxuXHRcdHJldHVybiB7XHJcblx0XHRcdG1vZGU6ICdpbmRleCcsXHJcblx0XHRcdHBvc2l0aW9uOiBcImN1c3RvbVwiLFxyXG5cdFx0XHRheGlzOiAneCcsXHJcblx0XHRcdGludGVyc2VjdDogZmFsc2UsXHJcblx0XHRcdGNhcmV0U2l6ZTogMCxcclxuXHRcdFx0eFBhZGRpbmc6IDEwLFxyXG5cdFx0XHRib2R5U3BhY2luZzogNSxcclxuXHRcdFx0dGl0bGVBbGlnbjogJ3JpZ2h0JyxcclxuXHRcdFx0ZW5hYmxlZDogZmFsc2UsXHJcblx0XHRcdGN1c3RvbTogKCBtb2RlbCApID0+IG5ldyBUb29sdGlwQnVpbGRlciggbW9kZWwsIGNvbXAgKS5jcmVhdGUoKVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Z2V0IHJvb3QoKXtcclxuXHRcdHZhciB0b29sdGlwRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLklEKTtcclxuXHJcblx0XHQvLyBDcmVhdGUgZWxlbWVudCBvbiBmaXJzdCByZW5kZXJcclxuXHRcdGlmKCF0b29sdGlwRWwpIHtcclxuXHRcdFx0dG9vbHRpcEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcblx0XHRcdHRvb2x0aXBFbC5pZCA9IHRoaXMuSUQ7XHJcblxyXG5cdFx0XHR0b29sdGlwRWwuaW5uZXJIVE1MID0gYDxkaXYgY2xhc3M9J2dyYXBoLXRvb2x0aXAgZ3JhZmFuYS10b29sdGlwICR7dGhpcy5UT09MVElQX1NFTEVDVE9SfSc+PC9kaXY+YDtcclxuXHJcblx0XHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodG9vbHRpcEVsKTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gdG9vbHRpcEVsO1xyXG5cdH1cclxuXHJcblx0Y29uc3RydWN0b3IoIHByaXZhdGUgbW9kZWwsIHByaXZhdGUgY29tcG9uZW50OiBDaGFydENvbXBvbmVudCApe1xyXG5cclxuXHR9XHJcblxyXG5cdGNyZWF0ZSgpe1xyXG5cdFx0dmFyIHRvb2x0aXBFbGVtZW50ID0gdGhpcy5yb290O1xyXG5cclxuXHRcdC8vIEhpZGUgaWYgbm8gdG9vbHRpcFxyXG5cdFx0aWYoIHRoaXMubW9kZWwub3BhY2l0eSA9PT0gMCAvKnx8IGNoYXJ0LnNob3dBbm5vdFZpZXcqLyApIHtcclxuXHRcdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUub3BhY2l0eSA9ICcwJztcclxuXHRcdFx0cmV0dXJuO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRvb2x0aXBFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2Fib3ZlJywgJ2JlbG93JywgJ25vLXRyYW5zZm9ybScpO1xyXG5cdFx0XHJcblx0XHRpZiAodGhpcy5tb2RlbC55QWxpZ24pIHtcclxuXHRcdFx0dG9vbHRpcEVsZW1lbnQuY2xhc3NMaXN0LmFkZCh0aGlzLm1vZGVsLnlBbGlnbik7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHR0b29sdGlwRWxlbWVudC5jbGFzc0xpc3QuYWRkKCduby10cmFuc2Zvcm0nKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAodGhpcy5tb2RlbC5ib2R5KSB7XHJcblx0XHRcdHRoaXMuY3JlYXRlQm9keSgpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMuc2V0UG9zaXRpb24oKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0UG9zaXRpb24oKXtcclxuXHRcdHZhciB0b29sdGlwRWxlbWVudCA9IHRoaXMucm9vdDtcclxuXHRcdFxyXG5cdFx0Y29uc3QgY2hhcnQgPSB0aGlzLmNvbXBvbmVudC5jb250cm9sLmNoYXJ0O1xyXG5cclxuXHRcdHZhciBwb3NpdGlvbiA9IGNoYXJ0XHJcblx0XHRcdC5jYW52YXNcclxuXHRcdFx0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG5cclxuXHRcdGNvbnN0IGVsV2lkdGggPSBkb2N1bWVudFxyXG5cdFx0XHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSh0aGlzLlRPT0xUSVBfU0VMRUNUT1IpWyAwIF1cclxuXHRcdFx0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXHJcblx0XHRcdC53aWR0aDtcclxuXHJcblx0XHRjb25zdCBuZWdNYXJnaW4gPSAoIHRoaXMubW9kZWwuY2FyZXRYICsgZWxXaWR0aCA+IHBvc2l0aW9uLndpZHRoICkgP1xyXG5cdFx0XHRlbFdpZHRoICsgIDIgKiB0aGlzLm1vZGVsLnhQYWRkaW5nIDogMDtcclxuXHRcdFxyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUub3BhY2l0eSA9ICcxJztcclxuXHRcdHRvb2x0aXBFbGVtZW50LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJztcclxuXHRcdHRvb2x0aXBFbGVtZW50LnN0eWxlLmxlZnQgPSBwb3NpdGlvbi5sZWZ0ICsgd2luZG93LnBhZ2VYT2Zmc2V0ICsgdGhpcy5tb2RlbC5jYXJldFggLSBuZWdNYXJnaW4gKyAncHgnO1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUudG9wID0gcG9zaXRpb24udG9wICsgd2luZG93LnBhZ2VZT2Zmc2V0ICsgdGhpcy5tb2RlbC5jYXJldFkgKyAncHgnO1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IHRoaXMubW9kZWwuX2JvZHlGb250RmFtaWx5O1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUucGFkZGluZyA9IHRoaXMubW9kZWwueVBhZGRpbmcgKyAncHggJyArIHRoaXMubW9kZWwueFBhZGRpbmcgKyAncHgnO1xyXG5cdFx0dG9vbHRpcEVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgY3JlYXRlQm9keSgpe1xyXG5cdFx0dmFyIHRvb2x0aXBFbGVtZW50ID0gdGhpcy5yb290O1xyXG5cdFx0dmFyIGNoYXJ0ID0gdGhpcy5jb21wb25lbnQ7XHJcblx0XHR2YXIgdyA9IHRoaXMuY29tcG9uZW50LnN0b3JlLnBhbmVsLndpZGdldDtcclxuXHJcblx0XHR2YXIgdGl0bGVMaW5lcyA9IHRoaXMubW9kZWwudGl0bGUgfHwgW107XHJcblx0XHR2YXIgaW5uZXJIdG1sID0gJyc7XHJcblxyXG5cdFx0dGl0bGVMaW5lcy5mb3JFYWNoKGZ1bmN0aW9uKHRpdGxlKSB7XHJcblx0XHRcdGNvbnN0IGRhdGUgPSBEYXRlLnBhcnNlKCB0aXRsZSApO1xyXG5cdFx0XHRjb25zdCB0aW1lID0gTW9tZW50LmZvcm1hdCAoIGRhdGUgKTtcclxuXHRcdFx0aW5uZXJIdG1sICs9IGA8ZGl2IGNsYXNzPVwiZ3JhcGgtdG9vbHRpcC10aW1lXCI+JHt0aW1lfTwvZGl2PmBcclxuXHRcdH0pO1xyXG5cclxuXHRcdGNvbnN0IHBhcnNlZEJvZHlMaW5lcyA9IHRoaXMuc29ydCgpO1xyXG5cclxuXHRcdHBhcnNlZEJvZHlMaW5lcy5mb3JFYWNoKCAoYm9keSwgaSkgPT4ge1xyXG5cdFx0XHRjb25zdCB7IHNlcmllc05hbWUsIHZhbHVlLCBjb2xvckZ1bmMgfSA9IGJvZHk7XHJcblxyXG5cdFx0XHRsZXQgc2VyaWVzTmFtZUVsID0gYFxyXG5cdFx0XHRcdDxkaXYgY2xhc3M9XCJncmFwaC10b29sdGlwLXNlcmllcy1uYW1lXCI+XHJcblx0XHRcdFx0XHQ8aSBjbGFzcz1cImZhIGZhLW1pbnVzXCIgc3R5bGU9XCJjb2xvcjoke2NvbG9yRnVuY307XCI+PC9pPiAke3Nlcmllc05hbWV9OlxyXG5cdFx0XHRcdDwvZGl2PmBcclxuXHJcblx0XHRcdGNvbnN0IGRzID0gY2hhcnRcclxuXHRcdFx0XHQuZGF0YVxyXG5cdFx0XHRcdC5kYXRhc2V0c1xyXG5cdFx0XHRcdC5maW5kKCB4ID0+IHgubGFiZWwgPT0gc2VyaWVzTmFtZSApO1xyXG5cclxuXHRcdFx0Y29uc3QgYXhpcyA9ICB3LmF4ZXMubGVmdFk7Ly8oIGRzLnlBeGlzSUQgPT0gJ0EnICkgP1x0dy5heGVzLmxlZnRZIDogdy5heGVzLnJpZ2h0WTtcclxuXHJcblx0XHRcdGNvbnN0IGRlY2ltYWxzID0gdy5sZWdlbmQuZGVjaW1hbHMgPyB3LmxlZ2VuZC5kZWNpbWFscyA6IDE7XHJcblxyXG5cdFx0XHRjb25zdCByZXNWYWx1ZSA9IEF4aXNVbml0SGVscGVyLmdldEZvcm1hdHRlZFZhbHVlKCB2YWx1ZSwgYXhpcy51bml0LCBkZWNpbWFscyApXHJcblxyXG5cdFx0XHRsZXQgdmFsdWVFbCA9IGA8ZGl2IGNsYXNzPVwiZ3JhcGgtdG9vbHRpcC12YWx1ZSBcIj4ke3Jlc1ZhbHVlfTwvZGl2PmA7XHJcblxyXG5cdFx0XHRsZXQgaXRlbSA9IGBcclxuXHRcdFx0XHQ8ZGl2IGNsYXNzPVwiZ3JhcGgtdG9vbHRpcC1saXN0LWl0ZW1cIj5cclxuXHRcdFx0XHRcdCR7c2VyaWVzTmFtZUVsfVxyXG5cdFx0XHRcdFx0JHt2YWx1ZUVsfVxyXG5cdFx0XHRcdDwvZGl2PmBcclxuXHJcblx0XHRcdGlubmVySHRtbCArPSBpdGVtO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0dmFyIHRhYmxlUm9vdCA9IHRvb2x0aXBFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYC4ke3RoaXMuVE9PTFRJUF9TRUxFQ1RPUn1gKTtcclxuXHRcdHRhYmxlUm9vdC5pbm5lckhUTUwgPSBpbm5lckh0bWw7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHNvcnQoKSA6IEFycmF5PGFueT57XHJcblx0XHRmdW5jdGlvbiBnZXRCb2R5KGJvZHlJdGVtKSB7XHJcblx0XHRcdHJldHVybiBib2R5SXRlbS5saW5lcztcclxuXHRcdH1cclxuXHJcblx0XHR2YXIgYm9keUxpbmVzID0gdGhpcy5tb2RlbC5ib2R5Lm1hcChnZXRCb2R5KTtcclxuXHJcblx0XHRjb25zdCBzb3J0T3JkZXIgPSB0aGlzXHJcblx0XHRcdC5jb21wb25lbnRcclxuXHRcdFx0LndpZGdldFxyXG5cdFx0XHQuZGlzcGxheVxyXG5cdFx0XHQudG9vbHRpcFNvcnRPcmRlcjtcclxuXHJcblx0XHRjb25zdCBwYXJzZWRCb2R5TGluZXMgPSBbXTtcclxuXHRcdFxyXG5cdFx0Ym9keUxpbmVzLmZvckVhY2goKGJvZHksIGkpID0+IHtcclxuXHRcdFx0dmFyIGNvbG9ycyA9IHRoaXMubW9kZWwubGFiZWxDb2xvcnNbIGkgXTtcclxuXHRcdFx0dmFyIGNvbG9yID0gQ29sb3JIZWxwZXIucGFyc2UoIGNvbG9ycy5iYWNrZ3JvdW5kQ29sb3IpO1xyXG5cdFx0XHR2YXIgY29sb3JGdW5jID0gYHJnYmEoJHtjb2xvci5yfSwke2NvbG9yLmd9LCR7Y29sb3IuYn0sMSlgXHJcblxyXG5cdFx0XHRsZXQgaW5kZXggPSBib2R5WyAwIF0ubGFzdEluZGV4T2YoICc6JyApO1xyXG5cdFx0XHRjb25zdCBzZXJpZXNOYW1lID0gYm9keVsgMCBdLnN1YnN0cmluZyggMCwgaW5kZXggKTtcclxuXHRcdFx0Y29uc3QgdmFsdWUgPSBwYXJzZUZsb2F0KHRoaXMubW9kZWwuZGF0YVBvaW50c1sgaSBdLnZhbHVlKTtcclxuXHRcdFx0cGFyc2VkQm9keUxpbmVzLnB1c2goIHtzZXJpZXNOYW1lLCB2YWx1ZSwgY29sb3JGdW5jfSApO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0c3dpdGNoKCBzb3J0T3JkZXIgKXtcclxuXHRcdFx0Y2FzZSBUb29sdGlwU29ydE9yZGVyLkluY3JlYXNpbmc6XHJcblx0XHRcdFx0cGFyc2VkQm9keUxpbmVzLnNvcnQoIChhLCBiKSA9PiBhLnZhbHVlIC0gYi52YWx1ZSk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblxyXG5cdFx0XHRjYXNlIFRvb2x0aXBTb3J0T3JkZXIuRGVjcmVhc2luZzpcclxuXHRcdFx0XHRwYXJzZWRCb2R5TGluZXMuc29ydCggKGEsIGIpID0+IGIudmFsdWUgLSBhLnZhbHVlKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gcGFyc2VkQm9keUxpbmVzO1xyXG5cdH1cclxufVxyXG5cclxuY2xhc3MgVG9vbHRpcFJlbmRlcmVye1xyXG5cclxuXHJcblxyXG5cclxufVxyXG5cclxuXHJcbiJdfQ==