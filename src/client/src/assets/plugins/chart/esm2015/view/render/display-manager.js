import { Inject, Injectable } from '@angular/core';
import { DataPointNullValueOption, PANEL_TOKEN } from '../../chart.m';
import { ColorHelper } from './color-helper';
import * as i0 from "@angular/core";
export class DisplayManager {
    constructor(panel) {
        this.panel = panel;
    }
    get display() {
        return this
            .panel
            .widget
            .display;
    }
    get options() {
        return this
            .panel
            .widget
            .component
            .control
            .chart
            .options;
    }
    setup(ds) {
        //this.setupSecondaryYAxis();					
        this.setupLines(ds);
        this.setupPoints(ds);
        this.setupNullValue(ds);
    }
    setupLines(ds) {
        const showLines = this.getShowLines(ds);
        const lineWidth = this.getLineWidth(ds);
        const fill = this.getFill(ds);
        let opacity = (fill / 10);
        ds.fill = ( /*showLines &&*/fill > 0);
        ds.backgroundColor = this.getLineColor(ds, opacity);
        opacity = (showLines && lineWidth) ? 1 : 0;
        ds.borderColor = this.getLineColor(ds, opacity);
        ds.borderWidth = lineWidth;
        ds.steppedLine = this.getStaircase(ds);
        if (this.getDashes(ds)) {
            const len = this.getDashLength(ds);
            const space = this.getDashSpace(ds);
            ds.borderDash = [len, space];
        }
        else {
            ds.borderDash = undefined;
        }
        ds.order = this.getZIndex(ds);
        ds.legend = this.getLegend(ds);
        // ds.yAxisID = ( 1 == this.getYAxis( ds ) ) ? 'A': 'B';
    }
    setupPoints(ds) {
        const showPoints = this.getShowPoints(ds);
        const opacity = showPoints ? 1 : 0;
        const color = this.getLineColor(ds, opacity);
        ds.pointBorderColor = `${color}`;
        ds.pointBackgroundColor = `${color}`;
        ds.pointRadius = showPoints ? this.getPointRadius(ds) : 0;
    }
    setupNullValue(ds) {
        switch (this.display.nullValue) {
            case DataPointNullValueOption.Connected:
                this.options.spanGaps = true;
                ds.data.forEach(p => p.y = p.isNull ? null : p.y);
                break;
            case DataPointNullValueOption.Null:
                this.options.spanGaps = false;
                ds.data.forEach(p => p.y = p.isNull ? null : p.y);
                break;
            case DataPointNullValueOption.NullAsZero:
                this.options.spanGaps = false;
                ds.data.forEach(p => p.y = p.isNull ? 0 : p.y);
                break;
        }
    }
    setupOverrides() {
        // const needSecondaryYAxis = AxesManager.needSecondaryYAxis( this.chart.widget );
        // const actualSecondaryYAxisUsers = this
        // 	.datasets
        // 	.filter( x => x.yAxisID == 'B' )
        // 	.length
        // const yAxesCount = this.chart.options.scales.yAxes.length;
        // if( 2 == yAxesCount && !needSecondaryYAxis ){
        // 	this.chart.options.scales.yAxes.splice( 1, 1 );
        // } else if( /*1 == yAxesCount && needSecondaryYAxis*/ actualSecondaryYAxisUsers != needSecondaryYAxis ){
        // 	this.chart.destroy();
        // 	this.chart.needRebuild.emit();
        // 	this.chart = undefined;
        // 	return;
        // }
        // this.datasets.forEach(x => this.setup(x));
    }
    getShowLines(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.lines) ? o.lines : this.display.showLines;
    }
    getLineWidth(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.lineWidth) ? o.lineWidth : this.display.lineWidth;
    }
    getLineColor(ds, opacity) {
        const o = this.getOverride(ds);
        const defaultColor = ColorHelper.getColorAsArgbFunc(ds, opacity);
        const useOverride = (o && undefined != o.color);
        let overrideColor;
        if (useOverride) {
            var color = ColorHelper.parse(o.color);
            overrideColor = `rgba(${color.r},${color.g},${color.b},${opacity})`;
        }
        return (useOverride) ? overrideColor : defaultColor;
    }
    getFill(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.lineFill) ? o.lineFill : this.display.fill;
    }
    getStaircase(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.staircase) ? o.staircase : this.display.staircase;
    }
    getDashes(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.dashes) ? o.dashes : false;
    }
    getDashLength(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.dashLength) ? o.dashLength : 1;
    }
    getDashSpace(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.dashSpace) ? o.dashSpace : 1;
    }
    getShowPoints(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.points) ? o.points : this.display.showPoints;
    }
    getPointRadius(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.pointRadius) ? o.pointRadius : this.display.pointRadius;
    }
    getLegend(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.legend) ? o.legend : true;
    }
    getZIndex(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.zIndex) ? o.zIndex : 0;
    }
    getYAxis(ds) {
        const o = this.getOverride(ds);
        return (o && undefined != o.yAxis) ? o.yAxis : 1;
    }
    getOverride(ds) {
        return this
            .display
            .overrides
            .find(x => x.alias && new RegExp(x.alias).test(ds.label));
    }
}
DisplayManager.ɵfac = function DisplayManager_Factory(t) { return new (t || DisplayManager)(i0.ɵɵinject(PANEL_TOKEN)); };
DisplayManager.ɵprov = i0.ɵɵdefineInjectable({ token: DisplayManager, factory: DisplayManager.ɵfac });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(DisplayManager, [{
        type: Injectable
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [PANEL_TOKEN]
            }] }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzcGxheS1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYXBwL3BsdWdpbnMvd2lkZ2V0cy9jaGFydC9zcmMvdmlldy9yZW5kZXIvZGlzcGxheS1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5ELE9BQU8sRUFBRSx3QkFBd0IsRUFBVyxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztBQUc3QyxNQUFNLE9BQU8sY0FBYztJQW1CMUIsWUFBNkMsS0FBWTtRQUFaLFVBQUssR0FBTCxLQUFLLENBQU87SUFFekQsQ0FBQztJQW5CRCxJQUFZLE9BQU87UUFDbEIsT0FBTyxJQUFJO2FBQ1QsS0FBSzthQUNMLE1BQU07YUFDTixPQUFPLENBQUM7SUFDWCxDQUFDO0lBRUQsSUFBWSxPQUFPO1FBQ2xCLE9BQU8sSUFBSTthQUNULEtBQUs7YUFDTCxNQUFNO2FBQ04sU0FBUzthQUNULE9BQU87YUFDUCxLQUFLO2FBQ0wsT0FBTyxDQUFDO0lBQ1gsQ0FBQztJQU1ELEtBQUssQ0FBQyxFQUFXO1FBQ2hCLGtDQUFrQztRQUVsQyxJQUFJLENBQUMsVUFBVSxDQUFFLEVBQUUsQ0FBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLENBQUUsRUFBRSxDQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGNBQWMsQ0FBRSxFQUFFLENBQUUsQ0FBQztJQUMzQixDQUFDO0lBRU8sVUFBVSxDQUFFLEVBQVc7UUFDOUIsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBRSxFQUFFLENBQUUsQ0FBQztRQUMxQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFFLEVBQUUsQ0FBRSxDQUFDO1FBQzFDLE1BQU0sSUFBSSxHQUFHLElB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RSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztJQUNqRixDQUFDO0lBRUQsU0FBUyxDQUFFLEVBQVc7UUFDckIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBRSxFQUFFLENBQUUsQ0FBQztRQUVqQyxPQUFPLENBQUUsQ0FBQyxJQUFJLFNBQVMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUMxRCxDQUFDO0lBRUQsYUFBYSxDQUFFLEVBQVc7UUFDekIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBRSxFQUFFLENBQUUsQ0FBQztRQUVqQyxPQUFPLENBQUUsQ0FBQyxJQUFJLFNBQVMsSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsWUFBWSxDQUFFLEVBQVc7UUFDeEIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBRSxFQUFFLENBQUUsQ0FBQztRQUVqQyxPQUFPLENBQUUsQ0FBQyxJQUFJLFNBQVMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsYUFBYSxDQUFFLEVBQVc7UUFDekIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBRSxFQUFFLENBQUUsQ0FBQztRQUVqQyxPQUFPLENBQUUsQ0FBQyxJQUFJLFNBQVMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO0lBQzVFLENBQUM7SUFFRCxjQUFjLENBQUUsRUFBVztRQUMxQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFFLEVBQUUsQ0FBRSxDQUFDO1FBRWpDLE9BQU8sQ0FBRSxDQUFDLElBQUksU0FBUyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUM7SUFDdkYsQ0FBQztJQUVELFNBQVMsQ0FBRSxFQUFXO1FBQ3JCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUUsRUFBRSxDQUFFLENBQUM7UUFFakMsT0FBTyxDQUFFLENBQUMsSUFBSSxTQUFTLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDekQsQ0FBQztJQUVELFNBQVMsQ0FBRSxFQUFXO1FBQ3JCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUUsRUFBRSxDQUFFLENBQUM7UUFFakMsT0FBTyxDQUFFLENBQUMsSUFBSSxTQUFTLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELFFBQVEsQ0FBRSxFQUFXO1FBQ3BCLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUUsRUFBRSxDQUFFLENBQUM7UUFFakMsT0FBTyxDQUFFLENBQUMsSUFBSSxTQUFTLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVELFdBQVcsQ0FBRSxFQUFXO1FBQ3ZCLE9BQU8sSUFBSTthQUNULE9BQU87YUFDUCxTQUFTO2FBQ1QsSUFBSSxDQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLE1BQU0sQ0FBRSxDQUFDLENBQUMsS0FBSyxDQUFFLENBQUMsSUFBSSxDQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUUsQ0FBRyxDQUFBO0lBQ2xFLENBQUM7OzRFQS9NVyxjQUFjLGNBbUJILFdBQVc7c0RBbkJ0QixjQUFjLFdBQWQsY0FBYztrREFBZCxjQUFjO2NBRDFCLFVBQVU7O3NCQW9CSyxNQUFNO3VCQUFFLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGFuZWwgfSBmcm9tICdjb21tb24nO1xyXG5pbXBvcnQgeyBEYXRhUG9pbnROdWxsVmFsdWVPcHRpb24sIERhdGFTZXQsIFBBTkVMX1RPS0VOIH0gZnJvbSAnLi4vLi4vY2hhcnQubSc7XHJcbmltcG9ydCB7IENvbG9ySGVscGVyIH0gZnJvbSAnLi9jb2xvci1oZWxwZXInO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGlzcGxheU1hbmFnZXIge1xyXG5cclxuXHRwcml2YXRlIGdldCBkaXNwbGF5KCkge1xyXG5cdFx0cmV0dXJuIHRoaXNcclxuXHRcdFx0LnBhbmVsXHJcblx0XHRcdC53aWRnZXRcclxuXHRcdFx0LmRpc3BsYXk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGdldCBvcHRpb25zKCl7XHJcblx0XHRyZXR1cm4gdGhpc1xyXG5cdFx0XHQucGFuZWxcclxuXHRcdFx0LndpZGdldFxyXG5cdFx0XHQuY29tcG9uZW50XHJcblx0XHRcdC5jb250cm9sXHJcblx0XHRcdC5jaGFydFxyXG5cdFx0XHQub3B0aW9ucztcclxuXHR9XHJcblxyXG5cdGNvbnN0cnVjdG9yICggQEluamVjdCggUEFORUxfVE9LRU4gKSBwcml2YXRlIHBhbmVsOiBQYW5lbCApIHtcclxuXHJcblx0fVxyXG5cclxuXHRzZXR1cChkczogRGF0YVNldCkge1xyXG5cdFx0Ly90aGlzLnNldHVwU2Vjb25kYXJ5WUF4aXMoKTtcdFx0XHRcdFx0XHJcblxyXG5cdFx0dGhpcy5zZXR1cExpbmVzKCBkcyApO1xyXG5cdFx0dGhpcy5zZXR1cFBvaW50cyggZHMgKTtcclxuXHRcdHRoaXMuc2V0dXBOdWxsVmFsdWUoIGRzICk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHNldHVwTGluZXMoIGRzOiBEYXRhU2V0ICkge1xyXG5cdFx0Y29uc3Qgc2hvd0xpbmVzID0gdGhpcy5nZXRTaG93TGluZXMoIGRzICk7XHJcblx0XHRjb25zdCBsaW5lV2lkdGggPSB0aGlzLmdldExpbmVXaWR0aCggZHMgKTtcclxuXHRcdGNvbnN0IGZpbGwgPSB0aGlzLmdldEZpbGwoIGRzICk7XHJcblxyXG5cdFx0bGV0IG9wYWNpdHkgPSAoIGZpbGwgLyAxMCk7XHJcblx0XHRkcy5maWxsID0gKC8qc2hvd0xpbmVzICYmKi8gZmlsbCA+IDApO1xyXG5cdFx0ZHMuYmFja2dyb3VuZENvbG9yID0gdGhpcy5nZXRMaW5lQ29sb3IoIGRzLCBvcGFjaXR5ICk7XHJcblxyXG5cdFx0b3BhY2l0eSA9IChzaG93TGluZXMgJiYgbGluZVdpZHRoKSA/IDEgOiAwO1xyXG5cdFx0ZHMuYm9yZGVyQ29sb3IgPSB0aGlzLmdldExpbmVDb2xvciggZHMsIG9wYWNpdHkgKTtcclxuXHRcdGRzLmJvcmRlcldpZHRoID0gbGluZVdpZHRoO1xyXG5cclxuXHRcdCBkcy5zdGVwcGVkTGluZSA9IHRoaXMuZ2V0U3RhaXJjYXNlKCBkcyApO1xyXG5cclxuXHRcdGlmKCB0aGlzLmdldERhc2hlcyggZHMgKSApe1xyXG5cdFx0XHRjb25zdCBsZW4gPSB0aGlzLmdldERhc2hMZW5ndGgoIGRzICk7XHJcblx0XHRcdGNvbnN0IHNwYWNlID0gdGhpcy5nZXREYXNoU3BhY2UoIGRzICk7XHJcblx0XHRcdGRzLmJvcmRlckRhc2ggPSBbIGxlbiwgc3BhY2UgXVxyXG5cdFx0fVxyXG5cdFx0ZWxzZXtcclxuXHRcdFx0ZHMuYm9yZGVyRGFzaCA9IHVuZGVmaW5lZDtcclxuXHRcdH1cclxuXHJcblx0XHRkcy5vcmRlciA9IHRoaXMuZ2V0WkluZGV4KCBkcyApO1xyXG5cdFx0ZHMubGVnZW5kID0gdGhpcy5nZXRMZWdlbmQoIGRzICk7XHJcblxyXG5cdFx0Ly8gZHMueUF4aXNJRCA9ICggMSA9PSB0aGlzLmdldFlBeGlzKCBkcyApICkgPyAnQSc6ICdCJztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0dXBQb2ludHMoIGRzOiBEYXRhU2V0ICkge1xyXG5cdFx0Y29uc3Qgc2hvd1BvaW50cyA9IHRoaXMuZ2V0U2hvd1BvaW50cyggZHMgKTtcclxuXHJcblx0XHRjb25zdCBvcGFjaXR5ID0gc2hvd1BvaW50cyA/IDEgOiAwXHJcblx0XHRjb25zdCBjb2xvciA9IHRoaXMuZ2V0TGluZUNvbG9yKCBkcywgb3BhY2l0eSApO1xyXG5cclxuXHRcdGRzLnBvaW50Qm9yZGVyQ29sb3IgPSBgJHtjb2xvcn1gO1xyXG5cdFx0ZHMucG9pbnRCYWNrZ3JvdW5kQ29sb3IgPSBgJHtjb2xvcn1gO1xyXG5cclxuXHRcdGRzLnBvaW50UmFkaXVzID0gc2hvd1BvaW50cyA/IHRoaXMuZ2V0UG9pbnRSYWRpdXMoIGRzICkgOiAwO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBzZXR1cE51bGxWYWx1ZSggZHM6IERhdGFTZXQgKSB7XHJcblx0XHRzd2l0Y2ggKCB0aGlzLmRpc3BsYXkubnVsbFZhbHVlKSB7XHJcblx0XHRcdGNhc2UgRGF0YVBvaW50TnVsbFZhbHVlT3B0aW9uLkNvbm5lY3RlZDpcclxuXHRcdFx0XHR0aGlzLm9wdGlvbnMuc3BhbkdhcHMgPSB0cnVlO1xyXG5cdFx0XHRcdGRzLmRhdGEuZm9yRWFjaCggcCA9PiBwLnkgPSBwLmlzTnVsbCA/IG51bGwgOiBwLnkgKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHJcblx0XHRcdGNhc2UgRGF0YVBvaW50TnVsbFZhbHVlT3B0aW9uLk51bGw6XHJcblx0XHRcdFx0dGhpcy5vcHRpb25zLnNwYW5HYXBzID0gZmFsc2U7XHJcblx0XHRcdFx0ZHMuZGF0YS5mb3JFYWNoKCBwID0+IHAueSA9IHAuaXNOdWxsID8gbnVsbCA6IHAueSApO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cclxuXHRcdFx0Y2FzZSBEYXRhUG9pbnROdWxsVmFsdWVPcHRpb24uTnVsbEFzWmVybzpcclxuXHRcdFx0XHR0aGlzLm9wdGlvbnMuc3BhbkdhcHMgPSBmYWxzZTtcclxuXHRcdFx0XHRkcy5kYXRhLmZvckVhY2goIHAgPT4gcC55ID0gcC5pc051bGwgPyAwIDogcC55ICk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHNldHVwT3ZlcnJpZGVzKCl7XHJcblx0XHQvLyBjb25zdCBuZWVkU2Vjb25kYXJ5WUF4aXMgPSBBeGVzTWFuYWdlci5uZWVkU2Vjb25kYXJ5WUF4aXMoIHRoaXMuY2hhcnQud2lkZ2V0ICk7XHJcblxyXG5cdFx0Ly8gY29uc3QgYWN0dWFsU2Vjb25kYXJ5WUF4aXNVc2VycyA9IHRoaXNcclxuXHRcdC8vIFx0LmRhdGFzZXRzXHJcblx0XHQvLyBcdC5maWx0ZXIoIHggPT4geC55QXhpc0lEID09ICdCJyApXHJcblx0XHQvLyBcdC5sZW5ndGhcclxuIFxyXG5cdFx0Ly8gY29uc3QgeUF4ZXNDb3VudCA9IHRoaXMuY2hhcnQub3B0aW9ucy5zY2FsZXMueUF4ZXMubGVuZ3RoO1xyXG5cdFx0XHJcblx0XHQvLyBpZiggMiA9PSB5QXhlc0NvdW50ICYmICFuZWVkU2Vjb25kYXJ5WUF4aXMgKXtcclxuXHRcdC8vIFx0dGhpcy5jaGFydC5vcHRpb25zLnNjYWxlcy55QXhlcy5zcGxpY2UoIDEsIDEgKTtcclxuXHRcdC8vIH0gZWxzZSBpZiggLyoxID09IHlBeGVzQ291bnQgJiYgbmVlZFNlY29uZGFyeVlBeGlzKi8gYWN0dWFsU2Vjb25kYXJ5WUF4aXNVc2VycyAhPSBuZWVkU2Vjb25kYXJ5WUF4aXMgKXtcclxuXHRcdC8vIFx0dGhpcy5jaGFydC5kZXN0cm95KCk7XHJcblx0XHQvLyBcdHRoaXMuY2hhcnQubmVlZFJlYnVpbGQuZW1pdCgpO1xyXG5cdFx0Ly8gXHR0aGlzLmNoYXJ0ID0gdW5kZWZpbmVkO1xyXG5cdFx0Ly8gXHRyZXR1cm47XHJcblx0XHQvLyB9XHJcblxyXG5cdFx0Ly8gdGhpcy5kYXRhc2V0cy5mb3JFYWNoKHggPT4gdGhpcy5zZXR1cCh4KSk7XHJcblx0fVxyXG5cclxuXHRnZXRTaG93TGluZXMoZHM6IERhdGFTZXQpOiBib29sZWFue1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby5saW5lcyApID8gby5saW5lcyA6IHRoaXMuZGlzcGxheS5zaG93TGluZXM7XHJcblx0fVxyXG5cdFxyXG5cdGdldExpbmVXaWR0aChkczogRGF0YVNldCk6IG51bWJlcntcclxuXHRcdGNvbnN0IG8gPSB0aGlzLmdldE92ZXJyaWRlKCBkcyApO1xyXG5cclxuXHRcdHJldHVybiAoIG8gJiYgdW5kZWZpbmVkICE9IG8ubGluZVdpZHRoICkgPyBvLmxpbmVXaWR0aCA6IHRoaXMuZGlzcGxheS5saW5lV2lkdGg7XHJcblx0fVxyXG5cclxuXHRnZXRMaW5lQ29sb3IoZHM6IERhdGFTZXQsIG9wYWNpdHk6IG51bWJlcikgOiBzdHJpbmd7XHJcblx0XHRjb25zdCBvID0gdGhpcy5nZXRPdmVycmlkZSggZHMgKTtcclxuXHJcblx0XHRjb25zdCBkZWZhdWx0Q29sb3IgPSBDb2xvckhlbHBlci5nZXRDb2xvckFzQXJnYkZ1bmMoZHMsIG9wYWNpdHkpXHJcblxyXG5cdFx0Y29uc3QgdXNlT3ZlcnJpZGUgPSAoIG8gJiYgdW5kZWZpbmVkICE9IG8uY29sb3IgKVxyXG5cdFx0bGV0IG92ZXJyaWRlQ29sb3I6IHN0cmluZztcclxuXHJcblx0XHRpZiggdXNlT3ZlcnJpZGUgKXtcclxuXHRcdFx0dmFyIGNvbG9yID0gQ29sb3JIZWxwZXIucGFyc2UoIG8uY29sb3IgKTtcclxuXHRcdFx0b3ZlcnJpZGVDb2xvciA9IGByZ2JhKCR7Y29sb3Iucn0sJHtjb2xvci5nfSwke2NvbG9yLmJ9LCR7b3BhY2l0eX0pYFxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiAoIHVzZU92ZXJyaWRlICkgPyBvdmVycmlkZUNvbG9yIDogZGVmYXVsdENvbG9yO1xyXG5cdH1cclxuXHJcblx0Z2V0RmlsbCggZHM6IERhdGFTZXQgKTogbnVtYmVye1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby5saW5lRmlsbCApID8gby5saW5lRmlsbCA6IHRoaXMuZGlzcGxheS5maWxsO1xyXG5cdH1cclxuXHJcblx0Z2V0U3RhaXJjYXNlKCBkczogRGF0YVNldCApOiBib29sZWFue1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby5zdGFpcmNhc2UgKSA/IG8uc3RhaXJjYXNlIDogdGhpcy5kaXNwbGF5LnN0YWlyY2FzZTtcclxuXHR9XHJcblxyXG5cdGdldERhc2hlcyggZHM6IERhdGFTZXQgKXtcclxuXHRcdGNvbnN0IG8gPSB0aGlzLmdldE92ZXJyaWRlKCBkcyApO1xyXG5cclxuXHRcdHJldHVybiAoIG8gJiYgdW5kZWZpbmVkICE9IG8uZGFzaGVzICkgPyBvLmRhc2hlcyA6IGZhbHNlO1xyXG5cdH1cclxuXHJcblx0Z2V0RGFzaExlbmd0aCggZHM6IERhdGFTZXQgKTogbnVtYmVye1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby5kYXNoTGVuZ3RoICkgPyBvLmRhc2hMZW5ndGggOiAxO1xyXG5cdH1cclxuXHJcblx0Z2V0RGFzaFNwYWNlKCBkczogRGF0YVNldCApOiBudW1iZXJ7XHJcblx0XHRjb25zdCBvID0gdGhpcy5nZXRPdmVycmlkZSggZHMgKTtcclxuXHJcblx0XHRyZXR1cm4gKCBvICYmIHVuZGVmaW5lZCAhPSBvLmRhc2hTcGFjZSApID8gby5kYXNoU3BhY2UgOiAxO1xyXG5cdH1cclxuXHJcblx0Z2V0U2hvd1BvaW50cyggZHM6IERhdGFTZXQgKSA6IGJvb2xlYW4ge1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby5wb2ludHMgKSA/IG8ucG9pbnRzIDogdGhpcy5kaXNwbGF5LnNob3dQb2ludHM7XHJcblx0fVxyXG5cclxuXHRnZXRQb2ludFJhZGl1cyggZHM6IERhdGFTZXQgKSA6IG51bWJlcntcclxuXHRcdGNvbnN0IG8gPSB0aGlzLmdldE92ZXJyaWRlKCBkcyApO1xyXG5cclxuXHRcdHJldHVybiAoIG8gJiYgdW5kZWZpbmVkICE9IG8ucG9pbnRSYWRpdXMgKSA/IG8ucG9pbnRSYWRpdXMgOiB0aGlzLmRpc3BsYXkucG9pbnRSYWRpdXM7XHJcblx0fVxyXG5cclxuXHRnZXRMZWdlbmQoIGRzOiBEYXRhU2V0ICkgOiBib29sZWFue1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby5sZWdlbmQgKSA/IG8ubGVnZW5kIDogdHJ1ZTtcclxuXHR9XHJcblxyXG5cdGdldFpJbmRleCggZHM6IERhdGFTZXQgKTogbnVtYmVye1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby56SW5kZXggKSA/IG8uekluZGV4IDogMDtcclxuXHR9XHJcblxyXG5cdGdldFlBeGlzKCBkczogRGF0YVNldCApe1xyXG5cdFx0Y29uc3QgbyA9IHRoaXMuZ2V0T3ZlcnJpZGUoIGRzICk7XHJcblxyXG5cdFx0cmV0dXJuICggbyAmJiB1bmRlZmluZWQgIT0gby55QXhpcyApID8gby55QXhpcyA6IDE7XHJcblx0fVxyXG5cclxuXHRnZXRPdmVycmlkZSggZHM6IERhdGFTZXQgKXtcclxuXHRcdHJldHVybiB0aGlzXHJcblx0XHRcdC5kaXNwbGF5XHJcblx0XHRcdC5vdmVycmlkZXNcclxuXHRcdFx0LmZpbmQoIHggPT4geC5hbGlhcyAmJiBuZXcgUmVnRXhwKCB4LmFsaWFzICkudGVzdCggZHMubGFiZWwgKSAgKVxyXG5cdH1cclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG4iXX0=